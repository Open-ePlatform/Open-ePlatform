function getHeightFromLM(e,t,a){var r=new XMLHttpRequest,n=0;r.onreadystatechange=function(){200==r.status&&(obj=JSON.parse(r.responseText),n=Math.round(100*obj.geometry.coordinates[2])/100,a(n))},configPath=OpenEMap.basePathLM+"elevation",r.open("GET",configPath+"/3006/"+e+"/"+t+"?lmuser=sundsvall",!0),r.send()}Ext.define("OpenEMap.action.Action",{extend:GeoExt.Action,constructor:function(e){var t=e.mapPanel,a=t.map;if(e.minScale||e.maxScale){e.minScale||(e.minScale=0),e.maxScale||(e.maxScale=99999999999999);var r=function(){a.getScale()>=e.maxScale||a.getScale()<=e.minScale?this.disable():this.enable()};a.events.register("zoomend",this,r)}this.callParent(arguments)},toggle:function(){}}),Ext.define("OpenEMap.action.DeleteAllFeatures",{extend:OpenEMap.action.Action,constructor:function(e){e.control=new OpenLayers.Control.Button({trigger:function(){e.mapPanel.drawLayer.removeAllFeatures()}}),e.iconCls=e.iconCls||"action-deleteallfeatures",e.tooltip=e.tooltip||"Rensa kartan från ritade objekt.",this.callParent(arguments)}}),Ext.define("OpenEMap.action.DeleteGeometry",{extend:OpenEMap.action.Action,constructor:function(e){var t=e.mapPanel,a=t.drawLayer;e.handler=function(){a.selectedFeatures.forEach(function(e){t.map.controls.forEach(function(t){"OpenLayers.Control.ModifyFeature"==t.CLASS_NAME&&t.active&&t.unselectFeature(e)}),a.destroyFeatures([e])})},e.iconCls=e.iconCls||"action-deletegeometry",e.tooltip=e.tooltip||"Ta bort ritat objekt",this.callParent(arguments)}}),Ext.define("OpenEMap.action.DeleteMeasure",{extend:OpenEMap.action.Action,constructor:function(e){e.control=new OpenLayers.Control.Button({trigger:function(){e.mapPanel.measureLayer.removeAllFeatures(),e.mapPanel.measureLayerArea.removeAllFeatures(),e.mapPanel.measureLayerLength.removeAllFeatures(),e.mapPanel.measureLayerSegments.removeAllFeatures(),e.mapPanel.map.controls.forEach(function(e){e instanceof OpenLayers.Control.DynamicMeasure&&e.deactivate()})}}),e.iconCls=e.iconCls||"action-deletemeasure",e.tooltip=e.tooltip||"Ta bort mätning(ar).",this.callParent(arguments)}}),Ext.define("OpenEMap.view.DetailReportResults",{extend:Ext.view.View,autoScroll:!0,padding:5,geometry:null,initComponent:function(){this.store=Ext.create("GeoExt.data.FeatureStore",{features:[],fields:["COUNT","CATEGORY","CLARIFICAT","DESCRIPTIO","REMARK","MAPTEXT","MAX","MIN","HEIGHT"]}),this.tpl=new Ext.XTemplate("<h3>"+this.fbet+"</h3>","<h4>"+this.aktbet+"</h4>",'<tpl for=".">','<div style="margin-bottom: 10px;" class="thumb-wrap">',"<h4>{COUNT}. {DESCRIPTIO}</h4>","<p>{REMARK}</p>","</div>","</tpl>"),this.itemSelector="div.thumb-wrap",this.callParent(arguments),this.doSearch()},doSearch:function(){var e=this.store,t=this.layer,a=this.geometry;t.destroyFeatures();var r=Ext.apply({url:"wfs",version:"1.1.0",srsName:"EPSG:3006",featureType:"EgenskapsBestammelser_yta",featurePrefix:"RIGES"}),n=new OpenLayers.Protocol.WFS(r);n.read({filter:new OpenLayers.Filter({type:OpenLayers.Filter.Spatial.INTERSECTS,value:a}),callback:function(a){var r=a.features;r&&(r.forEach(function(t){t.attributes.COUNT=e.getCount()+1,e.addFeatures([t])}),t.addFeatures(r))}})},onSelect:function(e,t,a){var r={},n=t.raw.feature,i=t.raw.layer,s=function(e){if(i.metadata.attributes[e]){var t=i.metadata.attributes[e].alias||e;r[t]=n.attributes[e]}};n&&(i.metadata&&i.metadata.attributes?Object.keys(n.attributes).forEach(s):r=n.attributes,this.mapPanel.searchLayer.selectedFeatures.forEach(function(e){this.mapPanel.selectControl.unselect(e)},this),t.raw.feature.layer&&this.mapPanel.selectControl.select(n))}}),Ext.define("OpenEMap.action.DetailReport",{extend:OpenEMap.action.Action,constructor:function(e){var t=e.mapPanel,a=t.searchLayer,r=e.map,n=OpenLayers.Class(OpenLayers.Control,{initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.onClick},this.handlerOptions)},onClick:function(e){t.setLoading(!0),a.destroyFeatures();var n=r.getLonLatFromPixel(e.xy),i=n.lon,s=n.lat,o=new OpenLayers.Geometry.Point(i,s),l=new OpenLayers.Feature.Vector(o);a.addFeatures([l]),OpenEMap.requestLM({url:"enhetsomraden?x="+i+"&y="+s,success:function(e){var n=(new OpenLayers.Format.GeoJSON).read(e.responseText);a.addFeatures(n);var i=a.getDataExtent();r.zoomToExtent(i);var s=n[0].geometry,o=n[0].attributes.name,l=Ext.apply({url:"wfs",version:"1.1.0",srsName:"EPSG:3006",featureType:"DetaljplanGallande_yta",featurePrefix:"RIGES"}),d=new OpenLayers.Protocol.WFS(l);d.read({filter:new OpenLayers.Filter({type:OpenLayers.Filter.Spatial.INTERSECTS,value:s}),callback:function(e){var r=e.features;if(r&&r.length>0){a.addFeatures(r);var n=Ext.create("OpenEMap.view.DetailReportResults",{mapPanel:t,fbet:o,aktbet:r[0].attributes.AKTBET,geometry:r[0].geometry,layer:t.drawLayer}),i=Ext.create("GeoExt.window.Popup",{title:"Rapport",anchored:!1,unpinnable:!1,draggable:!0,map:t,maximizable:!1,minimizable:!1,resizable:!0,width:300,height:400,layout:"fit",items:n,collapsible:!1});i.show()}}})},scope:this,callback:function(){t.setLoading(!1)}})}});e.control=new n({type:OpenLayers.Control.TYPE_TOGGLE}),e.iconCls=e.iconCls||"action-detailreport",e.tooltip=e.tooltip||"Detaljerad rapport",e.toggleGroup="extraTools",this.callParent(arguments)}}),Ext.define("OpenEMap.action.DrawGeometry",{extend:OpenEMap.action.Action,isText:function(e){if(e){var t="Point"===e.geometry||e.geometry instanceof OpenLayers.Geometry.Point;if(t){var a=e.attributes&&e.attributes.type&&"label"===e.attributes.type;return a}}return!1},constructor:function(e){var t=e.mapPanel,a=t.drawLayer;e.attributes=e.attributes||{},e.geometry=e.geometry||"Polygon";var r=OpenLayers.Class(OpenLayers.Control.DrawFeature,{drawFeature:function(t){var a=new OpenLayers.Feature.Vector(t,e.attributes,e.style),r=this.layer.events.triggerEvent("sketchcomplete",{feature:a});r!==!1&&(a.state=OpenLayers.State.INSERT,this.layer.addFeatures([a]),this.featureAdded(a),this.events.triggerEvent("featureadded",{feature:a}))}});e.control=new r(a,OpenLayers.Handler[e.geometry]),a.events.register("beforefeatureadded",this,function(e){this.isText(e.feature)&&(e.feature.state||"insert"===e.feature.state)&&Ext.Msg.prompt("Text","Mata in text:",function(t,r){"ok"==t&&(e.feature.attributes.label=r,e.feature.data.label=r,a.redraw())})}),e.iconCls="Polygon"===e.geometry?"action-drawpolygon":"Path"===e.geometry?"action-drawline":"Point"===e.geometry?"action-drawpoint":"action-drawgeometry",e.tooltip||(e.tooltip="Polygon"===e.geometry?"Rita område":"Path"===e.geometry?"Rita linje":"Point"===e.geometry?"Rita punkt":"Rita geometri",this.isText(e)&&(e.tooltip="Placera ut text.",e.iconCls="action-drawtext")),e.toggleGroup="extraTools",this.callParent(arguments)}}),Ext.define("OpenEMap.ObjectFactory",{toPoint:function(e){return new OpenLayers.Geometry.Point(e[0],e[1])},createR:function(e){var t=e.x,a=e.y,r=e.l,n=e.w,i=[[t,a],[t,a-r],[t+n,a-r],[t+n,a]],s=new OpenLayers.Geometry.LinearRing(i.map(this.toPoint)),o=new OpenLayers.Geometry.Polygon([s]);return o},createL:function(e){var t=e.x,a=e.y,r=e.l,n=e.w,i=e.m1,s=e.m2,o=[[t,a],[t,a-n],[t+i,a-n],[t+i,a-s],[t+r,a-s],[t+r,a]],l=new OpenLayers.Geometry.LinearRing(o.map(this.toPoint)),d=new OpenLayers.Geometry.Polygon([l]);return d},createD:function(e){var t=e.x,a=e.y,r=e.l,n=e.w,i=e.m1,s=(e.m2,(r-i)/2),o=[[t,a],[t,a-n+s],[t+s,a-n],[t+r-s,a-n],[t+r,a-n+s],[t+r,a]],l=new OpenLayers.Geometry.LinearRing(o.map(this.toPoint)),d=new OpenLayers.Geometry.Polygon([l]);return d},createO:function(e){var t=e.x,a=e.y,r=(e.l,e.w,e.m1),n=(e.m2,r/2*Math.sqrt(4+2*Math.SQRT2)),i=new OpenLayers.Geometry.Point(t+n,a-n),s=OpenLayers.Geometry.Polygon.createRegularPolygon(i,n,8);return s},figurHooks:function(e){var t=e.geometry.move;e.geometry.move=function(a,r){e.attributes.config.x+=a,e.attributes.config.y+=r,t.apply(e.geometry,arguments)};var a=e.geometry.rotate;e.geometry.rotate=function(t,r){e.attributes.config.angle+=t,a.apply(e.geometry,arguments)}},create:function(e,t,a){var r;r="R"==e.type?this.createR(e):"L"==e.type?this.createL(e):"D"==e.type?this.createD(e):this.createO(e);var n=r.getCentroid(),i=new OpenLayers.Geometry.Point(n.x,n.y);r.rotate(e.angle,i);var s=new OpenLayers.Feature.Vector(r,t,a);return this.figurHooks(s),s.attributes.config=e,s}}),Ext.define("OpenEMap.view.ObjectConfig",{extend:Ext.form.Panel,statics:{config:{type:"R",w:10,l:10,m1:2,m2:2,angle:0}},fieldDefaults:{labelWidth:60},autoHeight:!0,width:400,border:!1,selectedFeature:void 0,layer:void 0,factory:void 0,hidden:!0,defaults:{border:!1},typeLabel:"Type",widthLabel:"Width",lengthLabel:"Length",m1Label:"M1",m2Label:"M2",angleLabel:"Angle",initComponent:function(){this.layer=this.mapPanel.drawLayer,this.factory=Ext.create("OpenEMap.ObjectFactory");var e={xtype:"radiogroup",vertical:!0,fieldLabel:this.typeLabel,itemId:"type",hidden:!0,items:[{boxLabel:'<div class="objectconfig-radio-r"></div>',name:"rb",inputValue:"R",checked:!0},{boxLabel:'<div class="objectconfig-radio-l"></div>',name:"rb",enabled:!1,inputValue:"L"},{boxLabel:'<div class="objectconfig-radio-d"></div>',name:"rb",enabled:!1,inputValue:"D"},{boxLabel:'<div class="objectconfig-radio-o"></div>',name:"rb",enabled:!1,inputValue:"O"}],listeners:{change:function(e,t){this.config.type=t.rb,this.updateHelpImage(this.config.type),this.setFormItemVisibility(this.config.type),this.createObject()},scope:this}},t=[];t.push(e),t=t.concat([{xtype:"numberfield",fieldLabel:this.widthLabel,itemId:"w",minValue:0,listeners:{change:function(e,t){this.config.w=t,this.createObject()},scope:this}},{xtype:"numberfield",fieldLabel:this.lengthLabel,itemId:"l",minValue:0,listeners:{change:function(e,t){this.config.l=t,this.createObject()},scope:this}},{xtype:"numberfield",fieldLabel:this.m1Label,itemId:"m1",minValue:0,listeners:{change:function(e,t){this.config.m1=t,this.createObject()},scope:this}},{xtype:"numberfield",fieldLabel:this.m2Label,itemId:"m2",minValue:0,listeners:{change:function(e,t){this.config.m2=t,this.createObject()},scope:this}},{xtype:"numberfield",itemId:"angle",fieldLabel:this.angleLabel,value:0,listeners:{change:function(e,t){this.config.angle=t,this.createObject()},scope:this}}]),this.attributeFields=Ext.create("Ext.container.Container",{title:"Attributes"}),t.push(this.attributeFields),this.items=[{layout:"column",defaults:{border:!1},padding:5,items:[{width:180,layout:"form",items:t},{columnWidth:1,padding:5,items:{itemId:"objectimage",border:!1,height:200}}]}],this.layer.events.register("featuremodified",this,this.onFeaturemodified),this.layer.events.register("beforefeatureselected",this,this.onBeforefeatureselected),this.layer.events.register("featureunselected",this,this.onFeatureunselected),this.callParent(arguments)},setConfig:function(e){return void 0===e?(this.config=Ext.clone(OpenEMap.view.ObjectConfig.config),this.down("#type").show()):e.type?(this.config=Ext.clone(e),Ext.applyIf(this.config,OpenEMap.view.ObjectConfig.config),this.down("#type").hide()):(this.config=Ext.clone(e),Ext.applyIf(this.config,OpenEMap.view.ObjectConfig.config),this.down("#type").show()),this.setFormValues(),this.show(),this.config},setFormValues:function(){this.config?(this.down("#type").setValue({rb:this.config.type}),this.updateHelpImage(this.config.type),this.down("#w").setRawValue(this.config.w),this.down("#l").setRawValue(this.config.l),this.down("#m1").setRawValue(this.config.m1),this.down("#m2").setRawValue(this.config.m2),this.down("#angle").setRawValue(this.config.angle),this.setFormItemVisibility(this.config.type),this.down("#angle").show()):(this.down("#type").hide(),this.down("#w").hide(),this.down("#l").hide(),this.down("#m1").hide(),this.down("#m2").hide(),this.down("#angle").hide(),this.down("#objectimage").hide()),this.attributeFields.removeAll(),this.selectedFeature&&Object.keys(this.selectedFeature.attributes).forEach(function(e){this.createAttributeField(this.selectedFeature,e)},this),this.doLayout()},createAttributeField:function(e,t){if("config"!=t&&"metadata"!=t){var a=e.attributes.metadata;if(!(a&&a[t]&&a[t].hidden)){var r=e.attributes[t];this.attributeFields.add({xtype:"textfield",fieldLabel:t,value:r,listeners:{change:function(e,a){this.selectedFeature.attributes[t]=a,this.layer.drawFeature(this.selectedFeature)},scope:this}})}}},setFormItemVisibility:function(e){"R"==e?(this.down("#w").show(),this.down("#l").show(),this.down("#m1").hide(),this.down("#m2").hide()):"L"==e?(this.down("#w").show(),this.down("#l").show(),this.down("#m1").show(),this.down("#m2").show()):"D"==e?(this.down("#w").show(),this.down("#l").show(),this.down("#m1").show(),this.down("#m2").hide()):"O"==e&&(this.down("#w").hide(),this.down("#l").hide(),this.down("#m1").show(),this.down("#m2").hide())},onFeaturemodified:function(e){var t=e.feature;config=t.attributes.config,config&&this.down("#angle").setRawValue(config.angle)},onBeforefeatureselected:function(e){var t=e.feature;this.selectedFeature=t,this.config=t.attributes.config;var a=this.gui.activeAction;a&&a.control instanceof OpenLayers.Control.ModifyFeature&&(this.config&&a.control._mode&OpenLayers.Control.ModifyFeature.RESHAPE?a.control.mode=a.control._mode^OpenLayers.Control.ModifyFeature.RESHAPE:a.control.mode=a.control._mode,a.control.resetVertices()),this.show(),this.setFormValues()},onFeatureunselected:function(e){0===this.layer.selectedFeatures.length&&this.hide(),this.selectedFeature=void 0},createObject:function(e,t,a){if(this.selectedFeature&&this.selectedFeature.attributes.config){var r=this.factory.create(this.config,a).geometry;this.selectedFeature.geometry.removeComponent(this.selectedFeature.geometry.components[0]),this.selectedFeature.geometry.addComponent(r.components[0]),this.selectedFeature.modified=!0,this.selectedFeature.geometry.calculateBounds(),this.mapPanel.map.controls.forEach(function(e){"OpenLayers.Control.ModifyFeature"==e.CLASS_NAME&&e.active&&e.resetVertices()}),this.layer.drawFeature(this.selectedFeature),this.layer.events.triggerEvent("featuremodified",{feature:this.selectedFeature})}},updateHelpImage:function(e){var t="figur-"+e+"-help.png";this.down("#objectimage").show(),this.down("#objectimage").update('<img src="'+OpenEMap.basePathImages+t+'"></img>')}}),Ext.define("OpenEMap.action.DrawObject",{extend:OpenEMap.action.Action,constructor:function(e){this.mapPanel=e.mapPanel,this.layer=this.mapPanel.drawLayer,this.style=e.style,this.attributes=e.attributes,this.objectConfig=e.objectConfig,this.objectConfigView=e.objectConfigView,this.factory=Ext.create("OpenEMap.ObjectFactory"),this.attributes=this.attributes||{};var t=OpenLayers.Class(OpenLayers.Control,{initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.onClick},this.handlerOptions)},onClick:Ext.bind(this.onClick,this)});e.control=new t({type:OpenLayers.Control.TYPE_TOGGLE}),e.iconCls=e.iconCls||"action-drawobject",e.tooltip=e.tooltip||"Rita fördefinierad form.",e.toggleGroup="extraTools",this.callParent(arguments)},onClick:function(e){var t=this.mapPanel.map.getLonLatFromPixel(e.xy),a=this.objectConfigView?this.objectConfigView.config:OpenEMap.view.ObjectConfig.config;a=Ext.clone(a),a.x=t.lon,a.y=t.lat;var r=this.factory.create(a,this.attributes,this.style);this.mapPanel.unselectAll(),this.layer.addFeatures([r]),this.mapPanel.selectControl.select(r)},toggle:function(e){e&&this.objectConfigView.setConfig(this.objectConfig)}}),Ext.define("OpenEMap.action.FullExtent",{extend:OpenEMap.action.Action,constructor:function(e){e.control=new OpenLayers.Control.ZoomToMaxExtent,e.iconCls=e.iconCls||"action-fullextent",e.tooltip=e.tooltip||"Zooma till full utberedning",this.callParent(arguments)}}),Ext.define("OpenEMap.view.IdentifyResults",{extend:Ext.panel.Panel,autoScroll:!0,layout:{type:"vbox",pack:"start",align:"stretch",resizable:!0},initComponent:function(){var e=Ext.create("Ext.data.TreeStore",{root:{expanded:!0}});this.root=e.getRootNode();var t=Ext.create("Ext.grid.property.Grid",{flex:2,autoScroll:!0,title:"Egenskaper",collapsible:!0,collapsed:!1,xtype:"propertygrid",stripeRows:!0,clicksToEdit:100});this.items=[{xtype:"treepanel",flex:1,rootVisible:!1,store:e,minHeight:200,listeners:{select:this.onSelect,scope:this}},t],this.callParent(arguments)},onSelect:function(e,t,a){var r={},n=t.raw.feature,i=t.raw.layer,s=function(e){if(i.metadata.attributes[e]){var t=i.metadata.attributes[e].alias||e;r[t]=n.attributes[e]}};n&&(i.metadata&&i.metadata.attributes?Object.keys(n.attributes).forEach(s):r=n.attributes,this.mapPanel.searchLayer.selectedFeatures.forEach(function(e){this.mapPanel.selectControl.unselect(e)},this),t.raw.feature.layer&&this.mapPanel.selectControl.select(n)),r=Ext.clone(r);var o=Ext.clone(r);Object.keys(r).forEach(function(e){var t=o[e];t=t?t:"",t.match("http://")||t.match("//")||t.match("https://")?(r[e]='<a href="'+t+'" target="_blank">Länk</a>',o[e]={renderer:function(e){return e},editor:Ext.create("Ext.form.DisplayField")}):o[e]={editor:Ext.create("Ext.form.DisplayField")}}),this.down("propertygrid").setSource(r,o)},addResult:function(e,t){var a=this.root.appendChild({text:t.name,leaf:!1,expanded:!0}),r=function(e,t){var a="";if(t.metadata&&t.metadata.attributes){var r=[];for(var n in t.metadata.attributes)t.metadata.attributes[n].mainAttribute&&r.push(n);for(n in e.attributes)for(var i in r)n===r[i]&&(a+=e.attributes[n]+" ")}return""===a&&(a=e.attributes[Object.keys(e.attributes)[0]]),a.trim(),a},n=function(e){a.appendChild({text:r(e,t),leaf:!0,feature:e,layer:t})};e.forEach(n)}}),Ext.define("OpenEMap.action.Identify",{extend:OpenEMap.action.Action,popup:null,constructor:function(e){var t=this,a=e.mapPanel,r=a.searchLayer,n=e.map,i=(e.layers,e.client);null===e.useRegisterenhet&&(e.useRegisterenhet=!0),e.tolerance=e.tolerance||3,null===e.onlyVisibleLayers&&(e.onlyVisibleLayers=!0);var s=OpenLayers.Class(OpenLayers.Control,{initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.onClick},this.handlerOptions)},onClick:function(s){a.setLoading(!0),r.destroyFeatures();var o=n.getLonLatFromPixel(s.xy),l=o.lon,d=o.lat,c={},p={};p.x=s.xy.x+e.tolerance,c.x=s.xy.x-e.tolerance,p.y=s.xy.y+e.tolerance,c.y=s.xy.y-e.tolerance;var u=n.getLonLatFromPixel(c),h=n.getLonLatFromPixel(p),y=new OpenLayers.Geometry.Point(l,d),m=new OpenLayers.Bounds;m.extend(u),m.extend(h);var g=new OpenLayers.Feature.Vector(y);r.addFeatures([g]);var f=Ext.create("OpenEMap.view.IdentifyResults",{mapPanel:a}),x=t.getPopup({mapPanel:a,location:g,items:f});x.show(),e.useRegisterenhet&&OpenEMap.requestLM({url:"registerenheter?x="+l+"&y="+d,success:function(e){var t=Ext.decode(e.responseText),a=new OpenLayers.Feature.Vector(y,{name:t.name});f.addResult([a],{name:"Fastigheter"})},failure:function(e){Ext.Msg.alert("Fel i fastighetstjänsten","Kontakta systemadministratör<br>Felkod: "+e.status+" "+e.statusText)}});var v=Ext.create("OpenEMap.config.Parser"),L=i.getConfig(!0).layers;L=v.extractPlainLayers(L);var b=v.extractClickableLayers(L);e.onlyVisibleLayers&&(b=v.extractVisibleLayers(b)),OpenLayers.ProxyHost=OpenEMap.basePathProxy;var E=v.extractWFS(b),w=function(e){e.wfs.url=e.wfs.url;var t=Ext.apply({version:"1.1.0",srsName:n.projection},e.wfs),a=new OpenLayers.Protocol.WFS(t);a.read({filter:new OpenLayers.Filter({type:OpenLayers.Filter.Spatial.BBOX,value:m}),callback:function(t){var a=t.features;a&&a.length>0&&(f.addResult(a,e),r.addFeatures(a))}})};E.forEach(w);var O=v.extractWMS(v.extractNoWFS(b)),C=function(e){var t=function(t){var a=t.features;a&&a.length>0&&(f.addResult(a,e),r.addFeatures(a))},a={url:e.layer.url,layers:[e.layer],infoFormat:"application/vnd.ogc.gml",clickCallback:t},i=new OpenLayers.Control.WMSGetFeatureInfo(a);i.setMap(n),i.events.register("getfeatureinfo",i,t),i.getInfoForClick(s,{proxy:OpenEMap.basePathProxy})};O.forEach(C),a.setLoading(!1)}});e.control=new s({type:OpenLayers.Control.TYPE_TOGGLE}),e.iconCls=e.iconCls||"action-identify",e.tooltip=e.tooltip||"Identifiera",e.toggleGroup="extraTools",this.callParent(arguments)},getPopup:function(e){var t=400,a=300;return this.popup&&(t=this.popup.height,a=this.popup.width,this.popup.destroy()),this.popup=Ext.create("GeoExt.window.Popup",{title:"Sökresultat",location:e.feature,anchored:!1,unpinnable:!1,draggable:!0,map:e.mapPanel,maximizable:!1,minimizable:!1,resizable:!0,width:a,height:t,layout:"fit",items:e.items,collapsible:!1,x:200,y:100,listeners:{close:function(){e.mapPanel.searchLayer.removeAllFeatures()}}}),this.popup}}),Ext.define("OpenEMap.action.MeasureArea",{extend:OpenEMap.action.Action,constructor:function(e){var t=e.mapPanel;null===e.accuracy&&(e.accuracy=2),e.control=new OpenLayers.Control.DynamicMeasure(OpenLayers.Handler.Polygon,{mapPanel:t,accuracy:e.accuracy}),e.iconCls=e.iconCls||"action-measurearea",e.tooltip=e.tooltip||"Mät area",e.toggleGroup="extraTools",this.callParent(arguments)}}),Ext.define("OpenEMap.action.MeasureLine",{extend:OpenEMap.action.Action,constructor:function(e){var t=e.mapPanel;null===e.accuracy&&(e.accuracy=2),e.control=new OpenLayers.Control.DynamicMeasure(OpenLayers.Handler.Path,{maxSegments:null,accuracy:e.accuracy,mapPanel:t}),e.iconCls=e.iconCls||"action-measureline",e.tooltip=e.tooltip||"Mät sträcka",e.toggleGroup="extraTools",this.callParent(arguments)}}),Ext.define("OpenEMap.action.MetadataInfoColumn",{extend:Ext.grid.column.Action,requrires:["Ext.tip.ToolTip","OpenEMap.data.DataHandler","OpenEMap.view.MetadataWindow"],text:"",width:22,menuDisabled:!0,align:"center",iconCls:"action-identify",initComponent:function(e){var t=this;this.tip=Ext.create("Ext.tip.ToolTip",{trackMouse:!0}),this.listeners={mouseover:function(e,a,r,n,i,s,o){t.tip.setTarget(i.target),t.dataHandler&&t.dataHandler.getMetadataAbstract(t.getUUIDFromMetadataUrl(s.get("urlToMetadata")),function(e){e["abstract"]&&t.updateTooltip(e["abstract"])})},mouseout:function(){t.tip.update(null),t.tip.hide()},click:function(e,a,r,n,i,s){t.metadataWindow&&(t.tip.update(null),t.metadataWindow.showMetadata(t.getUUIDFromMetadataUrl(s.get("urlToMetadata"))))}},this.callParent(arguments)},updateTooltip:function(e){e&&(this.tip.update(e.substr(0,180)+"..."),this.tip.show())},getUUIDFromMetadataUrl:function(e){if(e){var t=e.indexOf("id=");if(t>0)return e.substr(t+3,36)}return e}}),Ext.define("OpenEMap.action.ModifyGeometry",{extend:OpenEMap.action.Action,constructor:function(e){var t=e.mapPanel,a=t.drawLayer;void 0===e.drag&&(e.drag=!0),void 0===e.rotate&&(e.rotate=!0),void 0===e.reshape&&(e.reshape=!0);var r=0;e.drag&&(r|=OpenLayers.Control.ModifyFeature.DRAG),e.rotate&&(r|=OpenLayers.Control.ModifyFeature.ROTATE),e.resize&&(r|=OpenLayers.Control.ModifyFeature.RESIZE),e.reshape&&(r|=OpenLayers.Control.ModifyFeature.RESHAPE);var n=Ext.apply({mode:r},e.options);e.control=new OpenLayers.Control.ModifyFeature(a,n),e.control._mode=e.control.mode,e.iconCls=e.iconCls||"action-modifygeometry",e.tooltip=e.tooltip||"ändra ritat objekt",e.toggleGroup="extraTools",this.callParent(arguments)}}),Ext.define("OpenEMap.action.ModifyText",{extend:OpenEMap.action.Action,constructor:function(e){var t=(e.mapPanel,e.mapPanel.drawLayer);e.attributes=e.attributes||{},e.control=e.mapPanel.selectControl,e.control.events.register("deactivate",this,function(){console.log("deactivate")}),e.control.events.register("activate",this,function(){var e=this;t.events.register("featureselected",e,function(e){Ext.Msg.prompt("Text","Mata in text:",function(a,r){"ok"==a&&(e.feature.attributes.label=r,e.feature.data.label=r,t.redraw())})})}),e.control.events.register("deactivate",this,function(){t.events.unregister("featureselected")}),e.iconCls=e.iconCls||"action-selectgeometry",e.tooltip=e.tooltip||"ändra text",e.toggleGroup="extraTools",this.callParent(arguments)}}),Ext.define("OpenEMap.action.Permalink",{extend:OpenEMap.action.Action,constructor:function(e){this.client=e.client,e.control=e.control=new OpenLayers.Control.Button({trigger:this.onClick.bind(this)}),e.iconCls=e.iconCls||"action-permalink",e.tooltip=e.tooltip||"Skapa länk till kartan",this.callParent(arguments)},onClick:function(){this.generate()},generate:function(){var e=function(e){var t=Ext.decode(e.responseText);this.createWindow(t)};Ext.Ajax.request({url:OpenEMap.wsUrls.permalinks,method:"POST",jsonData:this.client.getPermalinkdata(),success:e.bind(this)})},createWindow:function(e){var t=document.location.protocol+"//"+document.location.host+document.location.pathname+"?permalink="+e,a='<a href="'+t+'" target="_blank">'+t+"</a>";return this.w?(this.w.isHidden()&&this.w.show(),void this.w.items.getAt(0).getComponent("permalink").update(a)):(this.w=Ext.create("Ext.Window",{title:"Permalink",layout:"fit",xtype:"form",width:400,bodyPadding:5,bodyStyle:{border:"0px"},plain:!0,border:!1,closeAction:"hide",items:{layout:"anchor",border:!1,items:{xtype:"label",name:"permalink",itemId:"permalink",readOnly:!0,border:!1,anchor:"100%",html:a}},bbar:["->",{text:"Uppdatera",handler:this.onClick.bind(this)}]}),void this.w.show())}}),Ext.define("OpenEMap.view.PopupResults",{extend:GeoExt.window.Popup,autoScroll:!0,layout:{type:"vbox",pack:"start",align:"stretch"},popup:null,constructor:function(e){return this.popup&&this.popup.destroy(),this.popup=Ext.create("GeoExt.window.Popup",{ancCls:"oep-popup-anc",popupCls:"oep-popup",bodyCls:"oep-popup-body",anchored:!0,anchorPosition:"bottom-left",animCollapse:!0,collapsible:!1,draggable:!1,feature:e.feature,html:e.popupText,icon:e.icon,layout:"fit",location:e.location,map:e.mapPanel,maxWidth:300,maximizable:!1,minimizable:!1,resizable:!1,title:e.title,unpinnable:!1,listeners:{beforeclose:function(){this&&this.destroy(),this.feature.renderIntent="default",this.feature.layer.drawFeature(this.feature),map.events.triggerEvent("popupfeatureunselected",{layer:this.feature.layer,featureid:this.feature.attributes[this.feature.layer.idAttribute]})}}}),this.popup}}),Ext.define("OpenEMap.action.Popup",{extend:OpenEMap.action.Action,popup:null,map:null,constructor:function(e){map=e.map;var t=e.mapPanel,a=e.layers;e.popup=null,e.tolerance=e.tolerance||3,(void 0===e.showOnlyFirstHit||null===e.showOnlyFirstHit)&&(e.showOnlyFirstHit=!0);var r=OpenLayers.Class(OpenLayers.Control,{initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.onClick},this.handlerOptions)},onClick:function(r){var n=map.getLonLatFromPixel(r.xy);a=map.layers;var i=n.lon,s=n.lat,o=new OpenLayers.Geometry.Point(i,s),l=new OpenLayers.Feature.Vector(o),d={},c={};c.x=r.xy.x+e.tolerance,d.x=r.xy.x-e.tolerance,c.y=r.xy.y+e.tolerance,d.y=r.xy.y-e.tolerance;var p=map.getLonLatFromPixel(d),u=map.getLonLatFromPixel(c),h=new OpenLayers.Bounds;h.extend(p),h.extend(u);for(var y=Ext.create("OpenEMap.config.Parser"),m=y.extractPopupLayers(a),g=!1,f=function(a){a.popup&&(a.popup.forEach(function(e){e.destroy(),e=null}),a.popup=[]),a.features.forEach(function(e){e.renderIntent="default",e.layer.drawFeature(e),map.events.triggerEvent("popupfeatureunselected",{layer:a,featureid:e.attributes[a.idAttribute]})});for(var r=function(e){if(e.geometry.intersects(h.toGeometry())){if("undefined"!=typeof a.popupTextAttribute&&null!==a.popupTextAttribute){var r=a.popupTextPrefix+e.attributes[a.popupTextAttribute]+a.popupTextSuffix,n="";a.popupTitleAttribute&&(n=e.attributes[a.popupTitleAttribute]),1==e.geometry.getVertices().length&&(l=e.clone());var i=new OpenEMap.view.PopupResults({mapPanel:t,location:l,popupText:r,feature:e,title:n});i.show(),a.popup.push(i)}return e.renderIntent="select",e.layer.drawFeature(e),map.events.triggerEvent("popupfeatureselected",{layer:a,featureid:e.attributes[a.idAttribute]}),!0}return!1},n=0,i=!1;n<a.features.length&&(!i||!e.showOnlyFirstHit);)i=r(a.features[n]),n++;return g},x=0;x<m.length&&(!g||!e.showOnlyFirstHit);)g=f(m[x]),x++}});e.control=new r({type:OpenLayers.Control.TYPE_TOGGLE}),e.iconCls=e.iconCls||"action-popup",e.tooltip=e.tooltip||"Popup",e.toggleGroup="extraTools",this.callParent(arguments)},destroy:function(){this.popup&&this.popup.destroy(),this.destroyPopupLayers()}}),Ext.define("OpenEMap.action.Print",{extend:OpenEMap.action.Action,require:"GeoExt.plugins.PrintExtent",constructor:function(e){var t=e.mapPanel,a=t.plugins[0],r=a.printProvider;r.customParams={attribution:e.mapPanel.config.attribution.trim(),mapTitle:""};var n=null,i=null,s=function(){var e=n.down("#scale");e.select(i.scale)},o=function(){n&&n.setLoading(!1)},l=function(e,t){n&&n.setLoading(!1),Ext.Msg.show({title:"Felmeddelande",msg:"Print failed.\n\n"+t.responseText,icon:Ext.Msg.ERROR})},d=function(){r.un("beforedownload",o),r.on("printexception",l),a.control.events.unregister("transformcomplete",null,s),a.removePage(i),a.hide(),n=null},c=function(){d(),u.deactivate()};e.iconCls=e.iconCls||"action-print",e.tooltip=e.tooltip||"Skriv ut",e.toggleGroup="extraTools";var p=OpenLayers.Class(OpenLayers.Control,{initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,arguments)},type:OpenLayers.Control.TYPE_TOGGLE,activate:function(){if(!n){a.hide(),a.show(),i=a.addPage(),r.dpis.data.items.forEach(function(e){var t=!1;"72"===e.data.name?(t=!0,e.data.name="Låg ("+e.data.name+" dpi)"):"150"===e.data.name?(t=!0,e.data.name="Medel ("+e.data.name+" dpi)"):"300"===e.data.name&&(t=!0,e.data.name="Hög ("+e.data.name+" dpi)")}),r.layouts.data.items.forEach(function(e){/landscape$/.test(e.data.name)?e.data.displayName=e.data.name.replace("landscape","liggande"):/portrait$/.test(e.data.name)&&(e.data.displayName=e.data.name.replace("portrait","stående"))}),n=new Ext.Window({autoHeight:!0,width:290,resizable:!1,layout:"fit",bodyPadding:"5 5 0",title:"Utskriftsinställningar",listeners:{close:c},items:[{xtype:"form",layout:"anchor",defaults:{anchor:"100%"},fieldDefaults:{labelWidth:120},items:[{xtype:"textfield",fieldLabel:"Rubrik",valueField:"mapTitle",itemId:"mapTitle",queryMode:"local",value:r.customParams.mapTitle,listeners:{change:function(e){r.customParams.mapTitle=e.value}}},{xtype:"combo",fieldLabel:"Pappersformat",store:r.layouts,displayField:"displayName",valueField:"name",itemId:"printLayouts",queryMode:"local",value:r.layouts.getAt(0).get("name"),listeners:{select:function(e,t,a){var n=t[0];r.setLayout(n)}}},{xtype:"combo",fieldLabel:"Kvalité",store:r.dpis,displayField:"name",valueField:"value",queryMode:"local",value:r.dpis.first().get("value"),listeners:{select:function(e,t,a){var n=t[0];r.setDpi(n)}}},{xtype:"combo",fieldLabel:"Skala",store:r.scales,displayField:"name",valueField:"value",queryMode:"local",itemId:"scale",value:r.scales.first().get("value"),listeners:{select:function(e,t,a){var r=t[0];i.setScale(r,"m")}}}]}],bbar:["->",{text:"Skriv ut",handler:function(){n.setLoading(!0),a.print()}}]}),n.show();var e=n.down("#scale");e.select(i.scale);var t=6,d=n.down("#printLayouts");d.select(d.store.data.get(t));var p=d.store.data.items[t];r.setLayout(p),a.control.events.register("transformcomplete",null,s),a.control.events.register("transformcomplete",null,s),r.on("beforedownload",o),r.on("printexception",l),OpenLayers.Control.prototype.activate.apply(this,arguments)}},deactivate:function(){n&&n.close(),OpenLayers.Control.prototype.deactivate.apply(this,arguments)}}),u=new p({type:OpenLayers.Control.TYPE_TOGGLE});e.control=u,this.callParent(arguments)}}),Ext.define("OpenEMap.action.SelectGeometry",{extend:OpenEMap.action.Action,constructor:function(e){var t=e.mapPanel;e.control=t.selectControl,e.iconCls=e.iconCls||"action-selectgeometry",e.tooltip=e.tooltip||"Välj ritat objekt",e.toggleGroup="extraTools",this.callParent(arguments)}}),Ext.define("OpenEMap.action.Altitude",{extend:OpenEMap.action.Action,constructor:function(e){function t(e){s=new GeoExt.Popup({title:"Höjd",location:e,width:200,html:i,maximizable:!0,collapsible:!0,listeners:{close:function(){r.removeAllFeatures()}}}),s.show()}var a=e.mapPanel,r=new OpenLayers.Layer.Vector("Altitude"),n=e.map,i="";
n.addLayer(r);var s=null;null===e.useRegisterenhet&&(e.useRegisterenhet=!0),e.tolerance=e.tolerance||3,null===e.onlyVisibleLayers&&(e.onlyVisibleLayers=!0);var o=OpenLayers.Class(OpenLayers.Control,{initialize:function(e){OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.onClick},this.handlerOptions)},onClick:function(o){a.setLoading(!0),r.destroyFeatures(),s&&s.hide();var l=n.getLonLatFromPixel(o.xy),d=l.lon,c=l.lat;getHeightFromLM(d,c,function(s){i="Höjd: "+s+"<br>E: "+d+" <br>N: "+c;var l={},p={};p.x=o.xy.x+e.tolerance,l.x=o.xy.x-e.tolerance,p.y=o.xy.y+e.tolerance,l.y=o.xy.y-e.tolerance;var u=n.getLonLatFromPixel(l),h=n.getLonLatFromPixel(p),y=new OpenLayers.Geometry.Point(d,c),m=new OpenLayers.Bounds;m.extend(u),m.extend(h);var g=new OpenLayers.Feature.Vector(y);r.addFeatures([g]),t(g),a.setLoading(!1)})}});r.events.on({featureselected:function(e){t(e.feature)}}),e.control=new o({type:OpenLayers.Control.TYPE_TOGGLE}),e.iconCls=e.iconCls||"action-identify",e.tooltip=e.tooltip||"Höjdmätning",e.toggleGroup="extraTools",this.callParent(arguments)}}),Ext.define("OpenEMap.view.BaseLayers",{extend:Ext.toolbar.Toolbar,border:!1,cls:"oep-map-tools",constructor:function(e){var t=e.mapPanel,a=t.map,r=t.map.layers.filter(function(e){return e.isBaseLayer}),n=function(e){var t;e==r[r.length-1]&&(t="oep-tools-last");var n=Ext.create("Ext.Button",{text:e.name,toggleGroup:"baseLayers",allowDepress:!1,layer:e,pressed:e.visibility,cls:t,listeners:{toggle:function(t,r,n){r&&a.setBaseLayer(e)}}});return n};this.items=r.map(n),a.events.register("changebaselayer",this,this.onChangeBaseLayer),this.callParent(arguments)},onChangeBaseLayer:function(e){this.items.each(function(t){t.toggle(t.layer==e.layer,!0)})}}),Ext.define("OpenEMap.view.Map",{extend:GeoExt.panel.Map,require:"GeoExt.plugins.PrintExtent",border:!1,anchor:"100% 100%",constructor:function(e){this.initDefaultLayers(e.config);var t=Ext.create("GeoExt.data.MapfishPrintProvider",{url:OpenEMap.basePathMapFish,autoLoad:!0,timeout:6e4,listeners:{encodelayer:function(e,t,a){a&&a.baseURL&&(a.baseURL=a.baseURL.replace("gwc/service/",""))}}}),a=Ext.create("GeoExt.plugins.PrintExtent",{printProvider:t});this.encode=function(e){var r=a.addPage();if(e){var n=t.layouts.findRecord("name",e);t.setLayout(n)}var i=t.encode(a.map,a.pages);return a.removePage(r),i},t.encode=function(e,t,a){if(e instanceof GeoExt.MapPanel&&(e=e.map),t=t instanceof Array?t:[t],a=a||{},this.fireEvent("beforeprint",this,e,t,a)!==!1){var r=Ext.apply({units:e.getUnits(),srs:e.baseLayer.projection.getCode(),layout:this.layout.get("name"),dpi:this.dpi.get("value")},this.customParams),n=t[0].feature.layer,i=[],s=e.layers.concat();Ext.Array.remove(s,e.baseLayer),Ext.Array.insert(s,0,[e.baseLayer]),Ext.each(s,function(e){if(e!==n&&e.getVisibility()===!0){var t=this.encodeLayer(e);t&&i.push(t)}},this),r.layers=i;var o=[];if(Ext.each(t,function(e){o.push(Ext.apply({center:[e.center.lon,e.center.lat],scale:e.scale.get("value"),rotation:e.rotation},e.customParams))},this),r.pages=o,a.overview){var l=[];Ext.each(a.overview.layers,function(e){var t=this.encodeLayer(e);t&&l.push(t)},this),r.overviewLayers=l}if(a.legend&&this.fireEvent("beforeencodelegend",this,r,a.legend)){var d=a.legend,c=d.rendered;c||(d=d.cloneConfig({renderTo:document.body,hidden:!0}));var p=[];d.items&&d.items.each(function(e){if(!e.hidden){var t=this.encoders.legends[e.getXType()];p=p.concat(t.call(this,e,r.pages[0].scale))}},this),c||d.destroy(),r.legends=p}return r}},e.plugins=[a],this.callParent(arguments),this.layers.add(this.searchLayer),this.layers.add(this.drawLayer),this.layers.add(this.measureLayer),this.layers.add(this.measureLayerArea),this.layers.add(this.measureLayerLength),this.layers.add(this.measureLayerSegments),this.map.setLayerIndex(this.measureLayer,98),this.map.setLayerIndex(this.measureLayerArea,98),this.map.setLayerIndex(this.measureLayerLength,98),this.map.setLayerIndex(this.measureLayerSegments,98),this.selectControl=new OpenLayers.Control.SelectFeature(this.drawLayer),this.selectControl.handlers.feature.stopDown=!1,this.map.addControl(this.selectControl),this.map.popup=[]},unselectAll:function(){this.drawLayer.selectedFeatures.forEach(function(e){this.selectControl.unselect(e)},this)},parseStyle:function(e){var t,a,r,n={Point:{pointRadius:4,graphicName:"square",fillColor:"#e8ffee",fillOpacity:.9,strokeWidth:1,strokeOpacity:1,strokeColor:"#29bf4c"},Line:{strokeWidth:3,strokeColor:"#29bf4c",strokeOpacity:1},Polygon:{strokeWidth:3,strokeOpacity:1,strokeColor:"#29bf4c",fillColor:"#e8ffee",fillOpacity:.9}},i=function(e){var t=Ext.clone(n);return e.Point?(Ext.apply(t.Point,e.Point),Ext.apply(t.Line,e.Line),Ext.apply(t.Polygon,e.Polygon),e.labelSegments&&Ext.apply(t.labelSegments,e.labelSegments),e.labelLength&&Ext.apply(t.labelLength,e.labelLength)):(Ext.apply(t.Point,e),Ext.apply(t.Line,e),Ext.apply(t.Polygon,e)),t},s=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:n})]});e&&(e["default"]&&(s=i(e["default"]),s=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:s})]})),e.select&&(t=i(e.select),t=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:t})]})),e.temporary&&(a=i(e.temporary),a=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:a})]})),e.labelLength&&(r=i(e),r=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:r})]})),e["default"]||(s=i(e),s=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:s})]})));var o={"default":s};t&&(o.select=t),a&&(o.temporary=a),r&&(o["default"]=r);var l=new OpenLayers.StyleMap(o);return l},initDefaultLayers:function(e){function t(e){var t=e.feature;this.selectControl.select(t)}function a(e){e.feature}e.drawStyle||(e.drawStyle={"default":{Point:{pointRadius:4,graphicName:"square",fillColor:"#ffffff",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#2969bf"},Line:{strokeWidth:3,strokeColor:"#2969bf",strokeOpacity:1},Polygon:{strokeWidth:3,strokeOpacity:1,strokeColor:"#2969bf",fillOpacity:.3,fillColor:"#deecff"}},select:{strokeWidth:3,strokeOpacity:1,fillColor:"#deecff",fillOpacity:.75,strokeColor:"#2969bf"},temporary:{strokeWidth:3,strokeOpacity:.75,fillColor:"#ff00ff",fillOpacity:0,strokeColor:"#ff00ff"}}),this.drawLayer=new OpenLayers.Layer.Vector("Drawings",{displayInLayerSwitcher:!1,styleMap:this.parseStyle(e.drawStyle||this.drawLayerDefaultStyle)});var r=new OpenLayers.Rule({filter:new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"type",value:"label"}),symbolizer:{pointRadius:20,fillOpacity:0,strokeOpacity:0,label:"${label}"}});this.drawLayer.styleMap.styles["default"].addRules([r]),e.autoClearDrawLayer&&this.drawLayer.events.register("beforefeatureadded",this,function(){this.drawLayer.destroyFeatures()}),this.drawLayer.events.register("beforefeaturemodified",this,t),this.drawLayer.events.register("afterfeaturemodified",this,a),e.searchStyle||(e.searchStyle={Point:{externalGraphic:OpenEMap.basePathImages+"point_added.png",graphicWidth:15,graphicOpacity:1},Line:{strokeWidth:3,strokeColor:"#2969bf",strokeOpacity:1},Polygon:{strokeDashstyle:"dot",strokeWidth:3,strokeOpacity:1,strokeColor:"#f58d1e",fillOpacity:0}}),this.searchLayer=new OpenLayers.Layer.Vector("Searchresult",{displayInLayerSwitcher:!1,styleMap:this.parseStyle(e.searchStyle)});var n=OpenLayers.Control.DynamicMeasure.styles,i=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:n.Point,Line:n.Line,Polygon:n.Polygon}})]}),s=new OpenLayers.StyleMap({"default":i}),o=function(e){return new OpenLayers.StyleMap({"default":OpenLayers.Util.applyDefaults(null,n[e])})};this.measureLayer=new OpenLayers.Layer.Vector("MeasureLayer",{displayInLayerSwitcher:!1,styleMap:s}),this.measureLayerArea=new OpenLayers.Layer.Vector("MeasureLayerArea",{displayInLayerSwitcher:!1,styleMap:o("labelArea")}),this.measureLayerSegments=new OpenLayers.Layer.Vector("MeasureLayerSegments",{displayInLayerSwitcher:!1,styleMap:o("labelSegments")}),this.measureLayerLength=new OpenLayers.Layer.Vector("MeasureLayerLength",{displayInLayerSwitcher:!1,styleMap:o("labelLength")})},setInitialExtent:function(){var e=this.map;e.getCenter()||(this.center||this.zoom?e.setCenter(this.center,this.zoom):this.extent instanceof OpenLayers.Bounds?e.zoomToExtent(this.extent,!1):e.zoomToMaxExtent())}}),Ext.define("OpenEMap.view.SearchCoordinate",{extend:Ext.container.Container,layout:"column",defaults:{labelWidth:20},width:300,border:!1,zoom:5,initComponent:function(e){var t=this.mapPanel.searchLayer;this.items=[{itemId:"e",fieldLabel:"E",xtype:"textfield",columnWidth:.5},{itemId:"n",fieldLabel:"N",xtype:"textfield",columnWidth:.5},{xtype:"button",text:"Sök",handler:function(){var e=this.down("#e").getValue(),a=this.down("#n").getValue();this.mapPanel.map.setCenter([e,a],this.zoom),t.destroyFeatures();var r=new OpenLayers.Geometry.Point(e,a);feature=new OpenLayers.Feature.Vector(r),t.addFeatures([feature]),this.fireEvent("searchcomplete",[e,a])},scope:this}],this.addEvents(["searchcomplete"]),this.callParent(arguments)}}),Ext.define("OpenEMap.form.SearchRegisterenhet",{extend:Ext.form.field.ComboBox,alias:"widget.searchregisterenhet",require:["Ext.data.*","Ext.form.*"],emptyText:"Sök fastighet...",selectOnFocus:!0,minChars:3,displayField:"name",valueField:"id",labelWidth:60,queryParam:"q",queryDelay:800,typeAhead:!0,forceSelection:!0,msgTarget:"under",initComponent:function(){function e(e){this.mapPanel.setLoading(!0),this.mapPanel.searchLayer.destroyFeatures(),OpenEMap.requestLM({url:"registerenheter/"+e+"/enhetsomraden?",success:function(e){this.resultPanel.expand();var t=(new OpenLayers.Format.GeoJSON).read(e.responseText);r.addFeatures(t);var n=r.getDataExtent();a?this.mapPanel.map.setCenter(n.getCenterLonLat(),a):this.mapPanel.map.zoomToExtent(n)},failure:function(){Ext.Msg.alert("Fel","Ingen träff.")},callback:function(){this.mapPanel.setLoading(!1)},scope:this})}var t,a;this.search&&this.search.options&&(t=this.search.options.municipalities.join(","),a=this.search.options.zoom);var r=this.mapPanel.searchLayer;this.store=Ext.create("Ext.data.Store",{proxy:{type:"ajax",url:OpenEMap.basePathLM+"registerenheter",extraParams:{lmuser:OpenEMap.lmUser},reader:{type:"json",root:"features"}},fields:[{name:"id",mapping:"properties.objid"},{name:"name",mapping:"properties.name"}]}),this.store.on("beforeload",function(e,t){e.lastOperation=t},this),this.store.on("load",function(e,t,a,r){a?0===e.count()&&(this.setActiveError("Sökningen gav inga träffar"),this.doComponentLayout()):(this.setActiveError("Söktjänsten fungerar inte"),this.doComponentLayout())},this),this.clearSearchString=function(e,t,a){"undefined"==typeof a&&(a=this),a.clearValue(),a.collapse(),r.destroyFeatures(),a.focus()},this.listeners={select:function(t,a){var r=a[0].get("id");e.call(this,r)},beforequery:function(e){if(e.query.length<this.minChars)e.cancel=!0;else{t&&null===e.query.match(t)&&(e.query=t+" "+e.query);this.store.lastOperation&&this.store.lastOperation.request&&this.store.lastOperation.request.params&&this.store.lastOperation.request.params.q?this.store.lastOperation.request.params.q:void 0;if(this.store.loading&&this.store.lastOperation){var a=Ext.Ajax.requests;for(var r in a)a.hasOwnProperty(r)&&a[r].options==this.store.lastOperation.request&&Ext.Ajax.abort(a[r])}}},scope:this},this.trigger1Cls="x-form-clear-trigger",this.onTrigger1Click=this.clearSearchString,this.callParent(arguments)}}),Ext.define("OpenEMap.form.SearchAddress",{extend:Ext.form.field.ComboBox,alias:"widget.searchaddress",require:["Ext.data.*","Ext.form.*"],emptyText:"Sök adress...",selectOnFocus:!0,minChars:3,labelWidth:60,displayField:"name",valueField:"id",queryParam:"q",typeAhead:!0,forceSelection:!0,msgTarget:"under",initComponent:function(){function e(e,t,n){this.mapPanel.setLoading(!0),this.mapPanel.searchLayer.destroyFeatures(),OpenEMap.requestLM({url:"registerenheter?fnr="+e,success:function(e){var i=Ext.decode(e.responseText);if(i.success===!1)return void Ext.Msg.alert("Meddelande","Ingen fastighet kunde hittas på adressen.");this.resultPanel.expand();var s=(new OpenLayers.Format.GeoJSON).read(e.responseText,"FeatureCollection");r.addFeatures(s);var o=new OpenLayers.Geometry.Point(t,n);feature=new OpenLayers.Feature.Vector(o),r.addFeatures([feature]),this.mapPanel.map.setCenter([t,n],a)},failure:function(){Ext.Msg.alert("Fel","Okänt.")},callback:function(){this.mapPanel.setLoading(!1)},scope:this})}var t,a=5;this.search&&this.search.options&&(t=this.search.options.municipalities.join(","),a=this.search.options.zoom);var r=this.mapPanel.searchLayer;this.store=Ext.create("Ext.data.Store",{proxy:{type:"ajax",url:OpenEMap.basePathLM+"addresses",extraParams:{lmuser:OpenEMap.lmUser},reader:{type:"array"}},fields:["id","name","x","y","fnr"]}),this.store.on("beforeload",function(e,t){e.lastOperation=t},this),this.store.on("load",function(e,t,a,r){a?0===e.count()&&(this.setActiveError("Sökningen gav inga träffar"),this.doComponentLayout()):(this.setActiveError("Söktjänsten fungerar inte"),this.doComponentLayout())},this),this.clearSearchString=function(e,t,a){"undefined"==typeof a&&(a=this),a.clearValue(),a.collapse(),r.destroyFeatures(),a.focus()},this.listeners={select:function(t,a){e.call(this,a[0].data.fnr,a[0].data.x,a[0].data.y)},beforequery:function(e){if(e.query.length<this.minChars)e.cancel=!0;else if(t&&null===e.query.match(t)&&(e.query=t+" "+e.query),this.store.loading&&this.store.lastOperation){var a=Ext.Ajax.requests;for(var r in a)a.hasOwnProperty(r)&&a[r].options==this.store.lastOperation.request&&Ext.Ajax.abort(a[r])}},scope:this},this.trigger1Cls="x-form-clear-trigger",this.onTrigger1Click=this.clearSearchString,this.callParent(arguments)}}),Ext.define("OpenEMap.form.SearchPlacename",{extend:Ext.form.field.ComboBox,alias:"widget.searchplacename",require:["Ext.data.*","Ext.form.*"],emptyText:"Sök ort...",selectOnFocus:!0,minChars:3,labelWidth:60,displayField:"name",valueField:"id",queryParam:"q",typeAhead:!0,forceSelection:!0,msgTarget:"under",initComponent:function(){var e,t=5;this.search&&this.search.options&&(e=this.search.options.municipalities.join(","),t=this.search.options.zoom),this.store=Ext.create("Ext.data.Store",{proxy:{type:"ajax",url:OpenEMap.basePathLM+"placenames",extraParams:{lmuser:OpenEMap.lmUser,kommunkod:e},reader:{type:"json",root:"features"}},fields:[{name:"id",mapping:"properties.id"},{name:"name",mapping:"properties.name"}]}),this.store.on("beforeload",function(e,t){e.lastOperation=t},this),this.store.on("load",function(e,t,a,r){a?0===e.count()&&(this.setActiveError("Sökningen gav inga träffar"),this.doComponentLayout()):(this.setActiveError("Söktjänsten fungerar inte"),this.doComponentLayout())},this),this.clearSearchString=function(e,t,a){"undefined"==typeof a&&(a=this),a.clearValue(),a.collapse(),layer.destroyFeatures(),a.focus()},this.listeners={select:function(e,a){var r=a[0].raw,n=r.geometry.coordinates,i=[n[1],n[0]];this.mapPanel.map.setCenter(i,t)},beforequery:function(e){if(this.minChars="undefined"!=typeof this.minChars?this.minChars:0,e.query.length<this.minChars)e.cancel=!0;else if(this.store.loading&&this.store.lastOperation){var t=Ext.Ajax.requests;for(var a in t)t.hasOwnProperty(a)&&t[a].options==this.store.lastOperation.request&&Ext.Ajax.abort(t[a])}},scope:this},this.trigger1Cls="x-form-clear-trigger",this.onTrigger1Click=this.clearSearchString,this.callParent(arguments)}}),Ext.define("OpenEMap.form.SearchES",{extend:Ext.form.field.ComboBox,alias:"widget.searches",require:["Ext.data.*","Ext.form.*"],emptyText:"Sök detaljplan...",selectOnFocus:!0,minChars:1,labelWidth:60,displayField:"hit",valueField:"id",queryParam:"q",typeAhead:!0,forceSelection:!0,msgTarget:"under",initComponent:function(){var e=this.mapPanel.map,t=this.mapPanel.searchLayer;this.store=Ext.create("Ext.data.Store",{proxy:{type:"ajax",url:OpenEMap.basePathES+"_search",reader:{type:"json",root:"hits.hits",totalProperty:"hits.total",idProperty:"_id"}},fields:[{name:"type",mapping:"_type"},{name:"hit",mapping:"_source.properties.TEXT"},{name:"geometry",mapping:"_source.geometry"}]}),this.store.on("load",function(e,t,a,r){a?0===e.count()&&(this.setActiveError("Sökningen gav inga träffar"),this.doComponentLayout()):(this.setActiveError("Söktjänsten fungerar inte"),this.doComponentLayout())},this),this.clearSearchString=function(e,a,r){"undefined"==typeof r&&(r=this),r.clearValue(),r.collapse(),t.destroyFeatures(),r.focus()},this.listeners={select:function(a,r){var n=r[0].data.geometry,i=new OpenLayers.Format.GeoJSON({ignoreExtraDims:!0}),s=i.read(n,"Geometry"),o=new OpenLayers.Feature.Vector(s);t.destroyFeatures(),t.addFeatures([o]),e.zoomToExtent(o.geometry.getBounds())},beforequery:function(e){e.query.length<this.minChars?e.cancel=!0:e.query='"'+e.query+'"*'},scope:this},this.trigger1Cls="x-form-clear-trigger",this.onTrigger1Click=this.clearSearchString,this.callParent(arguments)}}),Ext.define("OpenEMap.view.SearchFastighet",{extend:Ext.form.Panel,border:!1,draggable:!1,initComponent:function(){function e(e){var t=null;return t="searchregisterenhet"===e?this.search&&this.search.searchEstates?this.search.searchEstates:null:"searchaddress"===e?this.search&&this.search.searchAddresses?this.search.searchAddresses:null:this.search&&this.search.searchPlacenames?this.search.searchPlacenames:null,{xtype:e,mapPanel:this.mapPanel,basePath:this.basePath,search:t,resultPanel:l}}function t(t,a){var r=this.down("#search");this.mapPanel.searchLayer.destroyFeatures(),r.removeAll(),r.add(e.call(this,a))}this.renderTo||(this.title="Sök",this.bodyPadding=5);var a="",r=[];this.search&&this.search.searchEstates&&(r.push(["searchregisterenhet","Fastighet"]),a="searchregisterenhet"),this.search&&this.search.searchAddresses&&(r.push(["searchaddress","Adress"]),a=""===a?"searchaddress":a),this.search&&this.search.searchPlacenames&&(r.push(["searchplacename","Ort"]),a=""===a?"searchplacename":a),this.search&&this.search.searchES&&this.search.searchES.detaljplan&&(r.push(["searches","Detaljplaner"]),a=""===a?"searches":a);var n=[{text:"Namn",dataIndex:"name",flex:1}],i=Ext.create("GeoExt.data.FeatureStore",{layer:this.mapPanel.searchLayer,featureFilter:new OpenLayers.Filter.Function({evaluate:function(e){return e.attributes.name?!0:!1}}),fields:[{name:"name"},{name:"fid"},{name:"objid"}]}),s=new OpenLayers.Control.SelectFeature(this.mapPanel.searchLayer);s.handlers.feature.stopDown=!1,this.mapPanel.map.addControl(s);var o=Ext.create("GeoExt.selection.FeatureModel",{selectControl:s}),l=Ext.create("Ext.grid.Panel",{columns:n,store:i,selModel:o});this.items=[{layout:"column",border:!1,items:[{xtype:"combo",width:110,store:r,forceSelection:!0,queryMode:"local",value:a,border:!1,listeners:{change:t,scope:this}},{itemId:"search",columnWidth:1,layout:"fit",border:!1,items:e.call(this,a)}]}],this.items.push(l),this.callParent(arguments)}}),Ext.define("OpenEMap.view.Scalebar",{extend:Ext.panel.Panel,bodyStyle:"background : transparent",border:!1,getTools:function(){},constructor:function(e){Ext.apply(this,e);var t=null,a=document.getElementById(this.renderTo);t=a?new OpenLayers.Control.ScaleLine({div:a}):new OpenLayers.Control.ScaleLine,this.mapPanel.map.addControl(t),this.callParent(arguments)}}),Ext.define("OpenEMap.view.ShowCoordinate",{extend:Ext.container.Container,defaults:{labelWidth:10},border:!1,layout:"column",width:150,srs:"",constructor:function(e){this.items=[{itemId:"e",fieldLabel:"E",xtype:"textfield",columnWidth:.5,baseCls:e.cls,baseBodyCls:e.cls,bodyCls:e.cls,fieldCls:e.cls,fieldBodyCls:e.cls,formItemCls:e.cls,inputRowCls:e.cls,labelCls:e.cls},{itemId:"n",fieldLabel:"N",xtype:"textfield",columnWidth:.5,baseCls:e.cls,baseBodyCls:e.cls,bodyCls:e.cls,fieldCls:e.cls,fieldBodyCls:e.cls,formItemCls:e.cls,inputRowCls:e.cls,labelCls:e.cls}],this.callParent(arguments)}}),Ext.define("OpenEMap.view.ZoomTools",{extend:Ext.panel.Panel,bodyStyle:"background : transparent",border:!1,getTools:function(){var e=(Ext.util.CSS.getRule(".oep-tools"),"large"),t="5 0 5 0",a=[],r=Ext.create("GeoExt.slider.Zoom",{height:160,vertical:!0,aggressive:!0,margin:t,map:this.mapPanel.map});return a.push({xtype:"button",iconCls:"zoomtools-plus",mapPanel:this.mapPanel,scale:e,cls:"x-action-btn",listeners:{click:function(){this.mapPanel.map.zoomIn()},scope:this}}),a.push(r),a.push({xtype:"button",scale:e,cls:"x-action-btn",iconCls:"zoomtools-minus",mapPanel:this.mapPanel,listeners:{click:function(){this.mapPanel.map.zoomOut()},scope:this}}),a},constructor:function(e){Ext.apply(this,e),this.items=this.getTools(),this.callParent(arguments)}}),Ext.define("OpenEMap.model.GroupedLayerTreeModel",{extend:Ext.data.Model,fields:[{name:"text",type:"string"},{name:"checkedGroup",type:"string"},{name:"isGroupLayer"},{name:"layer"},{name:"queryable",type:"boolean"},{name:"clickable",type:"boolean"},{name:"isGroupLayer",type:"boolean"},{name:"toggleGroupEnabled",type:"boolean"},{name:"expanded",type:"boolean"},{name:"layerId"},{name:"name",type:"string"},{name:"title",type:"string"},{name:"urlToMetadata"},{name:"wms"},{name:"wfs"},{name:"serverId"},{name:"metadata"},{name:"legendURL"},{name:"layers"}]}),Ext.define("OpenEMap.data.GroupedLayerTree",{extend:Ext.data.TreeStore,model:"OpenEMap.model.GroupedLayerTreeModel",defaultRootProperty:"layers",proxy:{type:"memory"},maxLayerIndex:1e3,listeners:{beforeinsert:function(e,t,a,r){return this.onBeforeInsert(e,t,a)},beforeappend:function(e,t,a){return this.onBeforeAppend(e,t)},insert:function(e,t,a,r){this.onInsertAndAppend(t)},append:function(e,t,a,r){this.onInsertAndAppend(t)},remove:function(e,t,a,r){this.onRemove(e,t,a)}},constructor:function(e){e=Ext.apply({},e),this.callParent([e])},getLayerConfiguration:function(e){function t(e,a){var r={name:e.get("name"),isGroupLayer:e.get("isGroupLayer"),expanded:e.get("expanded"),queryable:e.get("queryable"),clickable:e.get("clickable"),wms:"string"==typeof e.get("wms")?{}:e.get("wms"),wfs:"string"==typeof e.get("wfs")?{}:e.get("wfs"),layer:a?e.get("layer"):void 0,metadata:"string"==typeof e.get("metadata")?{}:e.get("metadata"),title:e.get("title"),layers:[]};r.wms&&0!==Object.keys(r.wms).length||(r.wms=void 0),r.wfs&&0!==Object.keys(r.wfs).length||(r.wfs=void 0);for(var n=0;n<e.childNodes.length;n++)r.layers.push(t(e.childNodes[n],a));return r}for(var a=[],r=this.getRootNode().childNodes,n=0;n<r.length;n++)a.push(t(r[n],e));return a},onBeforeAppend:function(e,t){return!t.get("toggleGroupEnabled")&&t.get("isGroupLayer")&&t.set("cls","disabled-opacity"),!0},createInlineLegend:function(e){if(e.raw.layer&&!e.get("hasInlineLegend")){var t,a=e.raw.layer;if(void 0!==a.legendURL)t=a.legendURL;else if(e.raw.wms&&e.raw.wms.params&&(e.raw.wms.params.LAYERS||e.raw.wms.params.layers)){var r=GeoExt.data.LayerModel.createFromLayer(a),n=Ext.create("GeoExt.container.WmsLegend",{layerRecord:r,useScaleParameter:!1});t=n.getLegendUrl(e.raw.wms.params.LAYERS||e.raw.wms.params.layers)}t&&t.length>0&&e.set("text",'<div style="display:inline-block;width:20px;height:20px;margin-right:2px;overflow:hidden;vertical-align:middle;"><img class="legendimg" src="'+t+'" style="height:20px;"></div>'+e.get("text")),e.set("hasInlineLegend",!0)}},onBeforeInsert:function(e,t,a){return!0},onInsertAndAppend:function(e){if(!this._inserting){this._inserting=!0;var t=e.getOwnerTree()instanceof OpenEMap.view.layer.Add;t||(""!==e.get("layer")&&(e.get("layer").events.register("loadstart",e,function(e){"loading"!==this.get("loadstatus")&&(this.set("cls","oep-layerloading"),this.set("loadstatus","loading"),this.set("qtip",""))}),e.get("layer").events.register("moveend",e,function(e){"loading"!==this.get("loadstatus")&&(this.set("cls","oep-layerloading"),this.set("loadstatus","loading"),this.set("qtip",""))}),e.get("layer").events.register("loadend",e,function(t){"loaded"!==this.get("loadstatus")&&e.get("loadend")===e.get("loadstart")&&"loading"===this.get("loadstatus")&&(this.set("loadstatus","loaded"),this.set("cls",""))}),e.get("layer").events.register("tileerror",e,function(e){"error"!==this.get("loadstatus")&&(this.set("cls","oep-layererror"),this.set("loadstatus","error"),this.set("qtip","Fel när lagret skulle ritas upp."))})),e.raw.checked_&&e.set("checked",e.raw.checked_),e.cascadeBy(function(e){var t=e.get("layer");if(e.getLayer=function(){return this.get("layer")},t&&""!==t&&this.map){var a=this.map.getLayer(t);null===a&&t&&t.displayInLayerSwitcher===!0&&this.map.addLayer(t)}},this),this.reorderLayersOnMap(),this.createInlineLegend(e)),delete this._inserting}},onRemove:function(e,t,a){this._removing||a||(this._removing=!0,t.cascadeBy(function(e){var t=e.get("layer");t&&t.map&&this.map.removeLayer(t)},this),delete this._removing)},reorderLayersOnMap:function(){var e=this.getRootNode();if(e){var t=this.maxLayerIndex;e.cascadeBy(function(e){var a=e.get("layer");a&&(a.setZIndex(t),t--)},this)}},unbind:function(){var e=this;e.un("beforeinsert",e.onBeforeInsert,e),e.un("beforeappend",e.onBeforeAppend,e),e.un("insert",e.onInsertAndAppend,e),e.un("append",e.onInsertAndAppend,e),e.un("remove",e.onRemove,e),e.map=null},destroy:function(){}}),Ext.define("OpenEMap.view.layer.Tree",{extend:Ext.tree.Panel,rootVisible:!1,hideHeaders:!0,initComponent:function(){!this.store&&this.mapPanel&&(this.store=Ext.create("OpenEMap.data.GroupedLayerTree",{root:{text:this.mapPanel.config&&this.mapPanel.config.name?this.mapPanel.config.name:"Lager",expanded:!0,isGroupLayer:!0,layers:this.mapPanel.map.layerSwitcherLayerTree},map:this.mapPanel.map})),this.on("viewready",function(e,t){"OpenEMap.view.layer.Tree"!==e.$className&&"OpenEMap.view.layer.Basic"!==e.$className||e.view.hasLoadingHeight||(e.view.hasLoadingHeight=!0)}),this.on("checkchange",function(e,t,a){function r(e,t){var a=e.parentNode;a.get("checked")!=e.get("checked")&&(t?a.isRoot()||(a.set("checked",t),r(a,t)):a.isRoot()||a.childNodes.some(function(e){return e.get("checked")})||(a.set("checked",t),r(a,t)))}return e.data.isGroupLayer&&!e.data.toggleGroupEnabled?void e.set("checked",!t):(e.cascadeBy(function(e){e.set("checked",t);var a=e.get("layer");a&&(a.setVisibility(t),a.options.visibility=t);var r=e.get("wms");r&&(r.options.visibility=t)}),void r(e,t))}),this.on("cellclick",function(e,t,a,r,n,i,s){("undefined"==typeof this.legendDelay||null===this.legendDelay)&&(this.legendDelay=5e3);var o=function(e,t){var a=Ext.create("Ext.Img",{src:e}),i=Ext.create("Ext.tip.ToolTip",{title:"Legend "+r.raw.name,closable:!0,dismissDelay:t,items:a});i.showBy(n),a.getEl().on("load",function(){i.doLayout()})},l=function(e){var t,a=e.raw.layer;if(void 0!==a.legendURL)t=a.legendURL;else if(e.raw.wms&&(e.raw.wms.params.LAYERS||e.raw.wms.params.layers)){var r=GeoExt.data.LayerModel.createFromLayer(a),n=Ext.create("GeoExt.container.WmsLegend",{layerRecord:r,useScaleParameter:!1});t=n.getLegendUrl(e.raw.wms.params.LAYERS||e.raw.wms.params.layers)}return t},d=s.browserEvent.target||s.browserEvent.srcElement;if(Ext.get(d).hasCls("legendimg")&&r.raw.layer){var c=l(r);c&&c.length>0&&o(c,this.legendDelay)}}),this.callParent(arguments)},getBaseLayersConfiguration:function(){function e(e){var t={name:e.name,wms:{url:e.url,options:e.options,params:e.params},visibility:e.visibility};return t.wms.options.visibility=e.visibility,t}for(var t=[],a=this.mapPanel.map.layers.filter(function(e){return e.isBaseLayer}),r=0;r<a.length;r++)t.unshift(e(a[r]));return t},getConfig:function(e){var t=Ext.clone(this.client.initialConfig),a=this.getStore().getLayerConfiguration(e),r=t.layers.filter(function(e){return e.wms&&e.wms.options&&e.wms.options.isBaseLayer?e:!1});return r=this.getBaseLayersConfiguration(),t.layers=r.concat(a),t}}),Ext.define("OpenEMap.data.DataHandler",{metadataAbstractWsUrl:null,metadataWsUrl:null,layersWsUrl:null,metadataAbstractCache:{},constructor:function(e){this.wsUrls=OpenEMap.wsUrls,Ext.apply(this,e)},getLayer:function(e,t){},getLayers:function(e){},getMetadata:function(e,t){e&&this.wsUrls.metadata&&this.doRequest({url:this.wsUrls.basePath+this.wsUrls.metadata+"/"+e},t)},getMetadataAbstract:function(e,t){if(e&&this.wsUrls.metadata_abstract){var a=this;a.metadataAbstractCache[e]?t(a.metadataAbstractCache[e]):this.doRequest({url:this.wsUrls.basePath+this.wsUrls.metadata_abstract+"/"+e},function(r){t(r),a.metadataAbstractCache[e]=r})}},updateConfiguration:function(e,t,a){this.doRequest({url:this.wsUrls.basePath+this.wsUrls.adminconfigs+"/config/"+e,method:"PUT",jsonData:t},a)},saveNewConfiguration:function(e,t){this.doRequest({url:this.wsUrls.basePath+this.wsUrls.adminconfigs+"/config/",method:"POST",jsonData:e},t)},deleteConfiguration:function(e,t,a){this.doRequest({url:this.wsUrls.basePath+this.wsUrls.adminconfigs+"/config/"+e,method:"DELETE",jsonData:t},a)},doRequest:function(e,t){var a=this;return e&&e.method&&"POST"===e.method&&"PUT"===e.method&&!t?(a.onFailure("no callback function"),!1):void Ext.Ajax.request(Ext.apply({success:function(e){if(e&&e.responseText){var r=Ext.decode(e.responseText);t&&t(r)}else a.onFailure()},failure:function(t){a.onFailure(t.status+" "+t.statusText+", "+e.url)}},e?e:{}))},onFailure:function(e){console.error(e)}}),Ext.define("OpenEMap.view.layer.TreeFilter",{extend:Ext.AbstractPlugin,alias:"plugin.treefilter",collapseOnClear:!0,allowParentFolders:!1,init:function(e){var t=this;t.tree=e,e.filter=Ext.Function.bind(t.filter,t),e.clearFilter=Ext.Function.bind(t.clearFilter,t)},filter:function(e,t,a){var r,n=this,i=n.tree,s=[],o=i.getRootNode(),l=[];return t=t||"text",a=a||new RegExp(e,"ig"),Ext.isEmpty(e)?void n.clearFilter():(i.expandAll(),o.cascadeBy(function(e){e.get(t).match(a)&&s.push(e)}),n.allowParentFolders===!1&&Ext.each(s,function(e){e.isLeaf()||Ext.Array.remove(s,e)}),Ext.each(s,function(e,t,a){o.cascadeBy(function(t){t.contains(e)===!0&&l.push(t)}),n.allowParentFolders!==!0||e.isLeaf()||e.cascadeBy(function(e){l.push(e)}),l.push(e)}),void o.cascadeBy(function(e){r=Ext.fly(i.getView().getNode(e)),r&&(r.setVisibilityMode(Ext.Element.DISPLAY),r.setVisible(Ext.Array.contains(l,e)))}))},clearFilter:function(){var e=this,t=this.tree,a=t.getRootNode();e.collapseOnClear&&t.collapseAll(),a.cascadeBy(function(e){viewNode=Ext.fly(t.getView().getNode(e)),viewNode&&viewNode.show()})}}),Ext.define("OpenEMap.view.layer.Add",{extend:OpenEMap.view.layer.Tree,title:"Lägg till lager",headerPosition:"top",collapsible:!0,collapseMode:"header",collapseDirection:"right",titleCollapse:!0,displayField:"title",viewConfig:{plugins:{ptype:"treeviewdragdrop",enableDrop:!1},copy:!0},plugins:{ptype:"treefilter",allowParentFolders:!0},dockedItems:[{xtype:"toolbar",dock:"top",layout:"fit",items:[{xtype:"trigger",triggerCls:"x-form-clear-trigger",onTriggerClick:function(){this.reset(),this.focus()},listeners:{change:function(e,t){var a=e.up("treepanel");a.filter(t)},buffer:250}}]}],initComponent:function(){this.columns=[{xtype:"treecolumn",flex:1,dataIndex:"title"}],this.store=Ext.create("OpenEMap.data.GroupedLayerTree"),Ext.Ajax.request({url:OpenEMap.basePathProxy+OpenEMap.wmsURLs.getCapabilities,success:this.parseCapabilities,scope:this,disableCaching:!1}),this.callParent(arguments)},parseCapabilities:function(e){var t=new OpenLayers.Format.WMSCapabilities,a=t.read(e.responseText),r=this.store.setRootNode({}),n=function(e,t){if(""!==t)return t;var a=e.split(":");return a.length>1?a[1]:e};a.capability.layers.sort(function(e,t){return n(e.name,e.title)<n(t.name,t.title)?-1:n(e.name,e.title)>n(t.name,t.title)?1:0});var i=a.capability.layers.map(function(e){var t=function(e){return e.length<=0?"image/png":e.indexOf("image/png")>=0?"image/png":e.indexOf("image/jpg")>=0?"image/jpg":e[0]},r={text:n(e.name,e.title),leaf:!0,checked_:!0,title:e.title,name:n(e.name,e.title),queryable:e.queryable,clickable:e.queryable,isGroupLayer:!1,visibility:!0,metadataURL:e.metadataURLs.length>0?e.metadataURLs[0]:null,wms:{url:a.capability.request.getmap&&a.capability.request.getmap.href?a.capability.request.getmap.href:OpenEMap.wmsURLs.url,
params:{LAYERS:e.name,FORMAT:t(e.formats),TRANSPARENT:!0,tiled:!0},options:{isBaseLayer:!1,visibility:!0}}},i=Ext.create("OpenEMap.config.Parser");return r.layer=i.createLayer(r),r});r.appendChild(i),this.gui.fireEvent("addLayerControlLoaded",this)}}),Ext.define("OpenEMap.view.MetadataWindow",{extend:Ext.Window,title:"Metadata",width:600,height:500,border:0,layout:"fit",closeAction:"hide",TRANSLATION:{sv:{tag:{"gmd:citation":"","gmd:CI_Address":"","gmd:CI_Citation":"","gmd:CI_Contact":"","gmd:CI_Date":"","gmd:CI_Telephone":"","gmd:CI_ResponsibleParty":"","gmd:identificationInfo":"","gmd:EX_BoundingPolygon":"","gmd:EX_Extent":"","gmd:EX_GeographicBoundingBox":"","gmd:EX_GeographicDescription":"","gmd:EX_TemporalExtent":"","gmd:EX_VerticalExtent":"","gmd:MD_BrowseGraphic":"","gmd:MD_Constraints":"","gmd:MD_Identifier":"","gmd:MD_Keywords":"","gmd:MD_LegalConstraints":"","gmd:MD_Metadata":"","gmd:MD_MaintenanceInformation":"","gmd:MD_SecurityConstraints":"","gmd:thesaurusName":"","gmd:voice":"","srv:SV_ServiceIdentification":"","gmd:accessConstraints":"Nyttjanderestriktioner","gmd:abstract":"Sammanfattning","gmd:address":"Adress","gmd:alternateTitle":"Alternativ titel","gmd:city":"Stad","gmd:classification":"Klassificering","gmd:contact":"Metadatakontakt","gmd:contactInfo":"Kontaktinformation","gmd:date":"Datum","gmd:dateStamp":"Datum","gmd:dateType":"Datumtyp","gmd:descriptiveKeywords":"Nyckelordslista","gmd:electronicMailAddress":"E-post","gmd:fileIdentifier":"Identifierare för metadatamängden","gmd:graphicOverview":"Exempelbild","gmd:hierarchyLevel":"Hierarkisk nivå (Resurstyp)","gmd:individualName":"Person","gmd:identifier":"Identifierare","gmd:keyword":"Nyckelord","gmd:language":"Språk","gmd:metadataStandardName":"Metadatastandardversion","gmd:metadataStandardVersion":"Metadatastandard","gmd:organisationName":"Organisation","gmd:otherConstraints":"Andra restriktioner","gmd:phone":"Telefonnummer","gmd:pointOfContact":"Kontakt","gmd:resourceConstraints":"Restriktioner och begränsningar","gmd:role":"Ansvarsområde","gmd:status":"Status","gmd:title":"Titel","gmd:type":"Typ","gmd:useLimitation":"Användbarhetsbegränsningar"},codeListValue:{swe:"Svenska",service:"Tjänst",pointOfContact:"Kontakt"}}},initComponent:function(){this.overviewTab=new Ext.Panel({title:"Översikt"}),this.metadataTab=new Ext.Panel({title:"Information om metadata"}),this.dataTab=new Ext.Panel({title:"Information om data"}),this.qualityTab=new Ext.Panel({title:"Kvalitet"}),this.distributionTab=new Ext.Panel({title:"Distribution"}),this.restTab=new Ext.Panel({title:"Rest"}),this.items=Ext.create("Ext.tab.Panel",{activeTab:0,defaults:{autoScroll:!0},items:[this.overviewTab,this.metadataTab,this.dataTab,this.qualityTab,this.distributionTab,this.restTab]}),this.callParent(arguments)},showMetadata:function(e){var t=this;this.dataHandler.getMetadata(e,function(e){if(e.children){var a=t.parseMetadata(e.children);t.overviewTab.html=a.overview,t.metadataTab.html=a.metadata_info,t.dataTab.html=a.data_info,t.qualityTab.html=a.quality,t.distributionTab.html=a.distribution,t.restTab.html=a.rest,t.show()}})},translate:function(e,t){var a="sv",r=null;try{r=this.TRANSLATION[a][e][t],"string"!=typeof r&&(r=t)}catch(n){translateTag=null}return r},parseMetadataTextTag:function(e){var t=null;return e.tag&&(t=this.translate("tag",e.tag),t=null!==t?""!==t?"<b>"+t+"</b>":"":null),e.text&&(t=e.text),e.attributes&&e.attributes.codeListValue&&(t=this.translate("codeListValue",e.attributes.codeListValue)),t},getGroups:function(e,t){var a=[];for(var r in t)for(var n=0;n<t[r].length;n++)-1!==e.indexOf(t[r][n])&&a.push(r);return 0===a.length&&a.push("rest"),a},metadataIterator:function(e,t,a,r){for(var n=this.parseMetadataTextTag(e),i=("undefined"!=typeof r?r+">":"")+e.tag,s=this.getGroups(i,a),o=0;o<s.length;o++){var l=s[o];if("string"!=typeof t[l]&&(t[l]=""),null!==n){if(t[l]+="<li>",t[l]+=n,e.children&&0===o){t[l]+=""!==n?"<ul>":"";for(var d=0;d<e.children.length;d++)this.metadataIterator(e.children[d],t,a,i);t[l]+=""!==n?"</ul>":""}t[l]+="</li>"}}},parseMetadata:function(e){var t={},a={overview:["gmd:MD_Metadata>gmd:identificationInfo>srv:SV_ServiceIdentification>gmd:citation>gmd:CI_Citation>gmd:title","gmd:MD_Metadata>gmd:identificationInfo>srv:SV_ServiceIdentification>gmd:abstract","gmd:MD_Metadata>gmd:identificationInfo>srv:SV_ServiceIdentification>gmd:descriptiveKeywords","gmd:MD_Metadata>gmd:identificationInfo>srv:SV_ServiceIdentification>gmd:graphicOverview"],metadata_info:["gmd:MD_Metadata>gmd:fileIdentifier","gmd:MD_Metadata>gmd:language","gmd:MD_Metadata>gmd:dateStamp","gmd:MD_Metadata>gmd:hierarchyLevel","gmd:MD_Metadata>gmd:metadataStandardName","gmd:MD_Metadata>gmd:metadataStandardVersion","gmd:MD_Metadata>gmd:contact"],data_info:["gmd:MD_Metadata>gmd:identificationInfo"],quality:["gmd:MD_Metadata>gmd:dataQualityInfo"],distribution:["gmd:MD_Metadata>gmd:distributionInfo"]};return this.metadataIterator(e[0],t,a),t}}),Ext.define("OpenEMap.model.MapConfig",{extend:Ext.data.Model,fields:["configId","name","isPublic","username"]}),Ext.define("OpenEMap.data.SavedMapConfigs",{extend:Ext.data.Store,model:"OpenEMap.model.MapConfig",storeId:"savedMapConfigs",autoLoad:!0,constructor:function(e){this.proxy={type:"rest",appendId:!0,url:(OpenEMap&&OpenEMap.wsUrls&&OpenEMap.wsUrls.basePath?OpenEMap.wsUrls.basePath:"")+(OpenEMap&&OpenEMap.wsUrls&&OpenEMap.wsUrls.adminconfigs?OpenEMap.wsUrls.adminconfigs:"")+"/configlist",reader:{type:"json",root:"configs"},writer:{type:"json"}},this.callParent(arguments)}}),Ext.define("OpenEMap.view.SavedMapConfigs",{extend:Ext.grid.Panel,autoScroll:!0,hideHeaders:!0,id:"savedMapConfigsGrid",constructor:function(){this.store=Ext.create("OpenEMap.data.SavedMapConfigs"),this.columns=[{header:"Name",dataIndex:"name",flex:1,tooltip:"Ladda",renderer:function(e,t,a){return t.tdAttr='data-qtip="Ladda karta"',e},listeners:{click:function(e,t,a,r,n,i,s){var o=(OpenEMap&&OpenEMap.wsUrls&&OpenEMap.wsUrls.basePath?OpenEMap.wsUrls.basePath:"")+(OpenEMap&&OpenEMap.wsUrls&&OpenEMap.wsUrls.configs?OpenEMap.wsUrls.configs:"")+"/config/"+i.get("configId");Ext.Ajax.request({scope:this,url:o,success:function(e){return this.client.destroy(),this.client.configure(JSON.parse(e.responseText),this.client.initialOptions),n.stopEvent(),!1},failure:function(e){Ext.MessageBox.alert("Kommunikationsproblem","Kartan kan inte öppnas. Kontakta systemadministratör.")}})}.bind(this)}},{xtype:"actioncolumn",width:40,getClass:function(e,t){return t.record.get("isPublic")?"action-none":"action-remove"},tooltip:"Ta bort",handler:function(e,t,a,r,n,i,s){return i.get("isPublic")?!1:(Ext.MessageBox.confirm("Ta bort","Vill du verkligen ta bort konfigurationen?",function(a){if("yes"===a){var r=e.getStore();e.panel.dataHandler.deleteConfiguration(i.get("configId"),{configId:i.get("configId")}),r.removeAt(t)}}),n.stopEvent(),!1)}}],this.callParent(arguments)}}),Ext.define("OpenEMap.view.layer.Advanced",{extend:Ext.container.Container,layout:{type:"vbox",align:"stretch"},listeners:{afterrender:function(){this.gui.fireEvent("layerControlLoaded",this)}},initComponent:function(e){this.setLoading(!0);var t=this;this.dataHandler=Ext.create("OpenEMap.data.DataHandler"),this.metadataWindow=Ext.create("OpenEMap.view.MetadataWindow",{dataHandler:this.dataHandler}),this.savedMapConfigs=Ext.create("OpenEMap.view.SavedMapConfigs",{dataHandler:this.dataHandler,autoScroll:!0,client:this.client,title:"Kartor",collapsible:!0,flex:1,minHeight:100});var a=Ext.create("Ext.Action",{text:"Byt namn...",disabled:!0,handler:function(e,t){var a=this.showOnMapLayerView.getSelectionModel().getSelection()[0];a&&a.get("isGroupLayer")&&Ext.Msg.prompt("Byt namn...","Ange nytt namn:",function(e,t){"ok"==e&&a.set("text",t)},window,!1,a.get("text"))}.bind(this)}),r=Ext.create("Ext.Action",{text:"Nytt grupplager",disabled:!0,handler:function(e,t){var a=this.showOnMapLayerView.getSelectionModel().getSelection()[0];a&&Ext.Msg.prompt("Nytt grupplager","Ange namn:",function(e,t){if("ok"==e){var r=Ext.create("OpenEMap.model.GroupedLayerTreeModel",{text:t,checked:!0,isGroupLayer:!0});a.appendChild(r)}})}.bind(this)}),n=Ext.create("Ext.menu.Menu",{items:[a,r]});this.showOnMapLayerView=Ext.create("OpenEMap.view.layer.Tree",{title:"Visas på kartan",split:!0,border:!1,mapPanel:this.mapPanel,client:this.client,rootVisible:!1,collapsible:!0,autoscroll:!0,flex:4,legendDelay:this.legendDelay,viewConfig:{plugins:{ptype:"treeviewdragdrop",allowContainerDrops:!0,allowParentInserts:!0},listeners:{itemcontextmenu:function(e,t,a,r,i){return i.stopEvent(),n.showAt(i.getXY()),!1}}},columns:[{xtype:"gx_treecolumn",flex:1,dataIndex:"text"},{xtype:"actioncolumn",width:40,iconCls:"action-remove",tooltip:"Ta bort",handler:function(e,t,a){for(var r=e.getStore().getAt(t),n=0;n<r.childNodes.length;n++)r.removeChild(r.childNodes[n]);r.remove()},dataHandler:this.dataHandler}],buttons:[{text:"Spara kartinnehåll",handler:function(){if(t.orginalConfig){var e=Ext.clone(t.orginalConfig);Ext.MessageBox.prompt("Namn","Ange ett namn:",function(a,r){"ok"==a&&r.length>0&&(e=t.getConfig(),e.isPublic=!1,OpenEMap&&OpenEMap.username||Ext.Error.raise("Username undefined!"),e.username=OpenEMap.username,r!==e.name?(e.name=r,t.dataHandler.saveNewConfiguration(e,function(e){t.savedMapConfigs.getStore().load(),t.savedMapConfigs.client.destroy(),t.savedMapConfigs.client.configure(JSON.parse(e.json),t.savedMapConfigs.client.initialOptions)})):e.configId&&(t.dataHandler.updateConfiguration(e.configId,e),t.savedMapConfigs.getStore().load()))},this,!1,e.name)}}}]}),this.showOnMapLayerView.getSelectionModel().on({selectionchange:function(e,t){1===t.length&&t[0].data.isGroupLayer?(a.enable(),r.enable()):(a.disable(),r.disable())}}),this.items=[t.showOnMapLayerView,t.savedMapConfigs],this.callParent(arguments)},getConfig:function(e){return this.showOnMapLayerView.getConfig(e)}}),Ext.define("OpenEMap.view.layer.Basic",{extend:OpenEMap.view.layer.Tree,rootVisible:!1,width:300,resizable:!0,resizeHandles:"s",listeners:{afterrender:function(){this.gui.fireEvent("layerControlLoaded",this)}},initComponent:function(){this.setLoading(!0),this.renderTo||(this.title="Lager",this.bodyPadding=5,this.collapsible=!0),this.callParent(arguments)}}),Ext.define("OpenEMap.Gui",{activeAction:null,objectConfigWindowTitle:"Object configuration",layerControlLoading:!0,addLayerControlLoading:!0,mixins:{observable:Ext.util.Observable},constructor:function(e){this.config=e.config,this.gui=e.gui,this.map=e.map,this.orginalConfig=e.orginalConfig,this.serverStore=e.serverStore,this.search=e.config.search,this.client=e.client,this.mixins.observable.constructor.call(this,e),this.addEvents("layerControlLoaded","addLayerControlLoaded"),void 0===this.gui&&(this.gui={}),void 0===this.gui.map&&(this.gui.map=!1),this.gui.map==={}&&(this.gui.map=!1),void 0===this.gui.layerControl&&(this.gui.layerControl={}),void 0===this.gui.addLayerControl&&(this.gui.addLayerControl={}),this.mapPanel=Ext.create("OpenEMap.view.Map",{map:this.map,extent:this.config.extent,config:this.config,listeners:{beforerender:function(){this.mapPanel.setLoading(!0)},afterrender:function(){if(this.mapPanel.setLoading(!1),this.config.attribution){var e=this.mapPanel.getEl();Ext.DomHelper.append(e,'<span class="unselectable attribution">'+this.config.attribution+"</span>")}},scope:this}}),this.createObjectConfigPanel(),this.createToolbar(),this.createZoomToolPanel(),this.createScalebarPanel(),this.createShowCoordinatePanel(),this.createSearchCoordinatePanel(),this.createLayerControl(),this.createBaseLayersPanel();var t=[];if(t.push(this.mapPanel),this.zoomTools&&!this.gui.zoomTools.renderTo&&t.push(this.zoomTools),this.scalebar&&!this.gui.scalebar.renderTo&&t.push(this.scalebar),this.showCoordinate&&!this.gui.showCoordinate.renderTo&&t.push(this.showCoordinate),this.searchCoordinate&&!this.gui.searchCoordinate.renderTo&&t.push(this.searchCoordinate),this.layerControl&&!this.gui.layerControl.renderTo&&t.push(this.layerControl),this.addLayerControl&&!this.gui.addLayerControl.renderTo&&t.push(this.addLayerControl),this.baseLayers&&!this.gui.baseLayers.renderTo&&t.push(this.baseLayers),this.toolbar&&!this.gui.toolbar.renderTo&&t.push(this.toolbar),this.gui.map){var a=this.gui.map.renderTo?Ext.get(this.gui.map.renderTo):void 0;this.container=Ext.create("Ext.container.Container",Ext.apply({layout:"absolute",border:!1,width:a?a.getWidth():void 0,height:a?a.getHeight():void 0,items:t},this.gui.map))}else this.container=Ext.create("Ext.container.Viewport",{layout:"absolute",items:t})},destroy:function(){this.mapPanel&&this.mapPanel.destroy(),this.zoomTools&&this.zoomTools.destroy(),this.mapLayers&&this.mapLayers.destroy(),this.searchFastighet&&this.searchFastighet.destroy(),this.searchCoordinate&&this.searchCoordinate.destroy(),this.showCoordinate&&this.showCoordinate.destroy(),this.toolbar&&this.toolbar.destroy(),this.layerControl&&this.layerControl.destroy(),this.addLayerControl&&this.addLayerControl.destroy(),this.baseLayers&&this.baseLayers.destroy(),this.objectConfig&&this.objectConfig.destroy(),this.objectConfigWindow&&this.objectConfigWindow.destroy(),this.scalebar&&this.scalebar.destroy(),this.container&&this.container.destroy()},onToggle:function(e,t){var a=e.baseAction;this.objectConfig&&(t&&(this.mapPanel.unselectAll(),this.objectConfig.hide(),this.activeAction=a),a.toggle(t))},createToolbar:function(){var e=this.config.basePath,t=this.config.layers,a=function(a){var r;if(Ext.isObject(a)&&Ext.Object.getSize(a)>0||!Ext.isObject(a)&&!Ext.isEmpty(a)){a===this.config.tools[this.config.tools.length-1]&&(r="oep-tools-last");var n={map:this.map,mapPanel:this.mapPanel,cls:r};if(a.constructor===Object&&(Ext.apply(n,a),a=n.type,delete n.type),"ZoomSelector"==a)return Ext.create("OpenEMap.form.ZoomSelector",{map:this.map,cls:r});"DrawObject"==a?n.objectConfigView=this.objectConfig:"Identify"==a?(n.basePath=e,n.layers=t,n.client=this.client):"Permalink"==a?n.client=this.client:"Popup"==a&&(n.layers=t,(void 0===n.showOnlyFirstHit||null===n.showOnlyFirstHit)&&(n.showOnlyFirstHit=!0));var i=Ext.create("OpenEMap.action."+a,n);n.activate&&i.control&&(this.controlToActivate=i.control);var s=Ext.create("Ext.button.Button",i);return s.on("toggle",this.onToggle,this),s}};this.config.tools||(this.config.tools=[]);var r=this.config.tools.map(a,this),n=0;r.forEach(function(e){e&&(e.hideFromToolbar||(n+=e.constructor==String?1:e.width?e.width+1:38))}),this.gui.toolbar&&!this.gui.toolbar.renderTo?this.toolbar=Ext.create("Ext.toolbar.Toolbar",Ext.apply({cls:"oep-tools",y:20,x:20,width:n,items:r},this.gui.toolbar)):this.gui.toolbar&&this.gui.toolbar.renderTo&&(this.toolbar=Ext.create("Ext.toolbar.Toolbar",Ext.apply({cls:"oep-tools",width:this.gui.toolbar.width||n,items:r},this.gui.toolbar)))},createLayerControl:function(){this.gui.layerControl.y||(this.gui.layerControl.y=20),this.gui.layerControl.right||(this.gui.layerControl.right=20),this.gui.layerControl.style||(this.gui.layerControl.style="right: "+this.gui.layerControl.right+"px"),this.gui.layerControl.width||(this.gui.layerControl.width=300),this.gui.layerControl.maxHeight||(this.gui.layerControl.maxHeight=window.innerHeight-this.gui.layerControl.y-60),this.gui.addLayerControl.y||(this.gui.addLayerControl.y=this.gui.layerControl.y),this.gui.addLayerControl.right||(this.gui.addLayerControl.right=this.gui.layerControl.width+this.gui.layerControl.right),this.gui.addLayerControl.style||(this.gui.addLayerControl.style="right: "+this.gui.addLayerControl.right+"px"),this.gui.addLayerControl.width||(this.gui.addLayerControl.width=300),this.gui.addLayerControl.maxHeight||(this.gui.addLayerControl.maxHeight=window.innerHeight-this.gui.addLayerControl.y-56),this.layerControl=Ext.create("Ext.panel.Panel",{renderTo:this.gui.layerControl.renderTo,y:this.gui.layerControl.y,style:this.gui.layerControl.style,layout:{type:"vbox",align:"stretch"},width:this.gui.layerControl.width,maxHeight:this.gui.layerControl.maxHeight,border:!1,bodyStyle:{background:"transparent"}}),this.gui.layers&&(this.gui.layers&&"advanced"===this.gui.layers.type?(this.on({layerControlLoaded:function(){this.layerControlLoading=!1,this.addLayerControlLoading===!1?(this.mapLayers.setLoading(!1),this.addLayerControl.setLoading(!1)):(this.mapLayers.setLoading(!0),this.addLayerControl.setLoading(!0))},addLayerControlLoaded:function(){this.addLayerControlLoading=!1,this.layerControlLoading===!1?(this.mapLayers.setLoading(!1),this.addLayerControl.setLoading(!1)):(this.mapLayers.setLoading(!0),this.addLayerControl.setLoading(!0))}}),this.mapLayers=Ext.create("OpenEMap.view.layer.Advanced",Ext.apply({mapPanel:this.mapPanel,orginalConfig:this.orginalConfig,client:this.client,flex:1,gui:this},this.gui.layers)),this.addLayerControl=Ext.create("OpenEMap.view.layer.Add",{mapPanel:this.mapPanel,border:!1,renderTo:this.gui.addLayerControl.renderTo,y:this.gui.addLayerControl.y,style:this.gui.addLayerControl.style,width:this.gui.addLayerControl.width,maxHeight:this.gui.addLayerControl.maxHeight,collapsible:!0,dataHandler:this.dataHandler,metadataColumn:Ext.create("OpenEMap.action.MetadataInfoColumn",{metadataWindow:this.metadataWindow,dataHandler:this.dataHandler}),gui:this})):this.gui.layers&&"listconfigs"===this.gui.layers.type?(this.on({layerControlLoaded:function(){this.layerControlLoading=!1,this.mapLayers.setLoading(!1)}}),this.mapLayers=Ext.create("OpenEMap.view.layer.Advanced",Ext.apply({mapPanel:this.mapPanel,orginalConfig:this.orginalConfig,client:this.client,flex:1,gui:this},this.gui.layers))):(this.on({layerControlLoaded:function(){this.layerControlLoading=!1,this.mapLayers.setLoading(!1)}}),this.mapLayers=Ext.create("OpenEMap.view.layer.Basic",Ext.apply({mapPanel:this.mapPanel,client:this.client,flex:1,gui:this},this.gui.layers))),this.gui.layers.renderTo||this.layerControl.add(this.mapLayers)),this.gui.searchFastighet&&this.search&&(this.searchFastighet=Ext.create("OpenEMap.view.SearchFastighet",Ext.apply({mapPanel:this.mapPanel,basePath:this.config.basePath,search:this.search,collapsible:!0,height:120,width:this.gui.layerControl.width},this.gui.searchFastighet)),this.gui.searchFastighet.renderTo||this.layerControl.add(this.searchFastighet)),this.layerControl.items.getCount()<=0&&this.layerControl.destroy()},createBaseLayersPanel:function(){if(!this.map.allOverlays&&this.gui.baseLayers){var e=this.map.layers,t=Ext.create("OpenEMap.config.Parser"),a=t.extractBaseLayers(e);a&&(this.gui.baseLayers.renderTo||this.gui.baseLayers.style||(this.gui.baseLayers.style={right:"20px",bottom:"20px"}),this.baseLayers=Ext.create("OpenEMap.view.BaseLayers",Ext.apply({mapPanel:this.mapPanel,renderTo:this.gui.baseLayers.renderTo},this.gui.baseLayers)))}},createZoomToolPanel:function(){this.gui.zoomTools&&(this.gui.zoomTools.renderTo||this.gui.zoomTools.style||(this.gui.zoomTools.style={left:"20px",top:"76px"}),this.zoomTools=Ext.create("OpenEMap.view.ZoomTools",Ext.apply({mapPanel:this.mapPanel,renderTo:this.gui.zoomTools.renderTo,width:36},this.gui.zoomTools)))},createSearchCoordinatePanel:function(){this.gui.searchCoordinate&&this.gui.searchCoordinate.renderTo&&(this.searchCoordinate=Ext.create("OpenEMap.view.SearchCoordinate",Ext.apply({mapPanel:this.mapPanel},this.gui.searchCoordinate)))},createObjectConfigPanel:function(){this.gui.objectConfig&&(this.objectConfig=Ext.create("OpenEMap.view.ObjectConfig",Ext.apply({mapPanel:this.mapPanel,gui:this},this.gui.objectConfig)),this.objectConfigWindow=Ext.create("Ext.window.Window",Ext.apply({title:this.objectConfigWindowTitle,width:480,height:300,layout:"fit",closable:!1,collapsible:!0,items:this.objectConfig},this.gui.objectConfig)),this.objectConfigWindow.show())},createShowCoordinatePanel:function(){if(this.gui.showCoordinate&&this.gui.showCoordinate.renderTo){this.cls||(this.cls="oep-show-coordinate");var e={mapPanel:this.mapPanel,cls:this.cls,setCoord:function(e){var t=this.getLonLatFromPixel(e.xy),a=OpenEMap.mapClient.gui.showCoordinate.getComponent("e"),r=OpenEMap.mapClient.gui.showCoordinate.getComponent("n");a.setValue(Math.round(t.lon)),r.setValue(Math.round(t.lat))}};this.showCoordinate=Ext.create("OpenEMap.view.ShowCoordinate",Ext.apply(e,this.gui.showCoordinate)),this.map.events.register("mousemove",this.map,this.showCoordinate.setCoord)}},createScalebarPanel:function(){this.gui.scalebar&&(this.scalebar=Ext.create("OpenEMap.view.Scalebar",Ext.apply({mapPanel:this.mapPanel},this.gui.scalebar)))}}),Ext.define("OpenEMap.model.Server",{extend:Ext.data.Model,fields:["id","type","url","proxy"]}),Ext.define("OpenEMap.data.Servers",{extend:Ext.data.Store,model:"OpenEMap.model.Server",storeId:"servers",singelton:!0,constructor:function(e){e=Ext.apply(this,e),this.callParent([e])}}),Ext.define("OpenEMap.config.Parser",{constructor:function(e){Ext.apply(this,e),this.callParent(arguments)},parse:function(e){var t={fallThrough:!0,controls:["Navigation","KeyboardDefaults"],projection:"EPSG:3006",resolutions:[560,280,140,70,28,14,7,4.2,2.8,1.4,.56,.28,.14,.112,.056],extent:[608114,6910996,641846,6932596],maxExtent:[487e3,6855e3,749144,7149144],units:"m",municipalities:["Sundvsall","Timrå","Kramfors","Örnsköldsvik","Härnösand"]};t.resolutions=e.resolutions||t.resolutions,t.units=e.units||t.units,t.projection=e.projection||t.projection,t.maxExtent=e.maxExtent,t.extent=e.extent,t.municipalities=e.municipalities||t.municipalities,t.controls=t.controls.map(this.createControl),Ext.apply(t,e.map),r=e.layers.map(this.transformLayer);var a=this.parseLayerTree(r),r=this.extractLayers(a);r=this.sortBaseLayers(r),t.allOverlays=!r.some(this.isBaseLayer,this),t.layers=r.map(function(e){return e.layer}),t.layers=t.layers.filter(function(e){return e});var n=new OpenLayers.Map(t);return n.layerTree=a,n.layerSwitcherLayerTree=this.getLayerSwitcherLayers(a),n},sortBaseLayers:function(e){for(var t=e.filter(function(e){return e.layer&&e.layer.isBaseLayer}),a=e.filter(function(e){return!(e.layer&&e.layer.isBaseLayer)}),r=[],n=0;t.length>n;n++)t[n].visibility?r.unshift(t[n]):r.push(t[n]);return r.concat(a)},parseLayerTree:function(e){return e.forEach(this.iterateLayers,this),e},getLayerSwitcherLayers:function(e){return e.filter(function(e){return e.layers||this.isWMSLayer(e)&&!this.isBaseLayer(e)?!0:!1},this)},extractLayers:function(e){var t=e.filter(function(e){return!e.layers}),a=e.filter(function(e){return e.layers}).map(function(e){return e.layers}),r=[].concat.apply([],a);return e=t.concat(r),e.reverse(),e},extractPlainLayers:function(e){for(var t=[],a=0,r=e.length;r>a;a++)t.push(e[a]),e[a].layers&&(t=t.concat(this.extractPlainLayers(e[a].layers)));return t},extractWFS:function(e){return e=e.filter(function(e){return e.wfs&&e.wfs.url})},extractNoWFS:function(e){return e=e.filter(function(e){return!(e.wfs&&e.wfs.url)})},extractWMS:function(e){return e=e.filter(function(e){return e.wms&&e.wms.url})},extractClickableLayers:function(e){return e=e.filter(function(e){return e.clickable&&e.queryable})},extractVisibleLayers:function(e){return e=e.filter(function(e){return e.layer&&e.layer.visibility})},extractVector:function(e){return e=this.extractLayers(e),e=e.filter(function(e){return e.vector})},extractBaseLayers:function(e){return e=this.extractLayers(e),e=e.filter(function(e){return e.isBaseLayer})},extractPopupLayers:function(e){return e=this.extractLayers(e),e=e.filter(function(e){return e.popup?!0:!1}),e=e.filter(function(e){return e.visibility})},getOptions:function(e){return e.wms?e.wms.options:e.osm?e.osm.options:e.google?e.google.options:e.bing?e.bing.options:void 0},isOpenLayersLayer:function(e){return e.wms||e.osm||e.google||e.bing?!0:!1},isBaseLayer:function(e){var t=this.getOptions(e);return t&&t.isBaseLayer?!0:!1},createControl:function(e){return e.constructor==String?new OpenLayers.Control[e]:new OpenLayers.Control[e.type](e.options)},isWMSLayer:function(e){return e.wms?!0:!1},transformLayer:function(e){return e.url&&(e.wms={url:e.url,params:e.params,options:e.options}),e},createLayer:function(e){if(e.wms)return new OpenLayers.Layer.WMS(e.name,e.wms.url,e.wms.params,e.wms.options);if(e.osm)return new OpenLayers.Layer.OSM(e.name,e.osm.url,e.osm.options);if(e.google)return new OpenLayers.Layer.Google(e.name,e.google.options);if(e.bing)return new OpenLayers.Layer.Bing(Ext.apply({name:e.name},e.bing.options));throw new Error("Unknown layer type")},isLayerChecked:function(e){return e.isGroupLayer&&e.layers&&e.layers.length?e.layers.some(this.isLayerChecked,this):e.wms&&e.wms.options&&e.wms.options.visibility?e.wms.options.visibility:!1},iterateLayers:function(e){if(e.text=e.name,e.checked=this.isLayerChecked(e),"undefined"!=typeof e.serverId&&""!==e.serverId){var t=this.serverStore.getById(e.serverId);if(t){if(e.wms&&!e.wms.url){var a="/wms";e.wms.gwc&&(a="/gwc/service/wms"),e.wms.url=t.get("url")+a}e.wfs&&!e.wfs.url&&(e.wfs.url=t.get("url"))}}this.isOpenLayersLayer(e)&&(e.layer=this.createLayer(e),e.layer.queryable=e.queryable?e.queryable:!1),e.layers&&"[object Array]"===Object.prototype.toString.call(e.layers)&&e.layers.length>0?(e.isGroupLayer=!0,e.expanded=void 0===e.expanded?!0:e.expanded,e.toggleGroupEnabled=void 0===e.toggleGroupEnabled?!0:e.toggleGroupEnabled,e.layers.forEach(arguments.callee,this)):e.leaf=!0}}),Ext.define("OpenEMap.form.ZoomSelector",{extend:Ext.form.ComboBox,emptyText:"Zoom Level",listConfig:{getInnerTpl:function(){return"1: {scale:round(0)}"}},width:120,editable:!1,triggerAction:"all",queryMode:"local",initComponent:function(){this.store=Ext.create("GeoExt.data.ScaleStore",{map:this.map}),this.listeners={select:{fn:function(e,t,a){this.map.zoomTo(t[0].get("level"))},scope:this}},this.map.events.register("zoomend",this,function(){var e=this.store.queryBy(function(e){return this.map.getZoom()==e.data.level});if(e.length>0)e=e.items[0],this.setValue("1 : "+parseInt(e.data.scale));else{if(!zoomSelector.rendered)return;this.clearValue()}}),this.callParent(arguments)}}),Ext.define("OpenEMap.OpenLayers.Control.ModifyFeature",{}),OpenLayers.Control.ModifyFeature=OpenLayers.Class(OpenLayers.Control,{bySegment:!1,documentDrag:!1,geometryTypes:null,clickout:!0,toggle:!0,standalone:!1,layer:null,feature:null,vertex:null,vertices:null,virtualVertices:null,handlers:null,deleteCodes:null,virtualStyle:null,dragHandleStyle:null,radiusHandleStyle:null,vertexRenderIntent:null,mode:null,createVertices:!0,modified:!1,radiusHandle:null,dragHandle:null,onModificationStart:function(){},onModification:function(){},onModificationEnd:function(){},initialize:function(e,t){t=t||{},this.layer=e,this.vertices=[],this.virtualVertices=[],this.virtualStyle=OpenLayers.Util.extend({},this.layer.style||this.layer.styleMap.createSymbolizer(null,t.vertexRenderIntent)),this.virtualStyle.fillOpacity=.3,this.virtualStyle.strokeOpacity=.3,this.deleteCodes=[46,68],this.mode=OpenLayers.Control.ModifyFeature.RESHAPE,OpenLayers.Control.prototype.initialize.apply(this,[t]),OpenLayers.Util.isArray(this.deleteCodes)||(this.deleteCodes=[this.deleteCodes]);var a={down:function(e){this.vertex=null;var t=this.layer.getFeatureFromEvent(this.handlers.drag.evt);t?this.dragStart(t):this.clickout&&(this._unselect=this.feature)},move:function(e){delete this._unselect,this.vertex&&this.dragVertex(this.vertex,e)},up:function(){this.handlers.drag.stopDown=!1,this._unselect&&(this.unselectFeature(this._unselect),delete this._unselect)},done:function(e){this.vertex&&this.dragComplete(this.vertex)}},r=this,n={documentDrag:this.documentDrag,setEvent:function(e){var t=r.feature;r._lastVertex=t?t.layer.getFeatureFromEvent(e):null,OpenLayers.Handler.Drag.prototype.setEvent.apply(this,arguments)},stopDown:!1},i={keydown:this.handleKeypress};if(this.handlers={keyboard:new OpenLayers.Handler.Keyboard(this,i),drag:new OpenLayers.Handler.Drag(this,a,n)},this.bySegment){if(!window.rbush)throw new Error("The rbush library is required");if(!OpenLayers.Control.ModifyFeature.BySegment)throw new Error("OpenLayers.Control.ModifyFeature.BySegment is missing from the build");OpenLayers.Util.extend(this,OpenLayers.Control.ModifyFeature.BySegment)}},createVirtualVertex:function(e,t){var a=(e.x+t.x)/2,r=(e.y+t.y)/2,n=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(a,r),null,this.virtualStyle);return n._sketch=!0,n},destroy:function(){this.map&&this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),this.layer=null,OpenLayers.Control.prototype.destroy.apply(this,[])},activate:function(){return OpenLayers.Control.prototype.activate.apply(this,arguments)?(this.moveLayerToTop(),this.map.events.on({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),this._lastVertex=null,this.handlers.keyboard.activate()&&this.handlers.drag.activate()):!1},deactivate:function(){var e=!1;if(OpenLayers.Control.prototype.deactivate.apply(this,arguments)){this.moveLayerBack(),this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),this.layer.removeFeatures(this.vertices,{silent:!0}),this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.vertices=[],this.handlers.drag.deactivate(),this.handlers.keyboard.deactivate();var t=this.feature;t&&t.geometry&&t.layer&&this.unselectFeature(t),e=!0}return e},beforeSelectFeature:function(e){return this.layer.events.triggerEvent("beforefeaturemodified",{feature:e})},selectFeature:function(e){if(!(this.feature===e||this.geometryTypes&&-1==OpenLayers.Util.indexOf(this.geometryTypes,e.geometry.CLASS_NAME))){this.beforeSelectFeature(e)!==!1&&(this.feature&&this.unselectFeature(this.feature),this.feature=e,this.layer.selectedFeatures.push(e),this.layer.drawFeature(e,"select"),this.modified=!1,this.resetVertices(),this.onModificationStart(this.feature));var t=e.modified;!e.geometry||t&&t.geometry||(this._originalGeometry=e.geometry.clone())}},unselectFeature:function(e){this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[],this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),delete this.dragHandle),this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),delete this.radiusHandle),this.layer.drawFeature(this.feature,"default"),this.feature=null,OpenLayers.Util.removeItem(this.layer.selectedFeatures,e),this.onModificationEnd(e),this.layer.events.triggerEvent("afterfeaturemodified",{feature:e,modified:this.modified}),this.modified=!1},dragStart:function(e){var t="OpenLayers.Geometry.Point"==e.geometry.CLASS_NAME;this.standalone||(e._sketch||!t)&&e._sketch||(this.toggle&&this.feature===e&&(this._unselect=e),this.selectFeature(e)),this.feature&&(e._sketch||t&&e===this.feature)&&(this.vertex=e,this.handlers.drag.stopDown=!0)},dragVertex:function(e,t){var a=this.map.getLonLatFromViewPortPx(t),r=e.geometry;r.move(a.lon-r.x,a.lat-r.y),this.modified=!0,"OpenLayers.Geometry.Point"==this.feature.geometry.CLASS_NAME?this.layer.events.triggerEvent("vertexmodified",{vertex:e.geometry,feature:this.feature,pixel:t}):(e._index?(-1==e._index&&(e._index=OpenLayers.Util.indexOf(e.geometry.parent.components,e._next)),e.geometry.parent.addComponent(e.geometry,e._index),delete e._index,OpenLayers.Util.removeItem(this.virtualVertices,e),this.vertices.push(e)):e==this.dragHandle?(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null)):e!==this.radiusHandle&&this.layer.events.triggerEvent("vertexmodified",{vertex:e.geometry,feature:this.feature,pixel:t}),this.virtualVertices.length>0&&(this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.layer.drawFeature(this.feature,this.standalone?void 0:"select")),this.layer.drawFeature(e)},dragComplete:function(e){this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{
feature:this.feature})},setFeatureState:function(){if(this.feature.state!=OpenLayers.State.INSERT&&this.feature.state!=OpenLayers.State.DELETE&&(this.feature.state=OpenLayers.State.UPDATE,this.modified&&this._originalGeometry)){var e=this.feature;e.modified=OpenLayers.Util.extend(e.modified,{geometry:this._originalGeometry}),delete this._originalGeometry}},resetVertices:function(){this.vertices.length>0&&(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[]),this.virtualVertices.length>0&&(this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),this.dragHandle=null),this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null),this.feature&&"OpenLayers.Geometry.Point"!=this.feature.geometry.CLASS_NAME&&(this.mode&OpenLayers.Control.ModifyFeature.DRAG&&this.collectDragHandle(),this.mode&(OpenLayers.Control.ModifyFeature.ROTATE|OpenLayers.Control.ModifyFeature.RESIZE)&&this.collectRadiusHandle(),this.mode&OpenLayers.Control.ModifyFeature.RESHAPE&&(this.mode&OpenLayers.Control.ModifyFeature.RESIZE||this.collectVertices()))},handleKeypress:function(e){var t=e.keyCode;if(this.feature&&-1!=OpenLayers.Util.indexOf(this.deleteCodes,t)){var a=this._lastVertex;a&&-1!=OpenLayers.Util.indexOf(this.vertices,a)&&!this.handlers.drag.dragging&&a.geometry.parent&&(a.geometry.parent.removeComponent(a.geometry),this.layer.events.triggerEvent("vertexremoved",{vertex:a.geometry,feature:this.feature,pixel:e.xy}),this.layer.drawFeature(this.feature,this.standalone?void 0:"select"),this.modified=!0,this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature}))}},collectVertices:function(){function e(a){var r,n,i,s;if("OpenLayers.Geometry.Point"==a.CLASS_NAME)n=new OpenLayers.Feature.Vector(a),n._sketch=!0,n.renderIntent=t.vertexRenderIntent,t.vertices.push(n);else{var o=a.components.length;for("OpenLayers.Geometry.LinearRing"==a.CLASS_NAME&&(o-=1),r=0;o>r;++r)i=a.components[r],"OpenLayers.Geometry.Point"==i.CLASS_NAME?(n=new OpenLayers.Feature.Vector(i),n._sketch=!0,n.renderIntent=t.vertexRenderIntent,t.vertices.push(n)):e(i);if(t.createVertices&&"OpenLayers.Geometry.MultiPoint"!=a.CLASS_NAME)for(r=0,s=a.components.length;s-1>r;++r){var l=a.components[r],d=a.components[r+1];if("OpenLayers.Geometry.Point"==l.CLASS_NAME&&"OpenLayers.Geometry.Point"==d.CLASS_NAME){var c=t.createVirtualVertex.call(t,l,d);c.geometry.parent=a,c._index=r+1,t.virtualVertices.push(c)}}}}this.vertices=[],this.virtualVertices=[];var t=this;e.call(this,this.feature.geometry),this.layer.addFeatures(this.virtualVertices,{silent:!0}),this.layer.addFeatures(this.vertices,{silent:!0})},collectDragHandle:function(){var e=this.feature.geometry,t=e.getBounds().getCenterLonLat(),a=new OpenLayers.Geometry.Point(t.lon,t.lat),r=new OpenLayers.Feature.Vector(a,null,this.dragHandleStyle);a.move=function(t,a){OpenLayers.Geometry.Point.prototype.move.call(this,t,a),e.move(t,a)},r._sketch=!0,this.dragHandle=r,this.dragHandle.renderIntent=this.vertexRenderIntent,this.layer.addFeatures([this.dragHandle],{silent:!0})},collectRadiusHandle:function(){var e=this.feature.geometry,t=e.getBounds(),a=t.getCenterLonLat(),r=new OpenLayers.Geometry.Point(a.lon,a.lat),n=new OpenLayers.Geometry.Point(t.right,t.bottom),i=new OpenLayers.Feature.Vector(n,null,this.radiusHandleStyle),s=this.mode&OpenLayers.Control.ModifyFeature.RESIZE,o=this.mode&OpenLayers.Control.ModifyFeature.RESHAPE,l=this.mode&OpenLayers.Control.ModifyFeature.ROTATE;n.move=function(t,a){OpenLayers.Geometry.Point.prototype.move.call(this,t,a);var n=this.x-r.x,i=this.y-r.y,d=n-t,c=i-a;if(l){var p=Math.atan2(c,d),u=Math.atan2(i,n),h=u-p;h*=180/Math.PI,e.rotate(h,r)}if(s){var y,m;if(o)y=i/c,m=n/d/y;else{var g=Math.sqrt(d*d+c*c),f=Math.sqrt(n*n+i*i);y=f/g}e.resize(y,r,m)}},i._sketch=!0,this.radiusHandle=i,this.radiusHandle.renderIntent=this.vertexRenderIntent,this.layer.addFeatures([this.radiusHandle],{silent:!0})},setMap:function(e){this.handlers.drag.setMap(e),OpenLayers.Control.prototype.setMap.apply(this,arguments)},handleMapEvents:function(e){("removelayer"==e.type||"order"==e.property)&&this.moveLayerToTop()},moveLayerToTop:function(){var e=Math.max(this.map.Z_INDEX_BASE.Feature-1,this.layer.getZIndex())+1;this.layer.setZIndex(e)},moveLayerBack:function(){var e=this.layer.getZIndex()-1;e>=this.map.Z_INDEX_BASE.Feature?this.layer.setZIndex(e):this.map.setLayerZIndex(this.layer,this.map.getLayerIndex(this.layer))},CLASS_NAME:"OpenLayers.Control.ModifyFeature"}),OpenLayers.Control.ModifyFeature.RESHAPE=1,OpenLayers.Control.ModifyFeature.RESIZE=2,OpenLayers.Control.ModifyFeature.ROTATE=4,OpenLayers.Control.ModifyFeature.DRAG=8,Ext.define("OpenEMap.OpenLayers.Control.DynamicMeasure",{}),OpenLayers.Control.DynamicMeasure=OpenLayers.Class(OpenLayers.Control.Measure,{accuracy:2,persist:!1,styles:null,positions:null,maxSegments:1,maxHeadings:1,layerSegmentsOptions:void 0,layerHeadingOptions:null,layerLengthOptions:void 0,layerAreaOptions:void 0,drawingLayer:null,multi:!1,layerSegments:null,layerLength:null,layerArea:null,dynamicObj:null,isArea:null,initialize:function(e,t){if(t=t||{},t.handlerOptions=OpenLayers.Util.extend({persist:!t.drawingLayer},t.handlerOptions),!t.drawingLayer||"multi"in t.handlerOptions||(t.handlerOptions.multi=t.multi),t.drawingLayer){var a=t.drawingLayer.styleMap&&t.drawingLayer.styleMap.styles.temporary;a&&(t.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(t.handlerOptions.layerOptions,{styleMap:new OpenLayers.StyleMap({"default":a})}))}var r=t.styles||{};t.styles=r;var n=OpenLayers.Control.DynamicMeasure.styles;if(!t.handlerOptions.layerOptions||!t.handlerOptions.layerOptions.styleMap){var i=OpenLayers.Util.applyDefaults(r.Point,n.Point),s=OpenLayers.Util.applyDefaults(r.Line,n.Line),o=OpenLayers.Util.applyDefaults(r.Polygon,n.Polygon),l=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:i,Line:s,Polygon:o}})]});t.handlerOptions=t.handlerOptions||{},t.handlerOptions.layerOptions=t.handlerOptions.layerOptions||{},t.handlerOptions.layerOptions.styleMap=new OpenLayers.StyleMap({"default":l})}t.positions=OpenLayers.Util.applyDefaults(t.positions,OpenLayers.Control.DynamicMeasure.positions),t.callbacks=t.callbacks||{},t.drawingLayer&&OpenLayers.Util.applyDefaults(t.callbacks,{create:function(e,t){this.callbackCreate(e,t),this.drawingLayer.events.triggerEvent("sketchstarted",{vertex:e,feature:t})},modify:function(e,t){this.callbackModify(e,t),this.drawingLayer.events.triggerEvent("sketchmodified",{vertex:e,feature:t})},done:function(e){this.callbackDone(e),this.drawFeature(e)}}),OpenLayers.Util.applyDefaults(t.callbacks,{create:this.callbackCreate,point:this.callbackPoint,cancel:this.callbackCancel,done:this.callbackDone,modify:this.callbackModify,redo:this.callbackRedo,undo:this.callbackUndo});var d=document.onselectstart?document.onselectstart:OpenLayers.Function.True,c=OpenLayers.Class(e,{down:function(t){return document.onselectstart=OpenLayers.Function.False,e.prototype.down.apply(this,arguments)},up:function(t){return document.onselectstart=d,e.prototype.up.apply(this,arguments)},move:function(t){return this.mouseDown||(document.onselectstart=d),e.prototype.move.apply(this,arguments)},mouseout:function(t){return OpenLayers.Util.mouseLeft(t,this.map.viewPortDiv)&&this.mouseDown&&(document.onselectstart=d),e.prototype.mouseout.apply(this,arguments)},finalize:function(){document.onselectstart=d,e.prototype.finalize.apply(this,arguments)}},{undo:function(){var t=e.prototype.undo.call(this);return t&&this.callback("undo",[this.point.geometry,this.getSketch(),!0]),t},redo:function(){var t=e.prototype.redo.call(this);return t&&this.callback("redo",[this.point.geometry,this.getSketch(),!0]),t}});OpenLayers.Control.Measure.prototype.initialize.call(this,c,t),this.isArea=void 0!==e.prototype.polygon},destroy:function(){this.deactivate(),OpenLayers.Control.Measure.prototype.destroy.apply(this,arguments)},draw:function(){},activate:function(){var e=OpenLayers.Control.Measure.prototype.activate.apply(this,arguments);if(e){this.dynamicObj={};var t=this.styles||{},a=OpenLayers.Control.DynamicMeasure.styles,r=this,n=function(e,n){if(null===n)return null;var i=OpenLayers.Util.extend({displayInLayerSwitcher:!1,calculateInRange:OpenLayers.Function.True},n);if(!i.styleMap){var s=t[e];i.styleMap=new OpenLayers.StyleMap({"default":OpenLayers.Util.applyDefaults(s,a[e])})}var o=new OpenLayers.Layer.Vector(r.CLASS_NAME+" "+e,i);return r.map.addLayer(o),r.map.setLayerIndex(o,99),o};this.layerSegments=n("labelSegments",this.layerSegmentsOptions),this.layerHeading=n("labelHeading",this.layerHeadingOptions),this.layerLength=n("labelLength",this.layerLengthOptions),this.isArea&&(this.layerArea=n("labelArea",this.layerAreaOptions))}return e},deactivate:function(){var e=OpenLayers.Control.Measure.prototype.deactivate.apply(this,arguments);return e&&(this.layerSegments&&this.layerSegments.destroy(),this.layerLength&&this.layerLength.destroy(),this.layerHeading&&this.layerHeading.destroy(),this.layerArea&&this.layerArea.destroy(),this.dynamicObj=null,this.layerSegments=null,this.layerLength=null,this.layerHeading=null,this.layerArea=null),e},setImmediate:function(e){this.immediate=e},callbackCreate:function(){var e=this.dynamicObj;e.drawing=!1,e.freehand=!1,e.fromIndex=0,e.countSegments=0},callbackCancel:function(){this.destroyLabels()},callbackDone:function(e){var t=new OpenLayers.Feature.Vector(e);this.mapPanel.measureLayer.addFeatures([t.clone()]);var a=function(e){return e.clone()};this.layerArea&&this.mapPanel.measureLayerArea.addFeatures(this.layerArea.features.map(a)),this.mapPanel.measureLayerLength.addFeatures(this.layerLength.features.map(a)),this.mapPanel.measureLayerSegments.addFeatures(this.layerSegments.features.map(a)),this.measureComplete(e),this.persist||this.destroyLabels()},drawFeature:function(e){var t=new OpenLayers.Feature.Vector(e),a=this.drawingLayer.events.triggerEvent("sketchcomplete",{feature:t});a!==!1&&(t.state=OpenLayers.State.INSERT,this.featureAdded&&this.featureAdded(t),this.events.triggerEvent("featureadded",{feature:t}))},destroyLabels:function(){this.layerSegments&&this.layerSegments.destroyFeatures(null,{silent:!0}),this.layerLength&&this.layerLength.destroyFeatures(null,{silent:!0}),this.layerHeading&&this.layerHeading.destroyFeatures(null,{silent:!0}),this.layerArea&&this.layerArea.destroyFeatures(null,{silent:!0})},callbackPoint:function(e,t){var a=this.dynamicObj;a.drawing||this.destroyLabels(),this.handler.freehandMode(this.handler.evt)?a.freehand||(a.fromIndex=this.handler.getCurrentPointIndex()-1,a.freehand=!0,a.countSegments++):(a.fromIndex=this.handler.getCurrentPointIndex()-1,a.freehand=!1,a.countSegments++),this.measurePartial(e,t),a.drawing=!0},callbackUndo:function(e,t){var a=this,r=function(e){if(e){var t=e.features,r=t.length-1,n=t[r],i=n.attributes.from,s=a.handler.getCurrentPointIndex();if(i>=s){var o=a.dynamicObj;e.destroyFeatures(n),n=t[r-1],o.fromIndex=n.attributes.from,o.countSegments=t.length}}};r(this.layerSegments),r(this.layerHeading),this.callbackModify(e,t,!0)},callbackRedo:function(e,t){var a=this.handler.line.geometry,r=this.handler.getCurrentPointIndex(),n=this.dynamicObj;this.showLabelSegment(n.countSegments,n.fromIndex,a.components.slice(n.fromIndex,r)),n.fromIndex=this.handler.getCurrentPointIndex()-1,n.countSegments++,this.callbackModify(e,t,!0)},callbackModify:function(e,t,a){this.immediate&&this.measureImmediate(e,t,a);var r=this.dynamicObj;if(r.drawing!==!1){var n=this.handler.line.geometry,i=this.handler.getCurrentPointIndex();!this.handler.freehandMode(this.handler.evt)&&r.freehand&&(r.fromIndex=i-1,r.freehand=!1,r.countSegments++);var s=this.getBestLength(n);if(s[0]){var o=this.positions,l={center:function(){var a=t.geometry.getBounds().clone();return a.extend(e),a=a.getCenterLonLat(),[a.lon,a.lat]},initial:function(){var e=n.components[0];return[e.x,e.y]},start:function(){var e=n.components[r.fromIndex];return[e.x,e.y]},middle:function(){var t=n.components[r.fromIndex];return[(t.x+e.x)/2,(t.y+e.y)/2]},end:function(){return[e.x,e.y]}};this.layerLength&&this.showLabel(this.layerLength,1,0,s,l[o.labelLength](),1),this.isArea&&(this.layerArea&&this.showLabel(this.layerArea,1,0,this.getBestArea(t.geometry),l[o.labelArea](),1),this.showLabelSegment(1,0,[n.components[0],n.components[i]])&&r.countSegments++),this.showLabelSegment(r.countSegments,r.fromIndex,n.components.slice(r.fromIndex,i+1))}}},showLabelSegment:function(e,t,a){var r=this.layerSegments,n=this.layerHeading;if(!r&&!n)return!1;for(var i=[],s=a.length,o=0;s>o;o++)i.push(a[o].clone());var l=i[0],d=i[s-1],c=this.getBestLength(new OpenLayers.Geometry.LineString(i)),p=this.positions,u={start:function(){return[l.x,l.y]},middle:function(){return[(l.x+d.x)/2,(l.y+d.y)/2]},end:function(){return[d.x,d.y]}},h=!1;if(r&&(h=this.showLabel(r,e,t,c,u[p.labelSegments](),this.maxSegments)),n&&c[0]>0){var y=Math.atan2(d.y-l.y,d.x-l.x),m=90-180*y/Math.PI;0>m&&(m+=360),h=h||this.showLabel(n,e,t,[m,"°"],u[p.labelHeading](),this.maxHeadings)}return h},showLabel:function(e,t,a,r,n,i){var s,o,l=e.features;if(l.length<t){if(0===r[0])return!1;if(s=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(n[0],n[1]),{from:a}),this.setMesureAttributes(s.attributes,r),e.addFeatures([s]),null!==i){var d=l.length-i-1;d>=0&&(o=l[d],o.style={display:"none"},e.drawFeature(o))}return!0}s=l[t-1];var c=s.geometry;if(c.x=n[0],c.y=n[1],c.clearBounds(),this.setMesureAttributes(s.attributes,r),e.drawFeature(s),null!==i){var p=l.length-i;p>=0&&(o=l[p],o.style&&(delete o.style,e.drawFeature(o)))}return!1},setMesureAttributes:function(e,t){e.measure=OpenLayers.Number.format(t[0].toFixed(this.accuracy),null),e.units=t[1]},CLASS_NAME:"OpenLayers.Control.DynamicMeasure"}),OpenLayers.Control.DynamicMeasure.styles={Point:{pointRadius:0,graphicName:"square",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#333333"},Line:{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",strokeDashstyle:"solid",fillColor:"white",fillOpacity:.3},labelSegments:{pointRadius:0,label:"${measure} ${units}",fontSize:"12px",fontColor:"#800517",fontFamily:"Verdana",labelOutlineColor:"#eeeeee",labelAlign:"cm",labelOutlineWidth:2},labelLength:{pointRadius:0,label:"${measure} ${units}\n",fontSize:"12px",fontWeight:"bold",fontColor:"#800517",fontFamily:"Verdana",labelOutlineColor:"#eeeeee",labelAlign:"lb",labelOutlineWidth:3},labelArea:{pointRadius:0,label:"${measure}\n${units}²\n",fontSize:"11px",fontWeight:"bold",fontColor:"#800517",fontFamily:"Verdana",labelOutlineColor:"#dddddd",labelAlign:"cm",labelOutlineWidth:3},labelHeading:{pointRadius:0,label:"${measure} ${units}",fontSize:"11px",fontColor:"#800517",fontFamily:"Verdana",labelOutlineColor:"#dddddd",labelAlign:"cm",labelOutlineWidth:3}},OpenLayers.Control.DynamicMeasure.positions={labelSegments:"middle",labelLength:"end",labelArea:"center",labelHeading:"start"},Ext.define("OpenEMap.Client",{version:"1.6.3-hf.1",map:null,drawLayer:void 0,configure:function(e,t){t=Ext.apply({},t),this.initialConfig=Ext.clone(e),this.initialOptions=Ext.clone(t),Ext.tip.QuickTipManager.init();var a=Ext.create("OpenEMap.config.Parser"),r=e.gui||{};Ext.merge(r,t.gui),this.map=a.parse(e),this.gui=Ext.create("OpenEMap.Gui",{config:e,gui:r,map:this.map,client:this,orginalConfig:this.initialConfig}),this.mapPanel=this.gui.mapPanel,this.drawLayer=this.gui.mapPanel.drawLayer,this.gui.controlToActivate&&this.gui.controlToActivate.activate(),t.callback&&t.callback.call(this)},getPermalinkdata:function(){var e=this.drawLayer.features,t=new OpenLayers.Format.GeoJSON,a=t.write(e);return{version:this.version,config:this.getConfig(),options:this.initialOptions,extent:this.map.getExtent().toArray(),drawLayer:{geojson:a}}},getConfig:function(e){return this.gui.mapLayers.getConfig(e)},encode:function(e){return JSON.stringify(this.mapPanel.encode(e))},addGeoJSON:function(e){var t=new OpenLayers.Format.GeoJSON,a=t.read(e,"Feature");if(a.attributes.config){var r=Ext.create("OpenEMap.ObjectFactory");a=r.create(a.attributes.config,a.attributes)}this.drawLayer.addFeatures([a])},setSketchStyleMap:function(e){this.map.controls.forEach(function(t){t instanceof OpenLayers.Control.DrawFeature&&(t.handler.layerOptions.styleMap=e,t.handler.layer&&(t.handler.layer.styleMap=e))})},toggleEdgeLabels:function(e,t){function a(e){return!isNaN(e)&&parseInt(Number(e))==e&&!isNaN(parseInt(e,10))}var r=e||{};a(t)||(t=2);var n=function(){var e=function(e){var a=e.geometry;if("OpenLayers.Geometry.Polygon"!=a.CLASS_NAME)return[];var n=a.components[0],i=n.components.slice(0,n.components.length-1).map(function(e,a){var i=n.components[a].clone(),s=n.components[a+1].clone(),o=new OpenLayers.Geometry.LineString([i,s]),l=o.getCentroid({weighted:!0}),d=Ext.applyIf(Ext.clone(r),{label:o.getLength().toFixed(t).toString()+" m",strokeColor:"#000000",strokeWidth:0,labelAlign:"cm",pointRadius:0}),c=new OpenLayers.Feature.Vector(l,null,d);return c});return i};this.labelLayer&&this.labelLayer.destroyFeatures();var a=this.drawLayer.features.map(e);if(a.length>0){var n=a.reduce(function(e,t){return e.concat(t)});this.labelLayer.addFeatures(n)}};void 0===this.labelLayer&&(this.labelLayer=new OpenLayers.Layer.Vector,this.map.addLayer(this.labelLayer),this.drawLayer.events.on({featuremodified:n,vertexmodified:n,featuresadded:n,featuresremoved:n,scope:this})),n.apply(this)},addPopupLayer:function(e,t,a,r,n,i,s,o,l,d){e||Ext.Error.raise("GeoJSON-string is null."),t||(t="VectorLayer"),a||(a="id"),n||(n=""),i||(i=""),s||(s=null),l||(l="EPSG:3006"),Proj4js.defs[l]||Ext.Error.raise("Unknown coordinate system: "+l+"\nAdd coordinate system using proj4.defs('Name', 'Definition')"),null===d&&(d=!0);var c=new OpenLayers.Format.GeoJSON,p=l,u=this.map.projection;c.internalProjection=new OpenLayers.Projection(u),c.externalProjection=new OpenLayers.Projection(p);var h=c.read(e,"FeatureCollection");h||Ext.Error.raise("Can not read features from GeoJSON due to malformed syntax.");var y=OpenLayers.Util.getParameters(window.location.href).renderer;y=y?[y]:OpenLayers.Layer.Vector.prototype.renderers;var m=new OpenLayers.Layer.Vector(t,{renderers:y,idAttribute:a,popupTextAttribute:r,popupTextPrefix:n,popupTextSuffix:i,popupTitleAttribute:s});m||Ext.Error.raise("Can not create popup layer: "+t),o&&(m.styleMap=o),this.map.addLayer(m),m.addFeatures(h);var g=new OpenLayers.Bounds;return h.forEach(function(e){e.renderIntent="default",g.extend(e.geometry.getBounds()),m.drawFeature(e)}),m.popup=[],d&&m.map.zoomToExtent(g),m},removePopupLayer:function(e){e.popup&&(e.popup.forEach(function(e){e.destroy(),e=null}),e.popup=[]),e.map.removeLayer(e)},showPopupFeaturePopup:function(e,t){e.popup&&e.popup.forEach(function(e){e.destroy()});var a=e.popupTextPrefix+t.attributes[e.popupTextAttribute]+e.popupTextSuffix,r="";e.popupTitleAttribute&&(r=t.attributes[e.popupTitleAttribute]);var n=new OpenEMap.view.PopupResults({mapPanel:this.gui.mapPanel,location:t,popupText:a,feature:t,title:r});n.show(),e.popup.push(n)},showPopupFeature:function(e,t,a){e||Ext.Error.raise("Popup layer undefined."),t||Ext.Error.raise("Feature id undefined.");var r=e.getFeaturesByAttribute(e.idAttribute,t);if(r)if(1==r.length){var n=Ext.create("OpenEMap.config.Parser"),i=n.extractPopupLayers(e.map.layers);if(i.forEach(function(e){e.features.forEach(function(t){"select"==t.renderIntent&&(t.renderIntent="default",t.layer.drawFeature(t),t.layer.map.events.triggerEvent("popupfeatureunselected",{layer:e,featureid:t.attributes[e.idAttribute]}))}),e.popup.forEach(function(e){e.destroy()})}),"undefined"!=typeof e.popupTextAttribute&&null!==e.popupTextAttribute&&this.showPopupFeaturePopup(e,r[0]),r[0].renderIntent="select",a){var s=r[0].geometry.getCentroid();r[0].layer.map.setCenter([s.x,s.y])}r[0].layer.drawFeature(r[0]),r[0].layer.map.events.triggerEvent("popupfeatureselected",{layer:e,featureid:r[0].attributes[e.idAttribute]})}else Ext.Error.raise("More then one feature with specified id: "+t);else Ext.Error.raise("No feature with specified id: "+t)},destroyPopupLayers:function(){var e=Ext.create("OpenEMap.config.Parser"),t=e.extractPopupLayers(this.map.layers),a=this;t&&t.forEach(function(e){a.removePopupLayer(e)})},zoomToAllPopupLayers:function(){var e=Ext.create("OpenEMap.config.Parser"),t=e.extractPopupLayers(this.map.layers);if(t.length>0){var a=new OpenLayers.Bounds;t.forEach(function(e){a.extend(e.getDataExtent())}),t[0].map.zoomToExtent(a.scale(1.1,a.getCenterPixel()))}},destroy:function(){this.map&&(this.map.controls&&(this.map.controls.forEach(function(e){e.destroy()}),this.map.controls=null),this.map.layers&&this.destroyPopupLayers()),this.gui&&this.gui.destroy()}}),Ext.ns("OpenEMap"),Ext.apply(OpenEMap,{lmUser:"sundsvall",basePathMapFish:"/print/pdf",basePathLM:"/search/lm/",basePathES:"/search/es/",basePathImages:"resources/images/",basePathWMS:"/geoserver/wms",wmsURLs:{basePath:"/geoserver/wms",url:"https://extmaptest.sundsvall.se/geoserver/wms",getCapabilities:"https://extmaptest.sundsvall.se/getcapabilities/wms.xml"},basePathProxy:"/cgi-bin/proxy.py?url=",wsUrls:{basePath:"/openemapadmin",permalinks:"/openemappermalink/permalinks",configs:"/configs",adminconfigs:"/adminconfigs",servers:"settings/servers",layers:"layers/layers",metadata:"geometadata/getmetadatabyid",metadata_abstract:"geometadata/getabstractbyid"},username:null}),Ext.apply(OpenEMap,{requestLM:function(e){e.url=OpenEMap.basePathLM+e.url+"&lmuser="+OpenEMap.lmUser,Ext.Ajax.request(e)}}),OpenLayers.Layer.Vector.prototype.renderers=["Canvas","SVG","VML"],OpenLayers.DOTS_PER_INCH=90.71446714322,Ext.define("OpenEMap.locale.sv_SE.Gui",{override:"OpenEMap.Gui",objectConfigWindowTitle:"Objektkonfiguration"}),Ext.define("OpenEMap.locale.sv_SE.view.ObjectConfig",{override:"OpenEMap.view.ObjectConfig",typeLabel:"Typ",widthLabel:"Bredd",lengthLabel:"Längd",m1Label:"M1",m2Label:"M2",angleLabel:"Vinkel"}),Ext.define("OpenEMap.Search",{constructor:function(e){initConfig()},doSearch:function(){}});