Ext.define("OpenEMap.action.Action",{extend:GeoExt.Action,constructor:function(d){var c=d.mapPanel.map;if(d.minScale||d.maxScale){d.minScale||(d.minScale=0),d.maxScale||(d.maxScale=99999999999999),c.events.register("zoomend",this,function(){c.getScale()>=d.maxScale||c.getScale()<=d.minScale?this.disable():this.enable()})}this.callParent(arguments)},toggle:function(){}});Ext.define("OpenEMap.action.MeasureArea",{extend:OpenEMap.action.Action,constructor:function(b){b.control=new OpenLayers.Control.DynamicMeasure(OpenLayers.Handler.Polygon,{mapPanel:b.mapPanel});
b.iconCls=b.iconCls||"action-measurearea";b.tooltip=b.tooltip||"M\x26auml;t area";b.toggleGroup="extraTools";this.callParent(arguments)}});Ext.define("OpenEMap.action.Print",{extend:OpenEMap.action.Action,constructor:function(t){var s=t.mapPanel.plugins[0],r=s.printProvider;r.customParams={attribution:t.mapPanel.config.attribution.trim()};var q=null,p=null,n=function(){q.down("#scale").select(p.scale)},o=function(){q&&q.setLoading(!1)},m=function(d,c){q&&q.setLoading(!1);Ext.Msg.show({title:"Felmeddelande",msg:"Print failed.\n\n"+c.responseText,icon:Ext.Msg.ERROR})
},l=function(){r.un("beforedownload",o);r.on("printexception",m);s.control.events.unregister("transformcomplete",null,n);s.removePage(p);s.hide();q=null;i.deactivate()};t.iconCls=t.iconCls||"action-print";t.tooltip=t.tooltip||"Skriv ut";t.toggleGroup="extraTools";var i=new (OpenLayers.Class(OpenLayers.Control,{initialize:function(b){OpenLayers.Control.prototype.initialize.apply(this,arguments)},type:OpenLayers.Control.TYPE_TOGGLE,activate:function(){if(!q){s.hide();s.show();p=s.addPage();r.dpis.data.items.forEach(function(c){"56"===c.data.name?c.data.name="L\u00e5g":"127"===c.data.name?c.data.name="Medel":"254"===c.data.name&&(c.data.name="H\u00f6g")
});r.layouts.data.items.forEach(function(c){/landscape$/.test(c.data.name)?c.data.displayName=c.data.name.replace("landscape","liggande"):/portrait$/.test(c.data.name)&&(c.data.displayName=c.data.name.replace("portrait","st\u00e5ende"))});q=new Ext.Window({autoHeight:!0,width:290,resizable:!1,layout:"fit",bodyPadding:"5 5 0",title:"Utskriftsinst\x26auml;llningar",listeners:{close:l},items:[{xtype:"form",layout:"anchor",defaults:{anchor:"100%"},fieldDefaults:{labelWidth:120},items:[{xtype:"combo",fieldLabel:"Pappersformat",store:r.layouts,displayField:"displayName",valueField:"name",itemId:"printLayouts",queryMode:"local",value:r.layouts.getAt(0).get("name"),listeners:{select:function(d,c){r.setLayout(c[0])
}}},{xtype:"combo",fieldLabel:"Kvalit\u00e9",store:r.dpis,displayField:"name",valueField:"value",queryMode:"local",value:r.dpis.first().get("value"),listeners:{select:function(d,c){r.setDpi(c[0])}}},{xtype:"combo",fieldLabel:"Skala",store:r.scales,displayField:"name",valueField:"value",queryMode:"local",itemId:"scale",value:r.scales.first().get("value"),listeners:{select:function(d,c){p.setScale(c[0],"m")}}}]}],bbar:["-\x3e",{text:"Skriv ut",handler:function(){q.setLoading(!0);s.print()}}]});q.show();
q.down("#scale").select(p.scale);var b=q.down("#printLayouts");b.select(b.store.data.get(6));r.setLayout(b.store.data.items[6]);s.control.events.register("transformcomplete",null,n);s.control.events.register("transformcomplete",null,n);r.on("beforedownload",o);r.on("printexception",m);OpenLayers.Control.prototype.activate.apply(this,arguments)}},deactivate:function(){q&&q.close();OpenLayers.Control.prototype.deactivate.apply(this,arguments)}}))({type:OpenLayers.Control.TYPE_TOGGLE});t.control=i;this.callParent(arguments)
}});Ext.define("OpenEMap.action.DrawGeometry",{extend:OpenEMap.action.Action,isText:function(b){return b&&("Point"===b.geometry||b.geometry instanceof OpenLayers.Geometry.Point)?b.attributes&&b.attributes.type&&"label"===b.attributes.type:!1},constructor:function(e){var d=e.mapPanel.drawLayer;e.attributes=e.attributes||{};e.geometry=e.geometry||"Polygon";var f=OpenLayers.Class(OpenLayers.Control.DrawFeature,{drawFeature:function(a){a=new OpenLayers.Feature.Vector(a,e.attributes,e.style);!1!==this.layer.events.triggerEvent("sketchcomplete",{feature:a})&&(a.state=OpenLayers.State.INSERT,this.layer.addFeatures([a]),this.featureAdded(a),this.events.triggerEvent("featureadded",{feature:a}))
}});e.control=new f(d,OpenLayers.Handler[e.geometry]);d.events.register("beforefeatureadded",this,function(b){this.isText(b.feature)&&Ext.Msg.prompt("Text","Mata in text:",function(h,a){"ok"==h&&(b.feature.attributes.label=a,b.feature.data.label=a,d.redraw())})});e.iconCls=e.iconCls||"action-drawgeometry";e.tooltip||(e.tooltip="Polygon"===e.geometry?"Rita omr\u00e5de":"Path"===e.geometry?"Rita linje":"Point"===e.geometry?"Rita punkt":"Rita geometri",this.isText(e)&&(e.tooltip="Placera ut text."));
e.toggleGroup="extraTools";this.callParent(arguments)}});Ext.define("OpenEMap.action.ModifyText",{extend:OpenEMap.action.Action,constructor:function(d){var c=d.mapPanel.drawLayer;d.attributes=d.attributes||{};d.control=d.mapPanel.selectControl;d.control.events.register("deactivate",this,function(){console.log("deactivate")});d.control.events.register("activate",this,function(){c.events.register("featureselected",this,function(b){Ext.Msg.prompt("Text","Mata in text:",function(f,a){"ok"==f&&(b.feature.attributes.label=a,b.feature.data.label=a,c.redraw())
})})});d.control.events.register("deactivate",this,function(){c.events.unregister("featureselected")});d.iconCls=d.iconCls||"action-selectgeometry";d.tooltip=d.tooltip||"\x26Auml;ndra text";d.toggleGroup="extraTools";this.callParent(arguments)}});Ext.define("OpenEMap.action.MeasureLine",{extend:OpenEMap.action.Action,constructor:function(b){b.control=new OpenLayers.Control.DynamicMeasure(OpenLayers.Handler.Path,{maxSegments:null,accuracy:2,mapPanel:b.mapPanel});b.iconCls=b.iconCls||"action-measureline";
b.tooltip=b.tooltip||"M\u00e4t str\x26auml;cka";b.toggleGroup="extraTools";this.callParent(arguments)}});Ext.define("OpenEMap.view.IdentifyResults",{extend:Ext.panel.Panel,autoScroll:!0,layout:{type:"vbox",pack:"start",align:"stretch"},initComponent:function(){var d=Ext.create("Ext.data.TreeStore",{root:{expanded:!0}});this.root=d.getRootNode();var c=Ext.create("Ext.grid.property.Grid",{flex:2,autoScroll:!0,title:"Egenskaper",collapsible:!0,collapsed:!1,xtype:"propertygrid",stripeRows:!0,clicksToEdit:100});
this.items=[{xtype:"treepanel",flex:1,rootVisible:!1,store:d,minHeight:200,listeners:{select:this.onSelect,scope:this}},c];this.callParent(arguments)},onSelect:function(i,h){var n={},m=h.raw.feature,l=h.raw.layer,j=function(b){l.metadata.attributes[b]&&(n[l.metadata.attributes[b].alias||b]=m.attributes[b])};m&&(l.metadata&&l.metadata.attributes?Object.keys(m.attributes).forEach(j):n=m.attributes,this.mapPanel.searchLayer.selectedFeatures.forEach(function(b){this.mapPanel.selectControl.unselect(b)
},this),h.raw.feature.layer&&this.mapPanel.selectControl.select(m));var n=Ext.clone(n),k=Ext.clone(n);Object.keys(n).forEach(function(d){var c=k[d];c.match("http://")||c.match("//")?(n[d]='\x3ca href\x3d"'+c+'" target\x3d"_blank"\x3eL\u00e4nk\x3c/a\x3e',k[d]={renderer:function(b){return b},editor:Ext.create("Ext.form.DisplayField")}):k[d]={editor:Ext.create("Ext.form.DisplayField")}});this.down("propertygrid").setSource(n,k)},addResult:function(e,d){var f=this.root.appendChild({text:d.name,leaf:!1,expanded:!0});
e.forEach(function(b){f.appendChild({text:b.attributes[Object.keys(b.attributes)[0]],leaf:!0,feature:b,layer:d})})}});Ext.define("OpenEMap.action.Identify",{extend:OpenEMap.action.Action,popup:null,getPopup:function(b){this.popup&&this.popup.destroy();return this.popup=Ext.create("GeoExt.window.Popup",{title:"S\u00f6kresultat",location:b.feature,anchored:!1,unpinnable:!1,draggable:!0,map:b.mapPanel,maximizable:!1,minimizable:!1,resizable:!0,width:300,height:400,layout:"fit",items:b.items,collapsible:!1,x:200,y:100,listeners:{close:function(){b.mapPanel.searchLayer.removeAllFeatures()
}}})},constructor:function(i){var h=this,n=i.mapPanel,m=n.searchLayer,l=i.map,j=i.layers,k=OpenLayers.Class(OpenLayers.Control,{initialize:function(b){OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.onClick},this.handlerOptions)},onClick:function(d){n.setLoading(!0);m.destroyFeatures();var g=l.getLonLatFromPixel(d.xy);d=g.lon;var g=g.lat,e=new OpenLayers.Geometry.Point(d,g),c=new OpenLayers.Feature.Vector(e);m.addFeatures([c]);
var b=Ext.create("OpenEMap.view.IdentifyResults",{mapPanel:n});h.getPopup({mapPanel:n,location:c,items:b}).show();OpenEMap.requestLM({url:"registerenheter?x\x3d"+d+"\x26y\x3d"+g,success:function(f){f=Ext.decode(f.responseText);f=new OpenLayers.Feature.Vector(e,{name:f.name});b.addResult([f],{name:"Fastigheter"})},failure:function(f){Ext.Msg.alert("Fel",f.statusText)},callback:function(){n.setLoading(!1)}});Ext.create("OpenEMap.config.Parser").extractWFS(j).forEach(function(o){var f=Ext.apply({version:"1.1.0",srsName:"EPSG:3006"},o.wfs);
(new OpenLayers.Protocol.WFS(f)).read({filter:new OpenLayers.Filter({type:OpenLayers.Filter.Spatial.BBOX,value:e.getBounds()}),callback:function(a){if((a=a.features)&&0<a.length){b.addResult(a,o),m.addFeatures(a)}}})})}});i.control=new k({type:OpenLayers.Control.TYPE_TOGGLE});i.iconCls=i.iconCls||"action-identify";i.tooltip=i.tooltip||"Identifiera";i.toggleGroup="extraTools";this.callParent(arguments)}});Ext.define("OpenEMap.action.MetadataInfoColumn",{extend:Ext.grid.column.Action,requrires:["Ext.tip.ToolTip","OpenEMap.data.DataHandler","OpenEMap.view.MetadataWindow"],text:"",width:22,menuDisabled:!0,xtype:"actioncolumn",align:"center",iconCls:"action-identify",initComponent:function(d){var c=this;
this.tip=Ext.create("Ext.tip.ToolTip",{trackMouse:!0});this.listeners={mouseover:function(b,m,l,j,k,i){c.tip.setTarget(k.target);c.dataHandler&&c.dataHandler.getMetadataAbstract(c.getUUIDFromMetadataUrl(i.get("urlToMetadata")),function(e){e["abstract"]&&c.updateTooltip(e["abstract"])})},mouseout:function(){c.tip.update(null);c.tip.hide()},click:function(b,m,l,j,k,i){c.metadataWindow&&(c.tip.update(null),c.metadataWindow.showMetadata(c.getUUIDFromMetadataUrl(i.get("urlToMetadata"))))}};this.callParent(arguments)
},updateTooltip:function(b){b&&(this.tip.update(b.substr(0,180)+"..."),this.tip.show())},getUUIDFromMetadataUrl:function(d){if(d){var c=d.indexOf("id\x3d");if(0<c){return d.substr(c+3,36)}}return d}});Ext.define("OpenEMap.view.DetailReportResults",{extend:Ext.view.View,autoScroll:!0,padding:5,geometry:null,initComponent:function(){this.store=Ext.create("GeoExt.data.FeatureStore",{features:[],fields:"COUNT CATEGORY CLARIFICAT DESCRIPTIO REMARK MAPTEXT MAX MIN HEIGHT".split(" ")});this.tpl=new Ext.XTemplate("\x3ch3\x3e"+this.fbet+"\x3c/h3\x3e","\x3ch4\x3e"+this.aktbet+"\x3c/h4\x3e",'\x3ctpl for\x3d"."\x3e','\x3cdiv style\x3d"margin-bottom: 10px;" class\x3d"thumb-wrap"\x3e',"\x3ch4\x3e{COUNT}. {DESCRIPTIO}\x3c/h4\x3e","\x3cp\x3e{REMARK}\x3c/p\x3e","\x3c/div\x3e","\x3c/tpl\x3e");
this.itemSelector="div.thumb-wrap";this.callParent(arguments);this.doSearch()},doSearch:function(){var f=this.store,e=this.layer,h=this.geometry;e.destroyFeatures();var g=Ext.apply({url:"wfs",version:"1.1.0",srsName:"EPSG:3006",featureType:"EgenskapsBestammelser_yta",featurePrefix:"RIGES"});(new OpenLayers.Protocol.WFS(g)).read({filter:new OpenLayers.Filter({type:OpenLayers.Filter.Spatial.INTERSECTS,value:h}),callback:function(a){if(a=a.features){a.forEach(function(c){c.attributes.COUNT=f.getCount()+1;
f.addFeatures([c])}),e.addFeatures(a)}}})},onSelect:function(h,f){var l={},k=f.raw.feature,j=f.raw.layer,i=function(b){j.metadata.attributes[b]&&(l[j.metadata.attributes[b].alias||b]=k.attributes[b])};k&&(j.metadata&&j.metadata.attributes?Object.keys(k.attributes).forEach(i):l=k.attributes,this.mapPanel.searchLayer.selectedFeatures.forEach(function(b){this.mapPanel.selectControl.unselect(b)},this),f.raw.feature.layer&&this.mapPanel.selectControl.select(k))}});Ext.define("OpenEMap.action.DetailReport",{extend:OpenEMap.action.Action,constructor:function(g){var f=g.mapPanel,j=f.searchLayer,i=g.map,h=OpenLayers.Class(OpenLayers.Control,{initialize:function(b){OpenLayers.Control.prototype.initialize.apply(this,arguments);
this.handler=new OpenLayers.Handler.Click(this,{click:this.onClick},this.handlerOptions)},onClick:function(b){f.setLoading(!0);j.destroyFeatures();var d=i.getLonLatFromPixel(b.xy);b=d.lon;var d=d.lat,c=new OpenLayers.Geometry.Point(b,d),c=new OpenLayers.Feature.Vector(c);j.addFeatures([c]);OpenEMap.requestLM({url:"enhetsomraden?x\x3d"+b+"\x26y\x3d"+d,success:function(k){k=(new OpenLayers.Format.GeoJSON).read(k.responseText);j.addFeatures(k);var m=j.getDataExtent();i.zoomToExtent(m);var m=k[0].geometry,l=k[0].attributes.name;
k=Ext.apply({url:"wfs",version:"1.1.0",srsName:"EPSG:3006",featureType:"DetaljplanGallande_yta",featurePrefix:"RIGES"});(new OpenLayers.Protocol.WFS(k)).read({filter:new OpenLayers.Filter({type:OpenLayers.Filter.Spatial.INTERSECTS,value:m}),callback:function(e){if((e=e.features)&&0<e.length){j.addFeatures(e),e=Ext.create("OpenEMap.view.DetailReportResults",{mapPanel:f,fbet:l,aktbet:e[0].attributes.AKTBET,geometry:e[0].geometry,layer:f.drawLayer}),Ext.create("GeoExt.window.Popup",{title:"Rapport",anchored:!1,unpinnable:!1,draggable:!0,map:f,maximizable:!1,minimizable:!1,resizable:!0,width:300,height:400,layout:"fit",items:e,collapsible:!1}).show()
}}})},scope:this,callback:function(){f.setLoading(!1)}})}});g.control=new h({type:OpenLayers.Control.TYPE_TOGGLE});g.iconCls=g.iconCls||"action-detailreport";g.tooltip=g.tooltip||"Detaljerad rapport";g.toggleGroup="extraTools";this.callParent(arguments)}});Ext.define("OpenEMap.action.DeleteMeasure",{extend:OpenEMap.action.Action,constructor:function(b){b.control=new OpenLayers.Control.Button({trigger:function(){b.mapPanel.measureLayer.removeAllFeatures();b.mapPanel.measureLayerArea.removeAllFeatures();
b.mapPanel.measureLayerLength.removeAllFeatures();b.mapPanel.measureLayerSegments.removeAllFeatures();b.mapPanel.map.controls.forEach(function(c){c instanceof OpenLayers.Control.DynamicMeasure&&c.deactivate()})}});b.iconCls=b.iconCls||"action-deletegeometry";b.tooltip=b.tooltip||"Ta bort m\x26auml;tning(ar).";this.callParent(arguments)}});Ext.define("OpenEMap.action.DeleteAllFeatures",{extend:OpenEMap.action.Action,constructor:function(b){b.control=new OpenLayers.Control.Button({trigger:function(){b.mapPanel.measureLayer.removeAllFeatures();
b.mapPanel.measureLayerSegmentsLayer.removeAllFeatures();b.mapPanel.map.layers.forEach(function(c){c instanceof OpenLayers.Layer.Vector&&c.removeAllFeatures()})}});b.iconCls=b.iconCls||"action-deleteallfeatures";b.tooltip=b.tooltip||"Rensa kartan fr\x26aring;n ritade objekt.";this.callParent(arguments)}});Ext.define("OpenEMap.action.FullExtent",{extend:OpenEMap.action.Action,constructor:function(b){b.control=new OpenLayers.Control.ZoomToMaxExtent;b.iconCls=b.iconCls||"action-fullextent";b.tooltip=b.tooltip||"Zooma till full utberedning";
this.callParent(arguments)}});Ext.define("OpenEMap.action.SelectGeometry",{extend:OpenEMap.action.Action,constructor:function(b){b.control=b.mapPanel.selectControl;b.iconCls=b.iconCls||"action-selectgeometry";b.tooltip=b.tooltip||"V\x26auml;lj ritat objekt";b.toggleGroup="extraTools";this.callParent(arguments)}});Ext.define("OpenEMap.action.ModifyGeometry",{extend:OpenEMap.action.Action,constructor:function(e){var d=e.mapPanel.drawLayer;void 0===e.drag&&(e.drag=!0);void 0===e.rotate&&(e.rotate=!0);
void 0===e.reshape&&(e.reshape=!0);var f=0;e.drag&&(f|=OpenLayers.Control.ModifyFeature.DRAG);e.rotate&&(f|=OpenLayers.Control.ModifyFeature.ROTATE);e.resize&&(f|=OpenLayers.Control.ModifyFeature.RESIZE);e.reshape&&(f|=OpenLayers.Control.ModifyFeature.RESHAPE);f=Ext.apply({mode:f},e.options);e.control=new OpenLayers.Control.ModifyFeature(d,f);e.control._mode=e.control.mode;e.iconCls=e.iconCls||"action-modifygeometry";e.tooltip=e.tooltip||"\x26Auml;ndra ritat objekt";e.toggleGroup="extraTools";this.callParent(arguments)
}});Ext.define("OpenEMap.action.DeleteGeometry",{extend:OpenEMap.action.Action,constructor:function(e){var d=e.mapPanel,f=d.drawLayer;e.handler=function(){f.selectedFeatures.forEach(function(b){d.map.controls.forEach(function(a){"OpenLayers.Control.ModifyFeature"==a.CLASS_NAME&&a.active&&a.unselectFeature(b)});f.destroyFeatures([b])})};e.iconCls=e.iconCls||"action-deletegeometry";e.tooltip=e.tooltip||"Ta bort ritat objekt";this.callParent(arguments)}});Ext.define("OpenEMap.ObjectFactory",{toPoint:function(b){return new OpenLayers.Geometry.Point(b[0],b[1])
},createR:function(f){var e=f.x,h=f.y,g=f.l;f=f.w;e=new OpenLayers.Geometry.LinearRing([[e,h],[e,h-g],[e+f,h-g],[e+f,h]].map(this.toPoint));return new OpenLayers.Geometry.Polygon([e])},createL:function(h){var f=h.x,l=h.y,k=h.l,j=h.w,i=h.m1;h=h.m2;f=new OpenLayers.Geometry.LinearRing([[f,l],[f,l-j],[f+i,l-j],[f+i,l-h],[f+k,l-h],[f+k,l]].map(this.toPoint));return new OpenLayers.Geometry.Polygon([f])},createD:function(g){var f=g.x,j=g.y,i=g.l,h=g.w;g=(i-g.m1)/2;f=new OpenLayers.Geometry.LinearRing([[f,j],[f,j-h+g],[f+g,j-h],[f+i-g,j-h],[f+i,j-h+g],[f+i,j]].map(this.toPoint));
return new OpenLayers.Geometry.Polygon([f])},createO:function(e){var d=e.x,f=e.y;e=e.m1/2*Math.sqrt(4+2*Math.SQRT2);d=new OpenLayers.Geometry.Point(d+e,f-e);return OpenLayers.Geometry.Polygon.createRegularPolygon(d,e,8)},figurHooks:function(e){var d=e.geometry.move;e.geometry.move=function(b,a){e.attributes.config.x+=b;e.attributes.config.y+=a;d.apply(e.geometry,arguments)};var f=e.geometry.rotate;e.geometry.rotate=function(a,c){e.attributes.config.angle+=a;f.apply(e.geometry,arguments)}},create:function(g,f,j){var i;
i="R"==g.type?this.createR(g):"L"==g.type?this.createL(g):"D"==g.type?this.createD(g):this.createO(g);var h=i.getCentroid(),h=new OpenLayers.Geometry.Point(h.x,h.y);i.rotate(g.angle,h);f=new OpenLayers.Feature.Vector(i,f,j);this.figurHooks(f);f.attributes.config=g;return f}});Ext.define("OpenEMap.view.ObjectConfig",{extend:Ext.form.Panel,statics:{config:{type:"R",w:10,l:10,m1:2,m2:2,angle:0}},fieldDefaults:{labelWidth:60},autoHeight:!0,width:400,border:!1,selectedFeature:void 0,layer:void 0,factory:void 0,hidden:!0,defaults:{border:!1},typeLabel:"Type",widthLabel:"Width",lengthLabel:"Length",m1Label:"M1",m2Label:"M2",angleLabel:"Angle",initComponent:function(){this.layer=this.mapPanel.drawLayer;
this.factory=Ext.create("OpenEMap.ObjectFactory");var b=[];b.push({xtype:"radiogroup",vertical:!0,fieldLabel:this.typeLabel,itemId:"type",hidden:!0,items:[{boxLabel:'\x3cdiv class\x3d"objectconfig-radio-r"\x3e\x3c/div\x3e',name:"rb",inputValue:"R",checked:!0},{boxLabel:'\x3cdiv class\x3d"objectconfig-radio-l"\x3e\x3c/div\x3e',name:"rb",enabled:!1,inputValue:"L"},{boxLabel:'\x3cdiv class\x3d"objectconfig-radio-d"\x3e\x3c/div\x3e',name:"rb",enabled:!1,inputValue:"D"},{boxLabel:'\x3cdiv class\x3d"objectconfig-radio-o"\x3e\x3c/div\x3e',name:"rb",enabled:!1,inputValue:"O"}],listeners:{change:function(d,e){this.config.type=e.rb;
this.updateHelpImage(this.config.type);this.setFormItemVisibility(this.config.type);this.createObject()},scope:this}});b=b.concat([{xtype:"numberfield",fieldLabel:this.widthLabel,itemId:"w",minValue:0,listeners:{change:function(d,e){this.config.w=e;this.createObject()},scope:this}},{xtype:"numberfield",fieldLabel:this.lengthLabel,itemId:"l",minValue:0,listeners:{change:function(d,e){this.config.l=e;this.createObject()},scope:this}},{xtype:"numberfield",fieldLabel:this.m1Label,itemId:"m1",minValue:0,listeners:{change:function(d,e){this.config.m1=e;
this.createObject()},scope:this}},{xtype:"numberfield",fieldLabel:this.m2Label,itemId:"m2",minValue:0,listeners:{change:function(d,e){this.config.m2=e;this.createObject()},scope:this}},{xtype:"numberfield",itemId:"angle",fieldLabel:this.angleLabel,value:0,listeners:{change:function(d,e){this.config.angle=e;this.createObject()},scope:this}}]);this.attributeFields=Ext.create("Ext.container.Container",{title:"Attributes"});b.push(this.attributeFields);this.items=[{layout:"column",defaults:{border:!1},padding:5,items:[{width:180,layout:"form",items:b},{columnWidth:1,padding:5,items:{itemId:"objectimage",border:!1,height:200}}]}];
this.layer.events.register("featuremodified",this,this.onFeaturemodified);this.layer.events.register("beforefeatureselected",this,this.onBeforefeatureselected);this.layer.events.register("featureunselected",this,this.onFeatureunselected);this.callParent(arguments)},setConfig:function(b){void 0===b?(this.config=Ext.clone(OpenEMap.view.ObjectConfig.config),this.down("#type").show()):b.type?(this.config=Ext.clone(b),Ext.applyIf(this.config,OpenEMap.view.ObjectConfig.config),this.down("#type").hide()):(this.config=Ext.clone(b),Ext.applyIf(this.config,OpenEMap.view.ObjectConfig.config),this.down("#type").show());
this.setFormValues();this.show();return this.config},setFormValues:function(){this.config?(this.down("#type").setValue({rb:this.config.type}),this.updateHelpImage(this.config.type),this.down("#w").setRawValue(this.config.w),this.down("#l").setRawValue(this.config.l),this.down("#m1").setRawValue(this.config.m1),this.down("#m2").setRawValue(this.config.m2),this.down("#angle").setRawValue(this.config.angle),this.setFormItemVisibility(this.config.type),this.down("#angle").show()):(this.down("#type").hide(),this.down("#w").hide(),this.down("#l").hide(),this.down("#m1").hide(),this.down("#m2").hide(),this.down("#angle").hide(),this.down("#objectimage").hide());
this.attributeFields.removeAll();this.selectedFeature&&Object.keys(this.selectedFeature.attributes).forEach(function(b){this.createAttributeField(this.selectedFeature,b)},this);this.doLayout()},createAttributeField:function(e,d){if(!("config"==d||"metadata"==d)){var f=e.attributes.metadata;(!f||!f[d]||!f[d].hidden)&&this.attributeFields.add({xtype:"textfield",fieldLabel:d,value:e.attributes[d],listeners:{change:function(b,g){this.selectedFeature.attributes[d]=g;this.layer.drawFeature(this.selectedFeature)
},scope:this}})}},setFormItemVisibility:function(b){"R"==b?(this.down("#w").show(),this.down("#l").show(),this.down("#m1").hide(),this.down("#m2").hide()):"L"==b?(this.down("#w").show(),this.down("#l").show(),this.down("#m1").show(),this.down("#m2").show()):"D"==b?(this.down("#w").show(),this.down("#l").show(),this.down("#m1").show(),this.down("#m2").hide()):"O"==b&&(this.down("#w").hide(),this.down("#l").hide(),this.down("#m1").show(),this.down("#m2").hide())},onFeaturemodified:function(b){(config=b.feature.attributes.config)&&this.down("#angle").setRawValue(config.angle)
},onBeforefeatureselected:function(b){this.selectedFeature=b=b.feature;this.config=b.attributes.config;if((b=this.gui.activeAction)&&b.control instanceof OpenLayers.Control.ModifyFeature){b.control.mode=this.config&&b.control._mode&OpenLayers.Control.ModifyFeature.RESHAPE?b.control._mode^OpenLayers.Control.ModifyFeature.RESHAPE:b.control._mode,b.control.resetVertices()}this.show();this.setFormValues()},onFeatureunselected:function(){0===this.layer.selectedFeatures.length&&this.hide();this.selectedFeature=void 0
},createObject:function(e,d,f){this.selectedFeature&&this.selectedFeature.attributes.config&&(e=this.factory.create(this.config,f).geometry,this.selectedFeature.geometry.removeComponent(this.selectedFeature.geometry.components[0]),this.selectedFeature.geometry.addComponent(e.components[0]),this.selectedFeature.modified=!0,this.selectedFeature.geometry.calculateBounds(),this.mapPanel.map.controls.forEach(function(b){"OpenLayers.Control.ModifyFeature"==b.CLASS_NAME&&b.active&&b.resetVertices()}),this.layer.drawFeature(this.selectedFeature),this.layer.events.triggerEvent("featuremodified",{feature:this.selectedFeature}))
},updateHelpImage:function(b){b="figur-"+b+"-help.png";this.down("#objectimage").show();this.down("#objectimage").update('\x3cimg src\x3d"'+OpenEMap.basePathImages+b+'"\x3e\x3c/img\x3e')}});Ext.define("OpenEMap.action.DrawObject",{extend:OpenEMap.action.Action,constructor:function(d){this.mapPanel=d.mapPanel;this.layer=this.mapPanel.drawLayer;this.style=d.style;this.attributes=d.attributes;this.objectConfig=d.objectConfig;this.objectConfigView=d.objectConfigView;this.factory=Ext.create("OpenEMap.ObjectFactory");
this.attributes=this.attributes||{};var c=OpenLayers.Class(OpenLayers.Control,{initialize:function(b){OpenLayers.Control.prototype.initialize.apply(this,arguments);this.handler=new OpenLayers.Handler.Click(this,{click:this.onClick},this.handlerOptions)},onClick:Ext.bind(this.onClick,this)});d.control=new c({type:OpenLayers.Control.TYPE_TOGGLE});d.iconCls=d.iconCls||"action-drawobject";d.tooltip=d.tooltip||"Rita f\x26ouml;rdefinierad form.";d.toggleGroup="extraTools";this.callParent(arguments)},onClick:function(d){d=this.mapPanel.map.getLonLatFromPixel(d.xy);
var c=this.objectConfigView?this.objectConfigView.config:OpenEMap.view.ObjectConfig.config,c=Ext.clone(c);c.x=d.lon;c.y=d.lat;d=this.factory.create(c,this.attributes,this.style);this.mapPanel.unselectAll();this.layer.addFeatures([d]);this.mapPanel.selectControl.select(d)},toggle:function(b){b&&this.objectConfigView.setConfig(this.objectConfig)}});Ext.define("OpenEMap.view.BaseLayers",{extend:Ext.toolbar.Toolbar,border:!1,cls:"oep-map-tools",constructor:function(f){var e=f.mapPanel,h=e.map,g=e.map.layers.filter(function(b){return b.isBaseLayer
});this.items=g.map(function(d){var c;d==g[g.length-1]&&(c="oep-tools-last");return Ext.create("Ext.Button",{text:d.name,toggleGroup:"baseLayers",allowDepress:!1,layer:d,pressed:d.visibility,cls:c,listeners:{toggle:function(a,i){i&&h.setBaseLayer(d)}}})});h.events.register("changebaselayer",this,this.onChangeBaseLayer);this.callParent(arguments)},onChangeBaseLayer:function(b){this.items.each(function(a){a.toggle(a.layer==b.layer,!0)})}});Ext.define("OpenEMap.view.Map",{extend:GeoExt.panel.Map,border:!1,anchor:"100% 100%",constructor:function(e){this.initDefaultLayers(e.config);
var d=Ext.create("GeoExt.data.MapfishPrintProvider",{url:OpenEMap.basePathMapFish,autoLoad:!0,timeout:60000,listeners:{encodelayer:function(h,g,i){i&&i.baseURL&&(i.baseURL=i.baseURL.replace("gwc/service/",""))}}}),f=Ext.create("GeoExt.plugins.PrintExtent",{printProvider:d});this.encode=function(b){var c=f.addPage();b&&(b=d.layouts.findRecord("name",b),d.setLayout(b));b=d.encode(f.map,f.pages);f.removePage(c);return b};d.encode=function(v,u,t){v instanceof GeoExt.MapPanel&&(v=v.map);u=u instanceof Array?u:[u];
t=t||{};if(!1!==this.fireEvent("beforeprint",this,v,u,t)){var s=Ext.apply({units:v.getUnits(),srs:v.baseLayer.projection.getCode(),layout:this.layout.get("name"),dpi:this.dpi.get("value")},this.customParams),r=u[0].feature.layer,q=[],p=v.layers.concat();Ext.Array.remove(p,v.baseLayer);Ext.Array.insert(p,0,[v.baseLayer]);Ext.each(p,function(b){b!==r&&!0===b.getVisibility()&&(b=this.encodeLayer(b))&&q.push(b)},this);s.layers=q;var o=[];Ext.each(u,function(b){o.push(Ext.apply({center:[b.center.lon,b.center.lat],scale:b.scale.get("value"),rotation:b.rotation},b.customParams))
},this);s.pages=o;if(t.overview){var i=[];Ext.each(t.overview.layers,function(b){(b=this.encodeLayer(b))&&i.push(b)},this);s.overviewLayers=i}if(t.legend&&!1!==this.fireEvent("beforeencodelegend",this,s,t.legend)){v=t.legend;(u=v.rendered)||(v=v.cloneConfig({renderTo:document.body,hidden:!0}));var g=[];v.items&&v.items.each(function(h){if(!h.hidden){var c=this.encoders.legends[h.getXType()];g=g.concat(c.call(this,h,s.pages[0].scale))}},this);u||v.destroy();s.legends=g}return s}};e.plugins=[f];this.callParent(arguments);
this.layers.add(this.searchLayer);this.layers.add(this.drawLayer);this.layers.add(this.measureLayer);this.layers.add(this.measureLayerArea);this.layers.add(this.measureLayerLength);this.layers.add(this.measureLayerSegments);this.map.setLayerIndex(this.measureLayer,98);this.map.setLayerIndex(this.measureLayerArea,98);this.map.setLayerIndex(this.measureLayerLength,98);this.map.setLayerIndex(this.measureLayerSegments,98);this.selectControl=new OpenLayers.Control.SelectFeature(this.drawLayer);this.map.addControl(this.selectControl)
},unselectAll:function(){this.drawLayer.selectedFeatures.forEach(function(b){this.selectControl.unselect(b)},this)},parseStyle:function(i){var h={Point:{pointRadius:4,graphicName:"square",fillColor:"#e8ffee",fillOpacity:0.9,strokeWidth:1,strokeOpacity:1,strokeColor:"#29bf4c"},Line:{strokeWidth:3,strokeColor:"#29bf4c",strokeOpacity:1},Polygon:{strokeWidth:3,strokeOpacity:1,strokeColor:"#29bf4c",fillColor:"#e8ffee",fillOpacity:0.9}},n=function(b){var d=Ext.clone(h);b.Point?(Ext.apply(d.Point,b.Point),Ext.apply(d.Line,b.Line),Ext.apply(d.Polygon,b.Polygon),b.labelSegments&&Ext.apply(d.labelSegments,b.labelSegments),b.labelLength&&Ext.apply(d.labelLength,b.labelLength)):(Ext.apply(d.Point,b),Ext.apply(d.Line,b),Ext.apply(d.Polygon,b));
return d},m=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:h})]}),l,j,k;i&&(i["default"]&&(m=n(i["default"]),m=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:m})]})),i.select&&(l=n(i.select),l=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:l})]})),i.temporary&&(j=n(i.temporary),j=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:j})]})),i.labelLength&&(k=n(i),k=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:k})]})),i["default"]||(m=n(i),m=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:m})]})));
i={"default":m};l&&(i.select=l);j&&(i.temporary=j);k&&(i["default"]=k);return new OpenLayers.StyleMap(i)},initDefaultLayers:function(e){e.drawStyle||(e.drawStyle={"default":{Point:{pointRadius:4,graphicName:"square",fillColor:"#ffffff",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#2969bf"},Line:{strokeWidth:3,strokeColor:"#2969bf",strokeOpacity:1},Polygon:{strokeWidth:3,strokeOpacity:1,strokeColor:"#2969bf",fillOpacity:0}},select:{strokeWidth:3,strokeOpacity:1,fillColor:"#deecff",fillOpacity:0.9,strokeColor:"#2969bf"},temporary:{strokeWidth:3,strokeOpacity:0.75,fillColor:"#ff00ff",fillOpacity:0,strokeColor:"#ff00ff"}});
this.drawLayer=new OpenLayers.Layer.Vector("Drawings",{displayInLayerSwitcher:!1,styleMap:this.parseStyle(e.drawStyle)});e.autoClearDrawLayer&&this.drawLayer.events.register("beforefeatureadded",this,function(){this.drawLayer.destroyFeatures()});this.drawLayer.events.register("beforefeaturemodified",this,function(b){this.selectControl.select(b.feature)});this.drawLayer.events.register("afterfeaturemodified",this,function(){});this.searchLayer=new OpenLayers.Layer.Vector("Searchresult",{displayInLayerSwitcher:!1,styleMap:this.parseStyle({Point:{pointRadius:4,graphicName:"square",fillColor:"#ffffff",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#2969bf"},Line:{strokeWidth:3,strokeColor:"#2969bf",strokeOpacity:1},Polygon:{strokeDashstyle:"dot",strokeWidth:3,strokeOpacity:1,strokeColor:"#f58d1e",fillOpacity:0}})});
var d=OpenLayers.Control.DynamicMeasure.styles;e=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:d.Point,Line:d.Line,Polygon:d.Polygon}})]});e=new OpenLayers.StyleMap({"default":e});var f=function(b){return new OpenLayers.StyleMap({"default":OpenLayers.Util.applyDefaults(null,d[b])})};this.measureLayer=new OpenLayers.Layer.Vector("MeasureLayer",{displayInLayerSwitcher:!1,styleMap:e});this.measureLayerArea=new OpenLayers.Layer.Vector("MeasureLayerArea",{displayInLayerSwitcher:!1,styleMap:f("labelArea")});
this.measureLayerSegments=new OpenLayers.Layer.Vector("MeasureLayerSegments",{displayInLayerSwitcher:!1,styleMap:f("labelSegments")});this.measureLayerLength=new OpenLayers.Layer.Vector("MeasureLayerLength",{displayInLayerSwitcher:!1,styleMap:f("labelLength")})},setInitialExtent:function(){var b=this.map;b.getCenter()||(this.center||this.zoom?b.setCenter(this.center,this.zoom):this.extent instanceof OpenLayers.Bounds?b.zoomToExtent(this.extent,!1):b.zoomToMaxExtent())}});Ext.define("OpenEMap.view.SearchCoordinate",{extend:Ext.container.Container,layout:"column",defaults:{labelWidth:20},width:300,border:!1,zoom:5,initComponent:function(b){this.items=[{itemId:"e",fieldLabel:"E",xtype:"textfield",columnWidth:0.5},{itemId:"n",fieldLabel:"N",xtype:"textfield",columnWidth:0.5},{xtype:"button",text:"S\u00f6k",handler:function(){var d=this.down("#e").getValue(),e=this.down("#n").getValue();
this.mapPanel.map.setCenter([d,e],this.zoom);this.fireEvent("searchcomplete",[d,e])},scope:this}];this.addEvents(["searchcomplete"]);this.callParent(arguments)}});Ext.define("OpenEMap.form.SearchRegisterenhet",{extend:Ext.form.field.ComboBox,alias:"widget.searchregisterenhet",require:["Ext.data.*","Ext.form.*"],queryDelay:800,initComponent:function(){var f,e;this.search&&this.search.options&&(f=this.search.options.municipalities.join(","),e=this.search.options.zoom);var h=this.mapPanel.searchLayer;
this.store=Ext.create("Ext.data.Store",{proxy:{type:"ajax",url:OpenEMap.basePathLM+"registerenheter",extraParams:{lmuser:OpenEMap.lmUser},reader:{type:"json",root:"features"}},fields:[{name:"id",mapping:"properties.objid"},{name:"name",mapping:"properties.name"}]});if(this.store.loading&&this.store.lastOperation){var g=Ext.Ajax.requests;for(id in g){g.hasOwnProperty(id)&&g[id].options==this.store.lastOperation.request&&Ext.Ajax.abort(g[id])}}this.store.on("beforeload",function(d,c){d.lastOperation=c
},this,{single:!0});this.labelWidth=60;this.displayField="name";this.valueField="id";this.queryParam="q";this.forceSelection=this.typeAhead=!0;this.listeners={select:function(b,i){var c=i[0].get("id");this.mapPanel.setLoading(!0);this.mapPanel.searchLayer.destroyFeatures();OpenEMap.requestLM({url:"registerenheter/"+c+"/enhetsomraden?",success:function(d){this.resultPanel.expand();d=(new OpenLayers.Format.GeoJSON).read(d.responseText);h.addFeatures(d);d=h.getDataExtent();e?this.mapPanel.map.setCenter(d.getCenterLonLat(),e):this.mapPanel.map.zoomToExtent(d)
},failure:function(){Ext.Msg.alert("Fel","Ingen tr\u00e4ff.")},callback:function(){this.mapPanel.setLoading(!1)},scope:this})},beforequery:function(a){f&&null===a.query.match(f)&&(a.query=f+" "+a.query)},scope:this};this.callParent(arguments)}});Ext.define("OpenEMap.form.SearchAddress",{extend:Ext.form.field.ComboBox,alias:"widget.searchaddress",require:["Ext.data.*","Ext.form.*"],initComponent:function(){var f,e=11;this.search&&this.search.options&&(f=this.search.options.municipalities.join(","),e=this.search.options.zoom);
var h=this.mapPanel.searchLayer;this.store=Ext.create("Ext.data.Store",{proxy:{type:"ajax",url:OpenEMap.basePathLM+"addresses",extraParams:{lmuser:OpenEMap.lmUser},reader:{type:"array"}},fields:["id","name","x","y","fnr"]});if(this.store.loading&&this.store.lastOperation){var g=Ext.Ajax.requests;for(id in g){g.hasOwnProperty(id)&&g[id].options==this.store.lastOperation.request&&Ext.Ajax.abort(g[id])}}this.store.on("beforeload",function(d,c){d.lastOperation=c},this,{single:!0});this.labelWidth=60;
this.displayField="name";this.valueField="id";this.queryParam="q";this.forceSelection=this.typeAhead=!0;this.listeners={select:function(b,l){var k=l[0].data.fnr,i=l[0].data.x,c=l[0].data.y;this.mapPanel.setLoading(!0);this.mapPanel.searchLayer.destroyFeatures();OpenEMap.requestLM({url:"registerenheter?fnr\x3d"+k,success:function(d){!1===Ext.decode(d.responseText).success?Ext.Msg.alert("Meddelande","Ingen fastighet kunde hittas p\u00e5 adressen."):(this.resultPanel.expand(),d=(new OpenLayers.Format.GeoJSON).read(d.responseText,"FeatureCollection"),h.addFeatures(d),d=new OpenLayers.Geometry.Point(i,c),feature=new OpenLayers.Feature.Vector(d),h.addFeatures([feature]),this.mapPanel.map.setCenter([i,c],e))
},failure:function(){Ext.Msg.alert("Fel","Ok\u00e4nt.")},callback:function(){this.mapPanel.setLoading(!1)},scope:this})},beforequery:function(a){f&&null===a.query.match(f)&&(a.query=f+" "+a.query)},scope:this};this.callParent(arguments)}});Ext.define("OpenEMap.form.SearchPlacename",{extend:Ext.form.field.ComboBox,alias:"widget.searchplacename",require:["Ext.data.*","Ext.form.*"],initComponent:function(){var d,c=5;this.search&&this.search.options&&(d=this.search.options.municipalities.join(","),c=this.search.options.zoom);
this.store=Ext.create("Ext.data.Store",{proxy:{type:"ajax",url:OpenEMap.basePathLM+"placenames",extraParams:{lmuser:OpenEMap.lmUser,kommunkod:d},reader:{type:"json",root:"features"}},fields:[{name:"id",mapping:"properties.id"},{name:"name",mapping:"properties.name"}]});if(this.store.loading&&this.store.lastOperation){for(id in d=Ext.Ajax.requests,d){d.hasOwnProperty(id)&&d[id].options==this.store.lastOperation.request&&Ext.Ajax.abort(d[id])}}this.store.on("beforeload",function(f,e){f.lastOperation=e
},this,{single:!0});this.labelWidth=60;this.displayField="name";this.valueField="id";this.queryParam="q";this.forceSelection=this.typeAhead=!0;this.listeners={select:function(b,g){var f=g[0].raw.geometry.coordinates;this.mapPanel.map.setCenter([f[1],f[0]],c)},scope:this};this.callParent(arguments)}});Ext.define("OpenEMap.view.SearchFastighet",{extend:Ext.form.Panel,border:!1,initComponent:function(){function e(i){var c=null,c="searchregisterenhet"===i?this.search&&this.search.searchEstates?this.search.searchEstates:null:"searchaddress"===i?this.search&&this.search.searchAddresses?this.search.searchAddresses:null:this.search&&this.search.searchPlacenames?this.search.searchPlacenames:null;
return{xtype:i,mapPanel:this.mapPanel,basePath:this.basePath,search:c,resultPanel:h}}this.renderTo||(this.title="S\u00f6k fastighet",this.bodyPadding=5);var f="";var g=[];if(this.search&&this.search.searchEstates){g.push(["searchregisterenhet","Fastighet"]);f="searchregisterenhet"}if(this.search&&this.search.searchAddresses){g.push(["searchaddress","Adress"]);f=f==""?"searchaddress":f}if(this.search&&this.search.searchPlacenames){g.push(["searchplacename","Ort"]);f=f==""?"searchplacename":f}if(this.search&&this.search.searchES&&this.search.searchES.detaljplan){g.push(["searches","Detaljplaner"]);
f=f==""?"searches":f}var d=Ext.create("GeoExt.data.FeatureStore",{layer:this.mapPanel.searchLayer,featureFilter:new OpenLayers.Filter.Function({evaluate:function(b){return b.attributes.name?!0:!1}}),fields:[{name:"name"},{name:"fid"},{name:"objid"}]}),h=Ext.create("Ext.grid.Panel",{columns:[{text:"Namn",dataIndex:"name",flex:1}],store:d,selType:"featuremodel"});this.items=[{layout:"column",border:!1,items:[{xtype:"combo",width:110,store:g,forceSelection:!0,queryMode:"local",value:f,border:!1,listeners:{change:function(a,j){var i=this.down("#search");
this.mapPanel.searchLayer.destroyFeatures();i.removeAll();i.add(e.call(this,j))},scope:this}},{itemId:"search",columnWidth:1,layout:"fit",border:!1,items:e.call(this,f)}]}];this.renderTo||this.items.push(h);this.callParent(arguments)}});Ext.define("OpenEMap.view.ZoomTools",{extend:Ext.panel.Panel,bodyStyle:"background : transparent",border:!1,getTools:function(){var e=Ext.util.CSS.getRule(".oep-tools"),d=e?"large":"medium",f=[],e=Ext.create("GeoExt.slider.Zoom",{height:200,vertical:!0,aggressive:!0,margin:e?"5 0 5 0":"5 0 5 8",map:this.mapPanel.map});
f.push({xtype:"button",iconCls:"zoomtools-plus",mapPanel:this.mapPanel,scale:d,cls:"x-action-btn",listeners:{click:function(){this.mapPanel.map.zoomIn()},scope:this}});f.push(e);f.push({xtype:"button",scale:d,cls:"x-action-btn",iconCls:"zoomtools-minus",mapPanel:this.mapPanel,listeners:{click:function(){this.mapPanel.map.zoomOut()},scope:this}});return f},constructor:function(b){Ext.apply(this,b);this.items=this.getTools();this.callParent(arguments)}});Ext.define("OpenEMap.Gui",{activeAction:null,objectConfigWindowTitle:"Object configuration",constructor:function(d){this.config=d.config;
this.gui=d.gui;this.map=d.map;this.orginalConfig=d.orginalConfig;this.serverStore=d.serverStore;this.search=d.config.search;void 0===this.gui&&(this.gui={map:!1,toolbar:{},zoomTools:{},baseLayers:{},layers:{},searchFastighet:{},objectConfig:{},searchCoordinate:!1});this.mapPanel=Ext.create("OpenEMap.view.Map",{map:this.map,extent:this.config.extent,config:this.config,listeners:{afterrender:function(){if(this.config.attribution){var b=this.mapPanel.getEl();Ext.DomHelper.append(b,'\x3cspan class\x3d"unselectable attribution"\x3e'+this.config.attribution+"\x3c/span\x3e")
}},scope:this}});this.createPanels();this.createToolbar();d=[];d.push(this.mapPanel);this.zoomTools&&d.push(this.zoomTools);this.leftPanel&&d.push(this.leftPanel);this.rightPanel&&d.push(this.rightPanel);this.baseLayers&&d.push(this.baseLayers);if(this.gui.map){var c=this.gui.map.renderTo?Ext.get(this.gui.map.renderTo):void 0;this.container=Ext.create("Ext.container.Container",Ext.apply({layout:"absolute",border:!1,width:c?c.getWidth():void 0,height:c?c.getHeight():void 0,items:d},this.gui.map))}else{this.container=Ext.create("Ext.container.Viewport",{layout:"absolute",items:d})
}},destroy:function(){this.mapPanel&&this.mapPanel.destroy();this.zoomTools&&this.zoomTools.destroy();this.mapLayers&&this.mapLayers.destroy();this.searchFastighet&&this.searchFastighet.destroy();this.searchCoordinate&&this.searchCoordinate.destroy();this.toolbar&&this.toolbar.destroy();this.leftPanel&&this.leftPanel.destroy();this.rightPanel&&this.rightPanel.destroy();this.baseLayers&&this.baseLayers.destroy();this.objectConfig&&this.objectConfig.destroy();this.objectConfigWindow&&this.objectConfigWindow.destroy();
this.container&&this.container.destroy()},onToggle:function(e,d){var f=e.baseAction;this.objectConfig&&(d&&(this.mapPanel.unselectAll(),this.objectConfig.hide(),this.activeAction=f),f.toggle(d))},createToolbar:function(){var f=this.config.basePath,e=this.config.layers;this.config.tools||(this.config.tools=[]);var h=this.config.tools.map(function(b){var a;if(Ext.isObject(b)&&0<Ext.Object.getSize(b)||!Ext.isObject(b)&&!Ext.isEmpty(b)){b===this.config.tools[this.config.tools.length-1]&&(a="oep-tools-last");
a={map:this.map,mapPanel:this.mapPanel,cls:a};b.constructor===Object&&(Ext.apply(a,b),b=a.type,delete a.type);if("ZoomSelector"==b){return Ext.create("OpenEMap.form.ZoomSelector",{map:this.map})}"DrawObject"==b?a.objectConfigView=this.objectConfig:"Identify"==b&&(a.basePath=f,a.layers=e);b=Ext.create("OpenEMap.action."+b,a);a.activate&&b.control&&(this.controlToActivate=b.control);b=Ext.create("Ext.button.Button",b);b.on("toggle",this.onToggle,this);return b}},this),g=6;h.forEach(function(b){b&&(g=b.constructor==String?g+1:b.width?g+b.width:g+24,g+=8)
});g+=3;this.gui.toolbar&&!this.gui.toolbar.renderTo?this.leftPanel=Ext.create("Ext.toolbar.Toolbar",Ext.apply({cls:"oep-tools",y:20,x:80,width:g,items:h},this.gui.toolbar)):this.gui.toolbar&&this.gui.toolbar.renderTo&&(this.toolbar=Ext.create("Ext.toolbar.Toolbar",Ext.apply({cls:"oep-tools",width:this.gui.toolbar.width||g,items:h},this.gui.toolbar)))},createPanels:function(){this.mapLayers=this.gui.layers&&"advanced"===this.gui.layers.type?Ext.create("OpenEMap.view.layer.Advanced",Ext.apply({mapPanel:this.mapPanel,orginalConfig:this.orginalConfig},this.gui.layers)):Ext.create("OpenEMap.view.layer.Basic",Ext.apply({mapPanel:this.mapPanel},this.gui.layers));
this.searchFastighet=Ext.create("OpenEMap.view.SearchFastighet",Ext.apply({mapPanel:this.mapPanel,basePath:this.config.basePath,search:this.search},this.gui.searchFastighet));if(this.gui.layers&&!this.gui.layers.renderTo){var b=[this.mapLayers];this.gui.searchFastighet&&!this.gui.searchFastighet.renderTo&&b.push(this.searchFastighet);this.rightPanel=Ext.create("Ext.panel.Panel",{y:20,layout:{type:"vbox",align:"stretch"},width:300,border:!1,style:{right:"20px"},bodyStyle:{background:"transparent"},items:b})
}!this.map.allOverlays&&this.gui.baseLayers&&(this.baseLayers=Ext.create("OpenEMap.view.BaseLayers",Ext.apply({mapPanel:this.mapPanel,y:20,style:{right:"45%"},width:115},this.gui.baseLayers)));this.gui.zoomTools&&!this.gui.zoomTools.renderTo&&(this.zoomTools=Ext.create("OpenEMap.view.ZoomTools",Ext.apply({mapPanel:this.mapPanel,x:20,y:20,width:36},this.gui.zoomTools)));this.gui.searchCoordinate&&this.gui.searchCoordinate.renderTo&&(this.searchCoordinate=Ext.create("OpenEMap.view.SearchCoordinate",Ext.apply({mapPanel:this.mapPanel},this.gui.searchCoordinate)));
this.gui.objectConfig&&this.gui.objectConfig.renderTo?this.objectConfig=Ext.create("OpenEMap.view.ObjectConfig",Ext.apply({mapPanel:this.mapPanel,gui:this},this.gui.objectConfig)):this.gui.objectConfig&&(this.objectConfig=Ext.create("OpenEMap.view.ObjectConfig",Ext.apply({mapPanel:this.mapPanel,gui:this},this.gui.objectConfig)),this.objectConfigWindow=Ext.create("Ext.window.Window",Ext.apply({title:this.objectConfigWindowTitle,width:480,height:300,layout:"fit",closable:!1,collapsible:!0,items:this.objectConfig},this.gui.objectConfig)),this.objectConfigWindow.show())
}});Ext.define("OpenEMap.model.Server",{extend:Ext.data.Model,fields:["id","type","url","proxy"]});Ext.define("OpenEMap.data.Servers",{extend:Ext.data.Store,model:"OpenEMap.model.Server",storeId:"servers",singelton:!0,constructor:function(b){b=Ext.apply(this,b);this.url&&(this.proxy={type:"ajax",url:this.url,reader:{type:"json",root:"configs"}});this.callParent([b])}});Ext.define("OpenEMap.config.Parser",{constructor:function(b){Ext.apply(this,b);this.callParent(arguments)},parse:function(e){var d={fallThrough:!0,controls:["Navigation","KeyboardDefaults"],projection:"EPSG:3006",resolutions:[280,140,70,28,14,7,4.2,2.8,1.4,0.56,0.28,0.14,0.112],extent:[608114,6910996,641846,6932596],maxExtent:[487000,6887000,749144,7149144],units:"m",municipalities:["Sundvsall","Timr\u00e5","Kramfors","\u00d6rnsk\u00f6ldsvik","H\u00e4rn\u00f6sand"],theme:null};
d.resolutions=e.resolutions||d.resolutions;d.units=e.units||d.units;d.projection=e.projection||d.projection;d.maxExtent=e.maxExtent;d.extent=e.extent;d.municipalities=e.municipalities||d.municipalities;d.controls=d.controls.map(this.createControl);Ext.apply(d,e.map);f=e.layers.map(this.transformLayer);e=this.parseLayerTree(f);var f=this.extractLayers(e);d.allOverlays=!f.some(this.isBaseLayer,this);d.layers=f.map(function(b){return b.layer});d.layers=d.layers.filter(function(b){return b});d=new OpenLayers.Map(d);
d.layerTree=e;d.layerSwitcherLayerTree=this.getLayerSwitcherLayers(e);return d},parseLayerTree:function(b){b.forEach(this.iterateLayers,this);return b},getLayerSwitcherLayers:function(b){return b.filter(function(c){return c.layers||this.isWMSLayer(c)&&!this.isBaseLayer(c)?!0:!1},this)},extractLayers:function(d){var c=d.filter(function(b){return !b.layers});d=d.filter(function(b){return b.layers}).map(function(b){return b.layers});d=[].concat.apply([],d);d=c.concat(d);d.reverse();return d},extractWFS:function(b){b=this.extractLayers(b);
return b=b.filter(function(c){return c.wfs})},getOptions:function(b){if(b.wms){return b.wms.options}if(b.osm){return b.osm.options}if(b.google){return b.google.options}if(b.bing){return b.bing.options}},isOpenLayersLayer:function(b){return b.wms||b.osm||b.google||b.bing?!0:!1},isBaseLayer:function(b){return(b=this.getOptions(b))&&b.isBaseLayer?!0:!1},createControl:function(b){return b.constructor==String?new OpenLayers.Control[b]:new OpenLayers.Control[b.type](b.options)},isWMSLayer:function(b){return b.wms?!0:!1
},transformLayer:function(b){b.url&&(b.wms={url:b.url,params:b.params,options:b.options});return b},createLayer:function(b){if(b.wms){return new OpenLayers.Layer.WMS(b.name,b.wms.url,b.wms.params,b.wms.options)}if(b.osm){return new OpenLayers.Layer.OSM(b.name,b.osm.url,b.osm.options)}if(b.google){return new OpenLayers.Layer.Google(b.name,b.google.options)}if(b.bing){return new OpenLayers.Layer.Bing(Ext.apply({name:b.name},b.bing.options))}throw Error("Unknown layer type")},iterateLayers:function(e){e.text=e.name;
e.checked=e.wms&&e.wms.options?e.wms.options.visibility:!1;if("undefined"!==typeof e.serverId&&""!==e.serverId){var d=this.serverStore.getById(e.serverId);if(d){if(e.wms&&!e.wms.url){var f="/wms";e.wms.gwc&&(f="/gwc/service/wms");e.wms.url=d.get("url")+f}e.wfs&&!e.wfs.url&&(e.wfs.url=d.get("url"))}}this.isOpenLayersLayer(e)&&(e.layer=this.createLayer(e));e.layers?(e.expanded=void 0==e.expanded?!0:e.expanded,e.layers.forEach(arguments.callee,this)):e.leaf=!0}});Ext.define("OpenEMap.form.ZoomSelector",{extend:Ext.form.ComboBox,emptyText:"Zoom Level",listConfig:{getInnerTpl:function(){return"1: {scale:round(0)}"
}},width:120,editable:!1,triggerAction:"all",queryMode:"local",initComponent:function(){this.store=Ext.create("GeoExt.data.ScaleStore",{map:this.map});this.listeners={select:{fn:function(d,c){this.map.zoomTo(c[0].get("level"))},scope:this}};this.map.events.register("zoomend",this,function(){var b=this.store.queryBy(function(c){return this.map.getZoom()==c.data.level});0<b.length?(b=b.items[0],this.setValue("1 : "+parseInt(b.data.scale))):zoomSelector.rendered&&this.clearValue()});this.callParent(arguments)
}});Ext.define("OpenEMap.OpenLayers.Control.ModifyFeature",{});OpenLayers.Control.ModifyFeature=OpenLayers.Class(OpenLayers.Control,{bySegment:!1,documentDrag:!1,geometryTypes:null,clickout:!0,toggle:!0,standalone:!1,layer:null,feature:null,vertex:null,vertices:null,virtualVertices:null,handlers:null,deleteCodes:null,virtualStyle:null,dragHandleStyle:null,radiusHandleStyle:null,vertexRenderIntent:null,mode:null,createVertices:!0,modified:!1,radiusHandle:null,dragHandle:null,onModificationStart:function(){},onModification:function(){},onModificationEnd:function(){},initialize:function(f,e){e=e||{};
this.layer=f;this.vertices=[];this.virtualVertices=[];this.virtualStyle=OpenLayers.Util.extend({},this.layer.style||this.layer.styleMap.createSymbolizer(null,e.vertexRenderIntent));this.virtualStyle.fillOpacity=0.3;this.virtualStyle.strokeOpacity=0.3;this.deleteCodes=[46,68];this.mode=OpenLayers.Control.ModifyFeature.RESHAPE;OpenLayers.Control.prototype.initialize.apply(this,[e]);OpenLayers.Util.isArray(this.deleteCodes)||(this.deleteCodes=[this.deleteCodes]);var h=this,g={documentDrag:this.documentDrag,setEvent:function(d){var c=h.feature;
h._lastVertex=c?c.layer.getFeatureFromEvent(d):null;OpenLayers.Handler.Drag.prototype.setEvent.apply(this,arguments)},stopDown:!1};this.handlers={keyboard:new OpenLayers.Handler.Keyboard(this,{keydown:this.handleKeypress}),drag:new OpenLayers.Handler.Drag(this,{down:function(){this.vertex=null;var b=this.layer.getFeatureFromEvent(this.handlers.drag.evt);b?this.dragStart(b):this.clickout&&(this._unselect=this.feature)},move:function(b){delete this._unselect;this.vertex&&this.dragVertex(this.vertex,b)
},up:function(){this.handlers.drag.stopDown=!1;this._unselect&&(this.unselectFeature(this._unselect),delete this._unselect)},done:function(){this.vertex&&this.dragComplete(this.vertex)}},g)};if(this.bySegment){if(!window.rbush){throw Error("The rbush library is required")}if(OpenLayers.Control.ModifyFeature.BySegment){OpenLayers.Util.extend(this,OpenLayers.Control.ModifyFeature.BySegment)}else{throw Error("OpenLayers.Control.ModifyFeature.BySegment is missing from the build")}}},createVirtualVertex:function(e,d){var f=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point((e.x+d.x)/2,(e.y+d.y)/2),null,this.virtualStyle);
f._sketch=!0;return f},destroy:function(){this.map&&this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this});this.layer=null;OpenLayers.Control.prototype.destroy.apply(this,[])},activate:function(){return OpenLayers.Control.prototype.activate.apply(this,arguments)?(this.moveLayerToTop(),this.map.events.on({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),this._lastVertex=null,this.handlers.keyboard.activate()&&this.handlers.drag.activate()):!1
},deactivate:function(){var b=!1;OpenLayers.Control.prototype.deactivate.apply(this,arguments)&&(this.moveLayerBack(),this.map.events.un({removelayer:this.handleMapEvents,changelayer:this.handleMapEvents,scope:this}),this.layer.removeFeatures(this.vertices,{silent:!0}),this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.vertices=[],this.handlers.drag.deactivate(),this.handlers.keyboard.deactivate(),(b=this.feature)&&(b.geometry&&b.layer)&&this.unselectFeature(b),b=!0);return b},beforeSelectFeature:function(b){return this.layer.events.triggerEvent("beforefeaturemodified",{feature:b})
},selectFeature:function(d){if(!(this.feature===d||this.geometryTypes&&-1==OpenLayers.Util.indexOf(this.geometryTypes,d.geometry.CLASS_NAME))){!1!==this.beforeSelectFeature(d)&&(this.feature&&this.unselectFeature(this.feature),this.feature=d,this.layer.selectedFeatures.push(d),this.layer.drawFeature(d,"select"),this.modified=!1,this.resetVertices(),this.onModificationStart(this.feature));var c=d.modified;if(d.geometry&&(!c||!c.geometry)){this._originalGeometry=d.geometry.clone()}}},unselectFeature:function(b){this.layer.removeFeatures(this.vertices,{silent:!0});
this.vertices=[];this.layer.destroyFeatures(this.virtualVertices,{silent:!0});this.virtualVertices=[];this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),delete this.dragHandle);this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),delete this.radiusHandle);this.layer.drawFeature(this.feature,"default");this.feature=null;OpenLayers.Util.removeItem(this.layer.selectedFeatures,b);this.onModificationEnd(b);this.layer.events.triggerEvent("afterfeaturemodified",{feature:b,modified:this.modified});
this.modified=!1},dragStart:function(d){var c="OpenLayers.Geometry.Point"==d.geometry.CLASS_NAME;if(!this.standalone&&(!d._sketch&&c||!d._sketch)){this.toggle&&this.feature===d&&(this._unselect=d),this.selectFeature(d)}if(this.feature&&(d._sketch||c&&d===this.feature)){this.vertex=d,this.handlers.drag.stopDown=!0}},dragVertex:function(f,e){var h=this.map.getLonLatFromViewPortPx(e),g=f.geometry;g.move(h.lon-g.x,h.lat-g.y);this.modified=!0;"OpenLayers.Geometry.Point"==this.feature.geometry.CLASS_NAME?this.layer.events.triggerEvent("vertexmodified",{vertex:f.geometry,feature:this.feature,pixel:e}):(f._index?(-1==f._index&&(f._index=OpenLayers.Util.indexOf(f.geometry.parent.components,f._next)),f.geometry.parent.addComponent(f.geometry,f._index),delete f._index,OpenLayers.Util.removeItem(this.virtualVertices,f),this.vertices.push(f)):f==this.dragHandle?(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[],this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null)):f!==this.radiusHandle&&this.layer.events.triggerEvent("vertexmodified",{vertex:f.geometry,feature:this.feature,pixel:e}),0<this.virtualVertices.length&&(this.layer.destroyFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]),this.layer.drawFeature(this.feature,this.standalone?void 0:"select"));
this.layer.drawFeature(f)},dragComplete:function(){this.resetVertices();this.setFeatureState();this.onModification(this.feature);this.layer.events.triggerEvent("featuremodified",{feature:this.feature})},setFeatureState:function(){if(this.feature.state!=OpenLayers.State.INSERT&&this.feature.state!=OpenLayers.State.DELETE&&(this.feature.state=OpenLayers.State.UPDATE,this.modified&&this._originalGeometry)){var b=this.feature;b.modified=OpenLayers.Util.extend(b.modified,{geometry:this._originalGeometry});
delete this._originalGeometry}},resetVertices:function(){0<this.vertices.length&&(this.layer.removeFeatures(this.vertices,{silent:!0}),this.vertices=[]);0<this.virtualVertices.length&&(this.layer.removeFeatures(this.virtualVertices,{silent:!0}),this.virtualVertices=[]);this.dragHandle&&(this.layer.destroyFeatures([this.dragHandle],{silent:!0}),this.dragHandle=null);this.radiusHandle&&(this.layer.destroyFeatures([this.radiusHandle],{silent:!0}),this.radiusHandle=null);this.feature&&"OpenLayers.Geometry.Point"!=this.feature.geometry.CLASS_NAME&&(this.mode&OpenLayers.Control.ModifyFeature.DRAG&&this.collectDragHandle(),this.mode&(OpenLayers.Control.ModifyFeature.ROTATE|OpenLayers.Control.ModifyFeature.RESIZE)&&this.collectRadiusHandle(),this.mode&OpenLayers.Control.ModifyFeature.RESHAPE&&(this.mode&OpenLayers.Control.ModifyFeature.RESIZE||this.collectVertices()))
},handleKeypress:function(d){var c=d.keyCode;if(this.feature&&-1!=OpenLayers.Util.indexOf(this.deleteCodes,c)&&(c=this._lastVertex)&&-1!=OpenLayers.Util.indexOf(this.vertices,c)&&!this.handlers.drag.dragging&&c.geometry.parent){c.geometry.parent.removeComponent(c.geometry),this.layer.events.triggerEvent("vertexremoved",{vertex:c.geometry,feature:this.feature,pixel:d.xy}),this.layer.drawFeature(this.feature,this.standalone?void 0:"select"),this.modified=!0,this.resetVertices(),this.setFeatureState(),this.onModification(this.feature),this.layer.events.triggerEvent("featuremodified",{feature:this.feature})
}},collectVertices:function(){function d(j){var i,h,a;if("OpenLayers.Geometry.Point"==j.CLASS_NAME){h=new OpenLayers.Feature.Vector(j),h._sketch=!0,h.renderIntent=c.vertexRenderIntent,c.vertices.push(h)}else{a=j.components.length;"OpenLayers.Geometry.LinearRing"==j.CLASS_NAME&&(a-=1);for(i=0;i<a;++i){h=j.components[i],"OpenLayers.Geometry.Point"==h.CLASS_NAME?(h=new OpenLayers.Feature.Vector(h),h._sketch=!0,h.renderIntent=c.vertexRenderIntent,c.vertices.push(h)):d(h)}if(c.createVertices&&"OpenLayers.Geometry.MultiPoint"!=j.CLASS_NAME){i=0;
for(a=j.components.length;i<a-1;++i){h=j.components[i];var b=j.components[i+1];"OpenLayers.Geometry.Point"==h.CLASS_NAME&&"OpenLayers.Geometry.Point"==b.CLASS_NAME&&(h=c.createVirtualVertex.call(c,h,b),h.geometry.parent=j,h._index=i+1,c.virtualVertices.push(h))}}}}this.vertices=[];this.virtualVertices=[];var c=this;d.call(this,this.feature.geometry);this.layer.addFeatures(this.virtualVertices,{silent:!0});this.layer.addFeatures(this.vertices,{silent:!0})},collectDragHandle:function(){var e=this.feature.geometry,d=e.getBounds().getCenterLonLat(),d=new OpenLayers.Geometry.Point(d.lon,d.lat),f=new OpenLayers.Feature.Vector(d,null,this.dragHandleStyle);
d.move=function(a,g){OpenLayers.Geometry.Point.prototype.move.call(this,a,g);e.move(a,g)};f._sketch=!0;this.dragHandle=f;this.dragHandle.renderIntent=this.vertexRenderIntent;this.layer.addFeatures([this.dragHandle],{silent:!0})},collectRadiusHandle:function(){var i=this.feature.geometry,h=i.getBounds(),n=h.getCenterLonLat(),m=new OpenLayers.Geometry.Point(n.lon,n.lat),h=new OpenLayers.Geometry.Point(h.right,h.bottom),n=new OpenLayers.Feature.Vector(h,null,this.radiusHandleStyle),l=this.mode&OpenLayers.Control.ModifyFeature.RESIZE,j=this.mode&OpenLayers.Control.ModifyFeature.RESHAPE,k=this.mode&OpenLayers.Control.ModifyFeature.ROTATE;
h.move=function(d,s){OpenLayers.Geometry.Point.prototype.move.call(this,d,s);var f=this.x-m.x,e=this.y-m.y,a=f-d,r=e-s;if(k){var o=Math.atan2(r,a),o=Math.atan2(e,f)-o,o=o*(180/Math.PI);i.rotate(o,m)}if(l){var g;j?(e/=r,g=f/a/e):(a=Math.sqrt(a*a+r*r),e=Math.sqrt(f*f+e*e)/a);i.resize(e,m,g)}};n._sketch=!0;this.radiusHandle=n;this.radiusHandle.renderIntent=this.vertexRenderIntent;this.layer.addFeatures([this.radiusHandle],{silent:!0})},setMap:function(b){this.handlers.drag.setMap(b);OpenLayers.Control.prototype.setMap.apply(this,arguments)
},handleMapEvents:function(b){("removelayer"==b.type||"order"==b.property)&&this.moveLayerToTop()},moveLayerToTop:function(){var b=Math.max(this.map.Z_INDEX_BASE.Feature-1,this.layer.getZIndex())+1;this.layer.setZIndex(b)},moveLayerBack:function(){var b=this.layer.getZIndex()-1;b>=this.map.Z_INDEX_BASE.Feature?this.layer.setZIndex(b):this.map.setLayerZIndex(this.layer,this.map.getLayerIndex(this.layer))},CLASS_NAME:"OpenLayers.Control.ModifyFeature"});OpenLayers.Control.ModifyFeature.RESHAPE=1;OpenLayers.Control.ModifyFeature.RESIZE=2;
OpenLayers.Control.ModifyFeature.ROTATE=4;OpenLayers.Control.ModifyFeature.DRAG=8;Ext.define("OpenEMap.OpenLayers.Control.DynamicMeasure",{});OpenLayers.Control.DynamicMeasure=OpenLayers.Class(OpenLayers.Control.Measure,{accuracy:5,persist:!1,styles:null,positions:null,maxSegments:1,maxHeadings:1,layerSegmentsOptions:void 0,layerHeadingOptions:null,layerLengthOptions:void 0,layerAreaOptions:void 0,drawingLayer:null,multi:!1,layerSegments:null,layerLength:null,layerArea:null,dynamicObj:null,isArea:null,initialize:function(g,f){f=f||{};
f.handlerOptions=OpenLayers.Util.extend({persist:!f.drawingLayer},f.handlerOptions);f.drawingLayer&&!("multi" in f.handlerOptions)&&(f.handlerOptions.multi=f.multi);if(f.drawingLayer){var j=f.drawingLayer.styleMap&&f.drawingLayer.styleMap.styles.temporary;j&&(f.handlerOptions.layerOptions=OpenLayers.Util.applyDefaults(f.handlerOptions.layerOptions,{styleMap:new OpenLayers.StyleMap({"default":j})}))}j=f.styles||{};f.styles=j;var i=OpenLayers.Control.DynamicMeasure.styles;if(!f.handlerOptions.layerOptions||!f.handlerOptions.layerOptions.styleMap){j=new OpenLayers.Style(null,{rules:[new OpenLayers.Rule({symbolizer:{Point:OpenLayers.Util.applyDefaults(j.Point,i.Point),Line:OpenLayers.Util.applyDefaults(j.Line,i.Line),Polygon:OpenLayers.Util.applyDefaults(j.Polygon,i.Polygon)}})]}),f.handlerOptions=f.handlerOptions||{},f.handlerOptions.layerOptions=f.handlerOptions.layerOptions||{},f.handlerOptions.layerOptions.styleMap=new OpenLayers.StyleMap({"default":j})
}f.positions=OpenLayers.Util.applyDefaults(f.positions,OpenLayers.Control.DynamicMeasure.positions);f.callbacks=f.callbacks||{};f.drawingLayer&&OpenLayers.Util.applyDefaults(f.callbacks,{create:function(d,c){this.callbackCreate(d,c);this.drawingLayer.events.triggerEvent("sketchstarted",{vertex:d,feature:c})},modify:function(d,c){this.callbackModify(d,c);this.drawingLayer.events.triggerEvent("sketchmodified",{vertex:d,feature:c})},done:function(b){this.callbackDone(b);this.drawFeature(b)}});OpenLayers.Util.applyDefaults(f.callbacks,{create:this.callbackCreate,point:this.callbackPoint,cancel:this.callbackCancel,done:this.callbackDone,modify:this.callbackModify,redo:this.callbackRedo,undo:this.callbackUndo});
var h=document.onselectstart?document.onselectstart:OpenLayers.Function.True,j=OpenLayers.Class(g,{down:function(a){document.onselectstart=OpenLayers.Function.False;return g.prototype.down.apply(this,arguments)},up:function(a){document.onselectstart=h;return g.prototype.up.apply(this,arguments)},move:function(a){this.mouseDown||(document.onselectstart=h);return g.prototype.move.apply(this,arguments)},mouseout:function(a){OpenLayers.Util.mouseLeft(a,this.map.viewPortDiv)&&this.mouseDown&&(document.onselectstart=h);
return g.prototype.mouseout.apply(this,arguments)},finalize:function(){document.onselectstart=h;g.prototype.finalize.apply(this,arguments)}},{undo:function(){var a=g.prototype.undo.call(this);a&&this.callback("undo",[this.point.geometry,this.getSketch(),!0]);return a},redo:function(){var a=g.prototype.redo.call(this);a&&this.callback("redo",[this.point.geometry,this.getSketch(),!0]);return a}});OpenLayers.Control.Measure.prototype.initialize.call(this,j,f);this.isArea=void 0!==g.prototype.polygon
},destroy:function(){this.deactivate();OpenLayers.Control.Measure.prototype.destroy.apply(this,arguments)},draw:function(){},activate:function(){var g=OpenLayers.Control.Measure.prototype.activate.apply(this,arguments);if(g){this.dynamicObj={};var f=this.styles||{},j=OpenLayers.Control.DynamicMeasure.styles,i=this,h=function(b,d){if(null===d){return null}var c=OpenLayers.Util.extend({displayInLayerSwitcher:!1,calculateInRange:OpenLayers.Function.True},d);c.styleMap||(c.styleMap=new OpenLayers.StyleMap({"default":OpenLayers.Util.applyDefaults(f[b],j[b])}));
c=new OpenLayers.Layer.Vector(i.CLASS_NAME+" "+b,c);i.map.addLayer(c);i.map.setLayerIndex(c,99);return c};this.layerSegments=h("labelSegments",this.layerSegmentsOptions);this.layerHeading=h("labelHeading",this.layerHeadingOptions);this.layerLength=h("labelLength",this.layerLengthOptions);this.isArea&&(this.layerArea=h("labelArea",this.layerAreaOptions))}return g},deactivate:function(){var b=OpenLayers.Control.Measure.prototype.deactivate.apply(this,arguments);b&&(this.layerSegments&&this.layerSegments.destroy(),this.layerLength&&this.layerLength.destroy(),this.layerHeading&&this.layerHeading.destroy(),this.layerArea&&this.layerArea.destroy(),this.layerArea=this.layerHeading=this.layerLength=this.layerSegments=this.dynamicObj=null);
return b},setImmediate:function(b){this.immediate=b},callbackCreate:function(){var b=this.dynamicObj;b.drawing=!1;b.freehand=!1;b.fromIndex=0;b.countSegments=0},callbackCancel:function(){this.destroyLabels()},callbackDone:function(d){var c=new OpenLayers.Feature.Vector(d);this.mapPanel.measureLayer.addFeatures([c.clone()]);c=function(b){return b.clone()};this.layerArea&&this.mapPanel.measureLayerArea.addFeatures(this.layerArea.features.map(c));this.mapPanel.measureLayerLength.addFeatures(this.layerLength.features.map(c));
this.mapPanel.measureLayerSegments.addFeatures(this.layerSegments.features.map(c));this.measureComplete(d);this.persist||this.destroyLabels()},drawFeature:function(b){b=new OpenLayers.Feature.Vector(b);!1!==this.drawingLayer.events.triggerEvent("sketchcomplete",{feature:b})&&(b.state=OpenLayers.State.INSERT,this.featureAdded&&this.featureAdded(b),this.events.triggerEvent("featureadded",{feature:b}))},destroyLabels:function(){this.layerSegments&&this.layerSegments.destroyFeatures(null,{silent:!0});
this.layerLength&&this.layerLength.destroyFeatures(null,{silent:!0});this.layerHeading&&this.layerHeading.destroyFeatures(null,{silent:!0});this.layerArea&&this.layerArea.destroyFeatures(null,{silent:!0})},callbackPoint:function(e,d){var f=this.dynamicObj;f.drawing||this.destroyLabels();this.handler.freehandMode(this.handler.evt)?f.freehand||(f.fromIndex=this.handler.getCurrentPointIndex()-1,f.freehand=!0,f.countSegments++):(f.fromIndex=this.handler.getCurrentPointIndex()-1,f.freehand=!1,f.countSegments++);
this.measurePartial(e,d);f.drawing=!0},callbackUndo:function(f,e){var h=this,g=function(i){if(i){var c=i.features,o=c.length-1,n=c[o],m=n.attributes.from,l=h.handler.getCurrentPointIndex();m>=l&&(m=h.dynamicObj,i.destroyFeatures(n),n=c[o-1],m.fromIndex=n.attributes.from,m.countSegments=c.length)}};g(this.layerSegments);g(this.layerHeading);this.callbackModify(f,e,!0)},callbackRedo:function(g,f){var j=this.handler.line.geometry,i=this.handler.getCurrentPointIndex(),h=this.dynamicObj;this.showLabelSegment(h.countSegments,h.fromIndex,j.components.slice(h.fromIndex,i));
h.fromIndex=this.handler.getCurrentPointIndex()-1;h.countSegments++;this.callbackModify(g,f,!0)},callbackModify:function(j,i,p){this.immediate&&this.measureImmediate(j,i,p);var o=this.dynamicObj;if(!1!==o.drawing){var n=this.handler.line.geometry;p=this.handler.getCurrentPointIndex();!this.handler.freehandMode(this.handler.evt)&&o.freehand&&(o.fromIndex=p-1,o.freehand=!1,o.countSegments++);var l=this.getBestLength(n);if(l[0]){var m=this.positions,k={center:function(){var a=i.geometry.getBounds().clone();
a.extend(j);a=a.getCenterLonLat();return[a.lon,a.lat]},initial:function(){var b=n.components[0];return[b.x,b.y]},start:function(){var b=n.components[o.fromIndex];return[b.x,b.y]},middle:function(){var a=n.components[o.fromIndex];return[(a.x+j.x)/2,(a.y+j.y)/2]},end:function(){return[j.x,j.y]}};this.layerLength&&this.showLabel(this.layerLength,1,0,l,k[m.labelLength](),1);this.isArea&&(this.layerArea&&this.showLabel(this.layerArea,1,0,this.getBestArea(i.geometry),k[m.labelArea](),1),this.showLabelSegment(1,0,[n.components[0],n.components[p]])&&o.countSegments++);
this.showLabelSegment(o.countSegments,o.fromIndex,n.components.slice(o.fromIndex,p+1))}}},showLabelSegment:function(t,s,r){var q=this.layerSegments,p=this.layerHeading;if(!q&&!p){return !1}for(var n=[],o=r.length,m=0;m<o;m++){n.push(r[m].clone())}var l=n[0],i=n[o-1],m=this.getBestLength(new OpenLayers.Geometry.LineString(n));r=this.positions;n={start:function(){return[l.x,l.y]},middle:function(){return[(l.x+i.x)/2,(l.y+i.y)/2]},end:function(){return[i.x,i.y]}};o=!1;q&&(o=this.showLabel(q,t,s,m,n[r.labelSegments](),this.maxSegments));
p&&0<m[0]&&(q=90-180*Math.atan2(i.y-l.y,i.x-l.x)/Math.PI,0>q&&(q+=360),o=o||this.showLabel(p,t,s,[q,"\u00b0"],n[r.labelHeading](),this.maxHeadings));return o},showLabel:function(i,h,n,m,l,j){var k;k=i.features;if(k.length<h){if(0===m[0]){return !1}h=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(l[0],l[1]),{from:n});this.setMesureAttributes(h.attributes,m);i.addFeatures([h]);null!==j&&(m=k.length-j-1,0<=m&&(k=k[m],k.style={display:"none"},i.drawFeature(k)));return !0}h=k[h-1];n=h.geometry;
n.x=l[0];n.y=l[1];n.clearBounds();this.setMesureAttributes(h.attributes,m);i.drawFeature(h);null!==j&&(m=k.length-j,0<=m&&(k=k[m],k.style&&(delete k.style,i.drawFeature(k))));return !1},setMesureAttributes:function(d,c){d.measure=OpenLayers.Number.format(c[0].toFixed(2),null);d.units=c[1]},CLASS_NAME:"OpenLayers.Control.DynamicMeasure"});OpenLayers.Control.DynamicMeasure.styles={Point:{pointRadius:4,graphicName:"square",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#333333"},Line:{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",strokeDashstyle:"solid",fillColor:"white",fillOpacity:0.3},labelSegments:{label:"${measure} ${units}",fontSize:"12px",fontColor:"#800517",fontFamily:"Verdana",labelOutlineColor:"#eeeeee",labelAlign:"cm",labelOutlineWidth:2},labelLength:{label:"${measure} ${units}\n",fontSize:"12px",fontWeight:"bold",fontColor:"#800517",fontFamily:"Verdana",labelOutlineColor:"#eeeeee",labelAlign:"lb",labelOutlineWidth:3},labelArea:{label:"${measure}\n${units}\u00b2\n",fontSize:"11px",fontWeight:"bold",fontColor:"#800517",fontFamily:"Verdana",labelOutlineColor:"#dddddd",labelAlign:"cm",labelOutlineWidth:3},labelHeading:{label:"${measure} ${units}",fontSize:"11px",fontColor:"#800517",fontFamily:"Verdana",labelOutlineColor:"#dddddd",labelAlign:"cm",labelOutlineWidth:3}};
OpenLayers.Control.DynamicMeasure.positions={labelSegments:"middle",labelLength:"end",labelArea:"center",labelHeading:"start"};Ext.ns("OpenEMap");Ext.apply(OpenEMap,{lmUser:"sundsvall",basePathMapFish:"/print/pdf",basePathLM:"/search/lm/",basePathImages:"resources/images/",wsUrls:{basePath:"/openemapadmin/",configs:"configurations/configs",servers:"settings/servers",layers:"layers/layers",metadata:"geometadata/getmetadatabyid",metadata_abstract:"geometadata/getabstractbyid"}});Ext.apply(OpenEMap,{requestLM:function(b){b.url=OpenEMap.basePathLM+b.url+"\x26lmuser\x3d"+OpenEMap.lmUser;
Ext.Ajax.request(b)}});Ext.define("OpenEMap.Client",{version:"1.0.4",map:null,drawLayer:null,destroy:function(){this.map&&(this.map.controls.forEach(function(b){b.destroy()}),this.map.controls=null);this.gui&&this.gui.destroy()},configure:function(d,c){c=Ext.apply({},c);this.initialConfig=Ext.clone(d);Ext.tip.QuickTipManager.init();this.map=Ext.create("OpenEMap.config.Parser").parse(d);this.gui=Ext.create("OpenEMap.Gui",{config:d,gui:c.gui,map:this.map,orginalConfig:this.initialConfig});this.mapPanel=this.gui.mapPanel;
this.drawLayer=this.gui.mapPanel.drawLayer;this.gui.controlToActivate&&this.gui.controlToActivate.activate()},encode:function(b){return JSON.stringify(this.mapPanel.encode(b))},addGeoJSON:function(b){b=(new OpenLayers.Format.GeoJSON).read(b,"Feature");b.attributes.config&&(b=Ext.create("OpenEMap.ObjectFactory").create(b.attributes.config,b.attributes));this.drawLayer.addFeatures([b])},setSketchStyleMap:function(b){this.map.controls.forEach(function(a){a instanceof OpenLayers.Control.DrawFeature&&(a.handler.layerOptions.styleMap=b,a.handler.layer&&(a.handler.layer.styleMap=b))
})},toggleEdgeLabels:function(d){var c=d||{};d=function(){this.labelLayer.destroyFeatures();var b=this.drawLayer.features.map(function(e){e=e.geometry;if("OpenLayers.Geometry.Polygon"!=e.CLASS_NAME){return[]}var f=e.components[0];return f.components.slice(0,f.components.length-1).map(function(g,l){var k=f.components[l].clone(),i=f.components[l+1].clone(),i=new OpenLayers.Geometry.LineString([k,i]),k=i.getCentroid({weighted:!0}),i=Ext.applyIf(Ext.clone(c),{label:i.getLength().toFixed(2).toString()+" m",strokeColor:"#000000",strokeWidth:3,labelAlign:"cm"});
return new OpenLayers.Feature.Vector(k,null,i)})});0<b.length&&(b=b.reduce(function(f,e){return f.concat(e)}),this.labelLayer.addFeatures(b))};null==this.labelLayer&&(this.labelLayer=new OpenLayers.Layer.Vector,this.map.addLayer(this.labelLayer),this.drawLayer.events.on({featuremodified:d,vertexmodified:d,featuresadded:d,featuresremoved:d,scope:this}));d.apply(this)}});Ext.ns("OpenEMap");Ext.apply(OpenEMap,{lmUser:"sundsvall",basePathMapFish:"/print/pdf",basePathLM:"/search/lm/",basePathImages:"resources/images/",wsUrls:{basePath:"/openemapadmin/",configs:"configs",servers:"settings/servers",layers:"layers/layers",metadata:"geometadata/getmetadatabyid",metadata_abstract:"geometadata/getabstractbyid"}});
Ext.apply(OpenEMap,{requestLM:function(b){b.url=OpenEMap.basePathLM+b.url+"\x26lmuser\x3d"+OpenEMap.lmUser;Ext.Ajax.request(b)}});OpenLayers.Layer.Vector.prototype.renderers=["Canvas","SVG","VML"];Ext.define("OpenEMap.locale.sv_SE.Gui",{override:"OpenEMap.Gui",objectConfigWindowTitle:"Objektkonfiguration"});Ext.define("OpenEMap.locale.sv_SE.view.ObjectConfig",{override:"OpenEMap.view.ObjectConfig",typeLabel:"Typ",widthLabel:"Bredd",lengthLabel:"L\u00e4ngd",m1Label:"M1",m2Label:"M2",angleLabel:"Vinkel"});
Ext.define("OpenEMap.Search",{constructor:function(){initConfig()},doSearch:function(){}});Ext.define("OpenEMap.data.DataHandler",{metadataAbstractWsUrl:null,metadataWsUrl:null,layersWsUrl:null,metadataAbstractCache:{},constructor:function(b){this.wsUrls=OpenEMap.wsUrls;Ext.apply(this,b)},getLayer:function(d,c){this.wsUrls.layers&&d&&this.doRequest({url:this.wsUrls.basePath+this.wsUrls.layers+"/"+d},function(b){c(b)})},getLayers:function(b){this.wsUrls.layers&&this.doRequest({url:this.wsUrls.basePath+this.wsUrls.layers},b)
},getMetadata:function(d,c){d&&this.wsUrls.metadata&&this.doRequest({url:this.wsUrls.basePath+this.wsUrls.metadata+"/"+d},c)},getMetadataAbstract:function(e,d){if(e&&this.wsUrls.metadata_abstract){var f=this;f.metadataAbstractCache[e]?d(f.metadataAbstractCache[e]):this.doRequest({url:this.wsUrls.basePath+this.wsUrls.metadata_abstract+"/"+e},function(a){d(a);f.metadataAbstractCache[e]=a})}},updateConfiguration:function(e,d,f){this.doRequest({url:this.wsUrls.basePath+this.wsUrls.configs+"/"+e,method:"PUT",jsonData:d},f)
},saveNewConfiguration:function(d,c){this.doRequest({url:this.wsUrls.basePath+this.wsUrls.configs,method:"POST",jsonData:d},c)},deleteConfiguration:function(e,d,f){this.doRequest({url:this.wsUrls.basePath+this.wsUrls.configs+"/"+e,method:"DELETE",jsonData:d},f)},doRequest:function(e,d){var f=this;if(e&&e.method&&("POST"===e.method&&"PUT"===e.method)&&!d){return f.onFailure("no callback function"),!1}Ext.Ajax.request(Ext.apply({success:function(b){if(b&&b.responseText){b=Ext.decode(b.responseText),d&&d(b)
}else{f.onFailure()}},failure:function(a){f.onFailure(a.status+" "+a.statusText+", "+e.url)}},e?e:{}))},onFailure:function(b){console.error(b)}});Ext.define("OpenEMap.model.GroupedLayerTreeModel",{extend:Ext.data.Model,fields:[{name:"text",type:"string"},{name:"checkedGroup",type:"string"},{name:"layer"},{name:"layerId"},{name:"name",type:"string"},{name:"isSearchable"},{name:"urlToMetadata"},{name:"wms"},{name:"wfs"},{name:"serverId"},{name:"legendURL"}]});Ext.define("OpenEMap.data.GroupedLayerTree",{extend:Ext.data.TreeStore,model:"OpenEMap.model.GroupedLayerTreeModel",defaultRootProperty:"layers",proxy:{type:"memory"},maxLayerIndex:1000,listeners:{beforeinsert:function(e,d,f){return this.onBeforeInsert(e,d,f)
},beforeappend:function(d,c){return this.onBeforeAppend(d,c)},insert:function(d,c){this.onInsertAndAppend(c)},append:function(d,c){this.onInsertAndAppend(c)},remove:function(e,d,f){this.onRemove(e,d,f)}},constructor:function(b){b=Ext.apply({},b);this.callParent([b])},getLayerConfiguration:function(){var b=[];this.getRootNode().childNodes.forEach(function(a,d){b[d]={name:a.get("name"),layers:[]};a.childNodes.forEach(function(c){b[d].layers.push({name:c.get("name"),wms:"string"===typeof c.get("wms")?{}:c.get("wms"),wfs:"string"===typeof c.get("wfs")?{}:c.get("wfs"),metadata:"string"===typeof c.get("metadata")?{}:c.get("metadata")})
})});return b},onBeforeAppend:function(d,c){return d&&!d.isRoot()&&!c.isLeaf()?!1:!0},onBeforeInsert:function(e,d,f){return !f.parentNode.isRoot()&&!d.isLeaf()?!1:!0},onInsertAndAppend:function(b){this._inserting||(this._inserting=!0,b.cascadeBy(function(d){var e=d.get("layer");d.getLayer=function(){return this.get("layer")};this.addWMSLegend(d);e&&""!==e&&this.map&&null===this.map.getLayer(e)&&(e&&!0===e.displayInLayerSwitcher)&&this.map.addLayer(e)},this),this.reorderLayersOnMap(),delete this._inserting)
},onRemove:function(e,d,f){!this._removing&&!f&&(this._removing=!0,d.cascadeBy(function(b){(b=b.get("layer"))&&b.map&&this.map.removeLayer(b)},this),delete this._removing)},reorderLayersOnMap:function(){var d=this.getRootNode();if(d){var c=this.maxLayerIndex;d.cascadeBy(function(b){if(b=b.get("layer")){b.setZIndex(c),c--}},this)}},addWMSLegend:function(d){var c=d.get("layer");if(c){if(Ext.isIE9){return d}c.legendURL?(d.set("legendURL",c.legendURL),d.gx_urllegend=Ext.create("GeoExt.container.UrlLegend",{layerRecord:d,showTitle:!1,hidden:!0,deferRender:!0,cls:"legend"})):"OpenLayers.Layer.WMS"==c.CLASS_NAME&&(d.gx_wmslegend=Ext.create("GeoExt.container.WmsLegend",{layerRecord:d,showTitle:!1,hidden:!0,deferRender:!0,cls:"legend"}))
}return d},unbind:function(){this.un("beforeinsert",this.onBeforeInsert,this);this.un("beforeappend",this.onBeforeAppend,this);this.un("insert",this.onInsertAndAppend,this);this.un("append",this.onInsertAndAppend,this);this.un("remove",this.onRemove,this);this.map=null},destroy:function(){}});Ext.define("OpenEMap.model.MapConfig",{extend:Ext.data.Model,fields:["configId","name"]});Ext.define("OpenEMap.data.SavedMapConfigs",{extend:Ext.data.Store,model:"OpenEMap.model.MapConfig",storeId:"savedMapConfigs",autoLoad:!0,proxy:{type:"rest",appendId:!0,url:OpenEMap&&OpenEMap.wsUrls&&OpenEMap.wsUrls.basePath?OpenEMap.wsUrls.basePath:""+(OpenEMap&&OpenEMap.wsUrls&&OpenEMap.wsUrls.configs)?OpenEMap.wsUrls.configs:"",reader:{type:"json",root:"configs"},writer:{type:"json"}}});
Ext.define("OpenEMap.view.MetadataWindow",{extend:Ext.Window,title:"Metadata",width:600,height:500,border:0,layout:"fit",closeAction:"hide",TRANSLATION:{sv:{tag:{"gmd:citation":"","gmd:CI_Address":"","gmd:CI_Citation":"","gmd:CI_Contact":"","gmd:CI_Date":"","gmd:CI_Telephone":"","gmd:CI_ResponsibleParty":"","gmd:identificationInfo":"","gmd:EX_BoundingPolygon":"","gmd:EX_Extent":"","gmd:EX_GeographicBoundingBox":"","gmd:EX_GeographicDescription":"","gmd:EX_TemporalExtent":"","gmd:EX_VerticalExtent":"","gmd:MD_BrowseGraphic":"","gmd:MD_Constraints":"","gmd:MD_Identifier":"","gmd:MD_Keywords":"","gmd:MD_LegalConstraints":"","gmd:MD_Metadata":"","gmd:MD_MaintenanceInformation":"","gmd:MD_SecurityConstraints":"","gmd:thesaurusName":"","gmd:voice":"","srv:SV_ServiceIdentification":"","gmd:accessConstraints":"Nyttjanderestriktioner","gmd:abstract":"Sammanfattning","gmd:address":"Adress","gmd:alternateTitle":"Alternativ titel","gmd:city":"Stad","gmd:classification":"Klassificering","gmd:contact":"Metadatakontakt","gmd:contactInfo":"Kontaktinformation","gmd:date":"Datum","gmd:dateStamp":"Datum","gmd:dateType":"Datumtyp","gmd:descriptiveKeywords":"Nyckelordslista","gmd:electronicMailAddress":"E-post","gmd:fileIdentifier":"Identifierare f\u00f6r metadatam\u00e4ngden","gmd:graphicOverview":"Exempelbild","gmd:hierarchyLevel":"Hierarkisk niv\u00e5 (Resurstyp)","gmd:individualName":"Person","gmd:identifier":"Identifierare","gmd:keyword":"Nyckelord","gmd:language":"Spr\u00e5k","gmd:metadataStandardName":"Metadatastandardversion","gmd:metadataStandardVersion":"Metadatastandard","gmd:organisationName":"Organisation","gmd:otherConstraints":"Andra restriktioner","gmd:phone":"Telefonnummer","gmd:pointOfContact":"Kontakt","gmd:resourceConstraints":"Restriktioner och begr\u00e4nsningar","gmd:role":"Ansvarsomr\u00e5de","gmd:status":"Status","gmd:title":"Titel","gmd:type":"Typ","gmd:useLimitation":"Anv\u00e4ndbarhetsbegr\u00e4nsningar"},codeListValue:{swe:"Svenska",service:"Tj\u00e4nst",pointOfContact:"Kontakt"}}},initComponent:function(){this.overviewTab=new Ext.Panel({title:"\u00d6versikt"});
this.metadataTab=new Ext.Panel({title:"Information om metadata"});this.dataTab=new Ext.Panel({title:"Information om data"});this.qualityTab=new Ext.Panel({title:"Kvalitet"});this.distributionTab=new Ext.Panel({title:"Distribution"});this.restTab=new Ext.Panel({title:"Rest"});this.items=Ext.create("Ext.tab.Panel",{activeTab:0,defaults:{autoScroll:!0},items:[this.overviewTab,this.metadataTab,this.dataTab,this.qualityTab,this.distributionTab,this.restTab]});this.callParent(arguments)},showMetadata:function(d){var c=this;
this.dataHandler.getMetadata(d,function(b){b.children&&(b=c.parseMetadata(b.children),c.overviewTab.html=b.overview,c.metadataTab.html=b.metadata_info,c.dataTab.html=b.data_info,c.qualityTab.html=b.quality,c.distributionTab.html=b.distribution,c.restTab.html=b.rest,c.show())})},translate:function(f,e){var h=null;try{h=this.TRANSLATION.sv[f][e],"string"!==typeof h&&(h=e)}catch(g){translateTag=null}return h},parseMetadataTextTag:function(d){var c=null;d.tag&&(c=this.translate("tag",d.tag),c=null!==c?""!==c?"\x3cb\x3e"+c+"\x3c/b\x3e":"":null);
d.text&&(c=d.text);d.attributes&&d.attributes.codeListValue&&(c=this.translate("codeListValue",d.attributes.codeListValue));return c},getGroups:function(f,e){var h=[];for(key in e){for(var g=0;g<e[key].length;g++){-1!==f.indexOf(e[key][g])&&h.push(key)}}0===h.length&&h.push("rest");return h},metadataIterator:function(r,q,p,o){var n=this.parseMetadataTextTag(r);o=("undefined"!==typeof o?o+"\x3e":"")+r.tag;for(var l=this.getGroups(o,p),m=0;m<l.length;m++){var k=l[m];"string"!==typeof q[k]&&(q[k]="");
if(null!==n){q[k]+="\x3cli\x3e";q[k]+=n;if(r.children&&0===m){q[k]+=""!==n?"\x3cul\x3e":"";for(var i=0;i<r.children.length;i++){this.metadataIterator(r.children[i],q,p,o)}q[k]+=""!==n?"\x3c/ul\x3e":""}q[k]+="\x3c/li\x3e"}}},parseMetadata:function(d){var c={};this.metadataIterator(d[0],c,{overview:["gmd:MD_Metadata\x3egmd:identificationInfo\x3esrv:SV_ServiceIdentification\x3egmd:citation\x3egmd:CI_Citation\x3egmd:title","gmd:MD_Metadata\x3egmd:identificationInfo\x3esrv:SV_ServiceIdentification\x3egmd:abstract","gmd:MD_Metadata\x3egmd:identificationInfo\x3esrv:SV_ServiceIdentification\x3egmd:descriptiveKeywords","gmd:MD_Metadata\x3egmd:identificationInfo\x3esrv:SV_ServiceIdentification\x3egmd:graphicOverview"],metadata_info:"gmd:MD_Metadata\x3egmd:fileIdentifier gmd:MD_Metadata\x3egmd:language gmd:MD_Metadata\x3egmd:dateStamp gmd:MD_Metadata\x3egmd:hierarchyLevel gmd:MD_Metadata\x3egmd:metadataStandardName gmd:MD_Metadata\x3egmd:metadataStandardVersion gmd:MD_Metadata\x3egmd:contact".split(" "),data_info:["gmd:MD_Metadata\x3egmd:identificationInfo"],quality:["gmd:MD_Metadata\x3egmd:dataQualityInfo"],distribution:["gmd:MD_Metadata\x3egmd:distributionInfo"]});
return c}});Ext.define("OpenEMap.view.layer.Tree",{extend:Ext.tree.Panel,rootVisible:!1,hideHeaders:!0,initComponent:function(){!this.store&&this.mapPanel&&(this.store=Ext.create("OpenEMap.data.GroupedLayerTree",{root:{text:this.mapPanel.config&&this.mapPanel.config.name?this.mapPanel.config.name:"Lager",expanded:!0,layers:this.mapPanel.map.layerSwitcherLayerTree},map:this.mapPanel.map}));this.on("checkchange",function(e,d){var f=e.parentNode;d?(e.cascadeBy(function(b){b.set("checked",d);(b=b.get("layer"))&&b.setVisibility(!0)
}),f.isRoot()||f.set("checked",d)):(e.cascadeBy(function(b){b.set("checked",!1);(b=b.get("layer"))&&b.setVisibility(!1)}),!f.isRoot()&&!f.childNodes.some(function(b){return b.get("checked")})&&f.set("checked",d))});this.on("cellclick",function(f,e,h,g){if((g.gx_wmslegend||g.gx_urllegend)&&g.store){f=g.gx_wmslegend||g.gx_urllegend,f.isHidden()?(f.rendered||f.render(e),f.show()):f.hide()}});this.callParent(arguments)}});Ext.define("OpenEMap.view.layer.TreeFilter",{extend:Ext.AbstractPlugin,alias:"plugin.treefilter",collapseOnClear:!0,allowParentFolders:!1,init:function(b){this.tree=b;
b.filter=Ext.Function.bind(this.filter,this);b.clearFilter=Ext.Function.bind(this.clearFilter,this)},filter:function(r,q,p){var o=this,n=o.tree,l=[],m=n.getRootNode();q=q||"text";p=p||RegExp(r,"ig");var k=[],i;Ext.isEmpty(r)?o.clearFilter():(n.expandAll(),m.cascadeBy(function(b){b.get(q).match(p)&&l.push(b)}),!1===o.allowParentFolders&&Ext.each(l,function(b){b.isLeaf()||Ext.Array.remove(l,b)}),Ext.each(l,function(b){m.cascadeBy(function(a){!0==a.contains(b)&&k.push(a)});!0===o.allowParentFolders&&!b.isLeaf()&&b.cascadeBy(function(c){k.push(c)
});k.push(b)}),m.cascadeBy(function(b){if(i=Ext.fly(n.getView().getNode(b))){i.setVisibilityMode(Ext.Element.DISPLAY),i.setVisible(Ext.Array.contains(k,b))}}))},clearFilter:function(){var d=this.tree,c=d.getRootNode();this.collapseOnClear&&d.collapseAll();c.cascadeBy(function(a){(viewNode=Ext.fly(d.getView().getNode(a)))&&viewNode.show()})}});Ext.define("OpenEMap.view.layer.Add",{extend:OpenEMap.view.layer.Tree,title:"L\u00e4gg till lager",width:250,height:550,headerPosition:"top",collapsible:!0,collapseMode:"header",collapseDirection:"right",titleCollapse:!0,viewConfig:{plugins:{ptype:"treeviewdragdrop",enableDrop:!1},copy:!0},plugins:{ptype:"treefilter",allowParentFolders:!0},dockedItems:[{xtype:"toolbar",dock:"top",layout:"fit",items:[{xtype:"trigger",triggerCls:"x-form-clear-trigger",onTriggerClick:function(){this.reset();
this.focus()},listeners:{change:function(d,c){d.up("treepanel").filter(c)},buffer:250}}]}],initComponent:function(){var b=this;this.on("checkchange",function(a,d){a.cascadeBy(function(c){d?b.loadLayer(c):b.unLoadLayer(c)})});this.columns=[{xtype:"treecolumn",flex:1,dataIndex:"text"},b.metadataColumn];this.store=Ext.create("OpenEMap.data.GroupedLayerTree");this.serverStore=Ext.create("OpenEMap.data.Servers",{proxy:{url:OpenEMap.wsUrls.basePath+OpenEMap.wsUrls.servers,type:"ajax",reader:{type:"json",root:"configs"}}});
this.serverStore.load({callback:function(){b.dataHandler.getLayers(function(a){a&&(a=(new OpenEMap.config.Parser({serverStore:b.serverStore})).parseLayerTree(a),b.store.setRootNode({text:"Lager",expanded:!0,layers:a}))})}});this.callParent(arguments)},loadLayer:function(b){if((b=b.get("layer"))&&""!==b&&this.mapPanel){b.setVisibility(!0),b.displayInLayerSwitcher=!1,this.mapPanel.layers.add(b)}},unLoadLayer:function(b){(b=b.get("layer"))&&(""!==b&&this.mapPanel)&&this.mapPanel.layers.remove(b)}});
Ext.define("OpenEMap.view.layer.Advanced",{extend:Ext.container.Container,layout:{type:"hbox",pack:"end",align:"stretch"},width:500,height:650,initComponent:function(){var b=this;this.dataHandler=Ext.create("OpenEMap.data.DataHandler");this.metadataWindow=Ext.create("OpenEMap.view.MetadataWindow",{dataHandler:this.dataHandler});this.savedMapConfigs=Ext.create("OpenEMap.view.SavedMapConfigs",{dataHandler:this.dataHandler});this.showOnMapLayerView=Ext.create("OpenEMap.view.layer.Tree",{title:"Visas p\u00e5 kartan",width:250,height:500,region:"north",mapPanel:this.mapPanel,rootVisible:!0,viewConfig:{plugins:{ptype:"treeviewdragdrop",allowContainerDrops:!0,allowParentInserts:!0}},columns:[{xtype:"gx_treecolumn",flex:1,dataIndex:"text"},Ext.create("OpenEMap.action.MetadataInfoColumn",{metadataWindow:this.metadataWindow,dataHandler:this.dataHandler}),{xtype:"actioncolumn",width:40,iconCls:"action-remove",tooltip:"Ta bort",handler:function(f,i){for(var h=f.getStore().getAt(i),g=0;
g<h.childNodes.length;g++){h.removeChild(h.childNodes[g])}h.remove()},dataHandler:this.dataHandler}],buttons:[{text:"Spara kartinneh\u00e5ll",handler:function(){if(b.orginalConfig){var a=Ext.clone(b.orginalConfig);Ext.MessageBox.prompt("Namn","Ange ett namn:",function(j,i){if("ok"==j&&0<i.length){var h=b.showOnMapLayerView.getStore().getLayerConfiguration();if(a.layers){var f=a.layers.filter(function(c){return c.wms&&c.wms.options.isBaseLayer||c.wfs?c:!1});a.layers=f.concat(h)}i!==a.name?(a.name=i,b.dataHandler.saveNewConfiguration(a,function(){b.savedMapConfigs.getStore().load()
})):a.configId&&b.dataHandler.updateConfiguration(a.configId,a)}},this,!1,a.name)}}}]});this.items=[Ext.create("OpenEMap.view.layer.Add",{mapPanel:this.mapPanel,dataHandler:this.dataHandler,metadataColumn:Ext.create("OpenEMap.action.MetadataInfoColumn",{metadataWindow:this.metadataWindow,dataHandler:this.dataHandler})}),{xtype:"panel",layout:"border",width:"50%",border:!1,items:[b.showOnMapLayerView,{title:"Sparade kartor",region:"center",xtype:"panel",border:!1,layout:"fit",collapsible:!0,titleCollapse:!0,items:b.savedMapConfigs}]}];
this.callParent(arguments)}});Ext.define("OpenEMap.view.layer.Basic",{extend:OpenEMap.view.layer.Tree,overflowY:"auto",rootVisible:!1,height:300,border:!1,initComponent:function(){this.renderTo||(this.title="Lager",this.bodyPadding=5,this.collapsible=!0);this.callParent(arguments)}});